<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Lumina|相遇集 </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- PDF导出库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap');
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 182, 193, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* PDF导出专用样式 */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .pdf-container {
                background: white !important;
                color: black !important;
            }
            
            .pdf-container * {
                color: inherit !important;
            }
            
            .pdf-container img {
                object-fit: cover !important;
                object-position: center !important;
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* 强制分页控制 */
            .page-break-before {
                page-break-before: always !important;
                break-before: page !important;
            }
            
            .page-break-after {
                page-break-after: always !important;
                break-after: page !important;
            }
            
            .page-break-inside-avoid {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }
        header { 
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.85) 0%, rgba(40, 30, 60, 0.9) 100%); 
            backdrop-filter: blur(20px);
            padding: 35px 0; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); 
            position: sticky; 
            top: 0; 
            z-index: 100;
            border-bottom: 1px solid rgba(138, 117, 255, 0.2);
            overflow: hidden;
            position: relative;
        }
        
        /* 星空背景 */
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent),
                radial-gradient(1px 1px at 15% 60%, white, transparent);
            background-size: 200% 200%, 200% 200%, 200% 200%, 200% 200%, 200% 200%, 200% 200%, 200% 200%;
            background-position: 0% 0%, 40% 60%, 80% 20%, 20% 80%, 60% 40%, 10% 90%, 70% 10%;
            animation: twinkle 4s ease-in-out infinite;
            opacity: 0.6;
        }

        /* Sort toggle button styles */
        .sort-order-toggle {
            display: inline-block;
            margin-left: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: background 120ms ease, transform 80ms ease;
            font-size: 0.9rem;
        }
        .sort-order-toggle:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
        .sort-order-toggle:active { transform: translateY(0); }
        .sort-order-toggle:focus { outline: 2px solid rgba(255,255,255,0.18); outline-offset: 2px; }

        
        /* 行星装饰 */
        header::after {
            content: '';
            position: absolute;
            top: 10%;
            right: 8%;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #a78bfa, #7c3aed);
            border-radius: 50%;
            opacity: 0.25;
            box-shadow: 
                0 0 40px rgba(167, 139, 250, 0.4),
                inset -10px -10px 20px rgba(0, 0, 0, 0.3);
            animation: planetFloat 8s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        @keyframes planetFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
        
        /* 流星效果 */
        .header-content::before {
            content: '';
            position: absolute;
            top: 20%;
            left: -100%;
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            animation: shootingStar 6s ease-in-out infinite;
        }
        
        @keyframes shootingStar {
            0% { left: -100%; top: 20%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 120%; top: 80%; opacity: 0; }
        }
        
        .header-content { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            z-index: 1;
        }
        
        header h1 { 
            font-family: 'Ma Shan Zheng', 'ZCOOL XiaoWei', 'KaiTi', '楷体', serif;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 20%, #ff69b4 40%, #da70d6 60%, #9370db 80%, #4169e1 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem; 
            margin-bottom: 8px; 
            font-weight: 700;
            letter-spacing: 4px;
            position: relative;
            animation: titleGlow 3s ease-in-out infinite, gradientShift 8s ease infinite;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 40px rgba(218, 112, 214, 0.4),
                0 0 60px rgba(65, 105, 225, 0.3);
            filter: brightness(1.2);
        }
        
        header h1::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            z-index: -1;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 20%, #ff69b4 40%, #da70d6 60%, #9370db 80%, #4169e1 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: blur(10px);
            opacity: 0.7;
            animation: gradientShift 8s ease infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% { 
                filter: brightness(1.2) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)) drop-shadow(0 0 30px rgba(218, 112, 214, 0.4));
            }
            50% { 
                filter: brightness(1.4) drop-shadow(0 0 25px rgba(255, 215, 0, 0.7)) drop-shadow(0 0 50px rgba(218, 112, 214, 0.6));
            }
        }
        
        header h1::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 130%;
            height: 150%;
            background: radial-gradient(ellipse, rgba(255, 215, 0, 0.2) 0%, rgba(218, 112, 214, 0.15) 40%, transparent 70%);
            z-index: -2;
            animation: halo 4s ease-in-out infinite;
        }
        
        @keyframes halo {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.15); }
        }
        
        header p { 
            font-family: 'ZCOOL XiaoWei', 'KaiTi', '楷体', serif;
            color: #c4b5fd; 
            font-size: 1.05rem; 
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(196, 181, 253, 0.5);
        }
        
        #quote-text {
            font-family: 'ZCOOL XiaoWei', 'KaiTi', '楷体', serif;
            font-size: 1.05rem;
            background: linear-gradient(135deg, #fcd34d 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 500;
            min-height: 32px;
            transition: opacity 0.5s;
            letter-spacing: 0.5px;
            filter: drop-shadow(0 0 8px rgba(252, 211, 77, 0.3));
        }
        .back-btn { 
            padding: 10px 20px; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3); 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 600;
            transition: all 0.3s; 
            display: none; 
        }
        .back-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .back-btn.show { display: block; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; position: relative; z-index: 1; }
        .controls { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px);
            border-radius: 20px; 
            padding: 25px; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease;
        }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar input { flex: 1; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 1rem; }
        .search-bar button { padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; cursor: pointer; }
        .filter-section { margin-bottom: 15px; }
        .filter-section h3 { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .tag-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-btn { padding: 8px 18px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .tag-btn:hover { background: #e8e8e8; }
        .tag-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
        #sort-select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.9rem; cursor: pointer; }
        .people-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; }
        
        .person-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 15px; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            cursor: pointer; 
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.4);
            animation: fadeInUp 0.6s ease backwards;
        }
        .person-card:hover { 
            transform: translateY(-12px) scale(1.02); 
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .color-label {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }
        .color-label:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .delete-card-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: #f44336; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.3s; z-index: 10; font-size: 0.85rem; }
        .person-card:hover .delete-card-btn { opacity: 1; }
        .delete-card-btn:hover { background: #d32f2f; transform: scale(1.1); }
        .star-btn {
            position: absolute;
            top: 10px;
            right: 42px;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.9);
            color: #FFD700;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .person-card:hover .star-btn,
        .star-btn.starred {
            opacity: 1;
        }
        .star-btn.starred {
            background: rgba(255, 215, 0, 0.2);
        }
        .star-btn:hover {
            background: #FFC107;
            color: white;
            transform: scale(1.1);
        }



.avatar-container { position: relative; width: 70px; height: 70px; margin: 0 auto 12px; border-radius: 50%; overflow: hidden; }
        .person-avatar, .avatar-placeholder { width: 100%; height: 100%; border-radius: 50%; }
        .person-avatar { object-fit: cover; }
        .avatar-placeholder { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; font-weight: bold; }
        .person-name { font-size: 1.1rem; font-weight: bold; text-align: center; margin-bottom: 6px; color: #333; }
        .person-profession { text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 8px; }
        .person-info { text-align: center; font-size: 0.75rem; color: #888; margin-bottom: 6px; line-height: 1.4; }
        .person-intimacy { text-align: center; margin-bottom: 8px; font-size: 1rem; color: #ff6b6b; }
        .person-tags { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; min-height: 24px; }
        .tag { background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; }
        .add-person-btn { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 60px; 
            height: 60px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            font-size: 1.8rem; 
            cursor: pointer; 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); 
            z-index: 99; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: float 3s ease-in-out infinite;
        }
        .add-person-btn:hover { 
            transform: scale(1.15) rotate(90deg); 
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.8);
        }
        .detail-page { display: none; }
        .detail-page.active { display: block; }
        .detail-container { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); }
        .detail-header { display: flex; gap: 40px; padding-bottom: 30px; border-bottom: 3px solid #f0f0f0; margin-bottom: 40px; }
        .detail-avatar { flex-shrink: 0; }
        .detail-avatar-img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid #667eea; }
        .detail-info { flex: 1; }
        .detail-name { font-size: 2.5rem; font-weight: bold; color: #333; margin-bottom: 15px; }
        .detail-profession { font-size: 1.2rem; color: #666; margin-bottom: 20px; }
        .detail-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .detail-tag { background: #e3f2fd; color: #1976d2; padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; }
        .detail-actions { display: flex; gap: 15px; }
        .action-btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-edit { background: #667eea; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 40px; }
        .info-item { background: #f9f9f9; padding: 20px; border-radius: 12px; }
        .info-label { font-size: 0.85rem; color: #999; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .info-value { font-size: 1.1rem; color: #333; font-weight: 500; }
        .section { margin-top: 40px; padding-top: 40px; border-top: 2px solid #f0f0f0; }
        .section-title { font-size: 1.8rem; color: #333; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
        .section-content { background: #f9f9f9; padding: 25px; border-radius: 12px; min-height: 100px; }
        
        /* 搜索和排序控件样式 */
        .search-sort-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            z-index: 1;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .sort-controls {
            display: flex;
            align-items: center;
        }
        
        .sort-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .sort-toggle-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .sort-toggle-btn:active {
            transform: translateY(1px);
        }
        
        .sort-toggle-btn i {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .sort-toggle-btn.ascending i {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .search-sort-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
        }
        
        /* 拖拽上传区域样式 */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafafa;
            cursor: pointer;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
            transform: scale(1.02);
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .upload-content i {
            font-size: 2rem;
            color: #667eea;
        }
        
        .upload-content p {
            color: #666;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .uploaded-files {
            margin-top: 15px;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .file-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            background: white;
            transition: all 0.3s;
        }
        
        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .file-item .file-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-item .file-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            color: #667eea;
            font-size: 2rem;
        }
        
        .file-item .file-placeholder .file-name {
            font-size: 0.75rem;
            margin-top: 8px;
            padding: 0 8px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .file-item .remove-file {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(255, 71, 87, 0.9);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            opacity: 0;
            z-index: 10;
        }
        
        .file-item:hover .remove-file {
            opacity: 1;
        }
        
        .file-item .remove-file:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
        
        .file-item.existing-media {
            border: 2px solid #28a745;
        }
        
        .file-item.existing-media::after {
            content: '已保存';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            text-align: center;
        }
        
        .file-item.uploaded-media {
            border: 2px solid #007bff;
        }
        
        .file-item.uploaded-media::after {
            content: '已上传';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            text-align: center;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
        }
        .story-item, .moment-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #667eea; position: relative; }
        .story-item:hover .delete-story-btn,
        .moment-item:hover .delete-story-btn { opacity: 1; }
        .delete-story-btn { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            width: 28px; 
            height: 28px; 
            background: #f44336; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.8rem; 
            opacity: 0.4;
            transition: all 0.3s;
            z-index: 10;
        }
        .delete-story-btn:hover { 
            opacity: 1; 
            background: #d32f2f; 
            transform: scale(1.1); 
        }
        .story-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .story-title { font-size: 1.3rem; font-weight: bold; color: #333; }
        .story-date { color: #999; font-size: 0.9rem; }
        .story-content { color: #555; line-height: 1.8; margin-bottom: 15px; }
        .story-media { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .media-item img, .media-item video { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; }
        .add-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; margin-top: 20px; transition: all 0.3s; }
        .add-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .no-data { text-align: center; padding: 40px; color: #999; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(20px);
            border-radius: 24px; 
            padding: 40px; 
            max-width: 700px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .modal-header h2 { font-size: 1.8rem; color: #333; }
        .close-modal { font-size: 2rem; cursor: pointer; color: #999; background: none; border: none; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; transition: all 0.3s; font-family: inherit; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .heart-rating { display: flex; gap: 8px; justify-content: center; align-items: center; margin-top: 10px; }
        .heart-rating .heart-wrapper { position: relative; font-size: 2rem; cursor: pointer; transition: all 0.3s; display: inline-block; }
        .heart-rating .heart-wrapper:hover { transform: scale(1.15); }
        .heart-rating .heart-empty { color: #ddd; }
        .heart-rating .heart-full { color: #ff6b6b; }
        .color-picker-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #e0e0e0;
            transition: all 0.3s;
            position: relative;
        }
        .color-option:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .color-option.selected {
            border-color: #333;
            border-width: 4px;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }
        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .color-option.none {
            background: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc),
                        linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            background-color: white;
        }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .avatar-upload-section { text-align: center; margin-bottom: 30px; padding: 30px; background: #f9f9f9; border-radius: 15px; }
        .avatar-preview-container { width: 150px; height: 150px; margin: 0 auto 20px; }
        .avatar-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; }
        .avatar-preview-placeholder { width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 4rem; color: white; font-weight: bold; }
        .upload-btn { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; }

        /* 图片裁剪样式 */
        .crop-container {
            max-width: 100%;
            max-height: 400px;
            margin: 20px 0;
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
        }
        .crop-container img {
            max-width: 100%;
            display: block;
        }
        .crop-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .crop-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .crop-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .crop-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        .crop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .detail-header { flex-direction: column; text-align: center; }
            .info-grid { grid-template-columns: 1fr; }
            .people-grid { grid-template-columns: 1fr; }
        }
        /* 使用指南模态框样式 */
        .guide-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 3000;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }
        .guide-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .guide-content {
            background: linear-gradient(135deg, #fff9f5 0%, #fffbf7 100%);
            border-radius: 28px;
            padding: 50px;
            max-width: 880px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 215, 179, 0.3);
            position: relative;
            animation: modalSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .guide-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        .guide-title {
            font-family: 'Ma Shan Zheng', 'ZCOOL XiaoWei', serif;
            font-size: 2.8rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 25%, #ff69b4 50%, #da70d6 75%, #9370db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 3px;
            filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.3));
        }
        .guide-subtitle {
            font-family: 'ZCOOL XiaoWei', serif;
            color: #999;
            font-size: 1.1rem;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .guide-divider {
            width: 120px;
            height: 4px;
            background: linear-gradient(90deg, #ffd4b3, #ffc7e3, #b3e5ff);
            margin: 20px auto;
            border-radius: 3px;
        }
        .guide-section {
            margin-bottom: 35px;
        }
        .guide-section h2 {
            font-size: 1.6rem;
            color: #333;
            border-left: 5px solid #ffbfae;
            padding-left: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guide-section p {
            color: #555;
            line-height: 1.9;
            text-indent: 0;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }
        .guide-section ul, .guide-section ol {
            padding-left: 25px;
            color: #555;
            line-height: 2;
        }
        .guide-section li {
            margin-bottom: 10px;
            font-size: 1.05rem;
        }
        .guide-section code {
            background: rgba(102, 126, 234, 0.1);
            padding: 3px 8px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-size: 0.95rem;
        }
        .guide-note {
            background: linear-gradient(135deg, #fff6e9 0%, #fff9ed 100%);
            padding: 20px 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.05rem;
            color: #8B6914;
            border-left: 5px solid #FFB347;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.15);
        }
        .guide-footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 191, 174, 0.3);
            color: #999;
            font-size: 1rem;
        }
        .close-guide {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.2rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .close-guide:hover {
            background: rgba(255, 191, 174, 0.2);
            color: #333;
            transform: rotate(90deg);
        }
        .guide-btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .guide-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .help-icon {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.6rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(245, 124, 0, 0.5);
            z-index: 98;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .help-icon:hover {
            transform: scale(1.12) rotate(15deg);
            box-shadow: 0 8px 30px rgba(245, 124, 0, 0.65);
        }

        /* 语言选择页面样式 */
        .language-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .language-selection.active {
            display: flex;
        }

        .language-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 60px 80px;
            text-align: center;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalSlideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 600px;
            width: 100%;
        }
        .language-card h1 {
            font-family: 'Ma Shan Zheng', 'ZCOOL XiaoWei', serif;
            font-size: 2.8rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 25%, #ff69b4 50%, #da70d6 75%, #9370db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: 3px;
        }
        .language-card p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        .language-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .language-btn {
            padding: 18px 50px;
            font-size: 1.3rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        .language-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .language-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .language-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }
        .language-btn-zh {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }
        .language-btn-en {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .language-btn span {
            position: relative;
            z-index: 1;
        }

        /* 语言切换按钮 */
        .language-switcher {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: 600;
        }
        .language-switcher:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }


        /* ============================================
           移动端响应式优化 - Mobile Responsive Design
           ============================================ */
        
        /* 平板设备 (iPad 等) */
        @media (max-width: 1024px) {
            .container {
                padding: 20px 15px;
            }
            
            .header-content {
                padding: 0 15px;
            }
            
            header h1 {
                font-size: 2rem;
                letter-spacing: 2px;
            }
            
            .people-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 12px;
            }
            
            .detail-container {
                padding: 30px 20px;
            }
            
            .detail-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .detail-avatar {
                margin: 0 auto;
            }
            
            .detail-name {
                font-size: 2rem;
            }
        }
        
        /* 手机设备 - 竖屏 */
        @media (max-width: 768px) {
            /* 基础布局调整 */
            body {
                font-size: 14px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            /* 顶部导航栏 */
            header {
                padding: 20px 0;
                position: sticky;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 0 15px;
                text-align: center;
            }
            
            .header-left {
                width: 100%;
            }
            
            header h1 {
                font-size: 1.6rem;
                letter-spacing: 2px;
                margin-bottom: 8px;
            }
            
            header p {
                font-size: 0.9rem;
            }
            
            #quote-text {
                font-size: 0.9rem;
            }
            
            /* 语言切换按钮 */
            .language-switcher {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            /* 控制区域 */
            .controls {
                padding: 15px;
                border-radius: 15px;
                margin-bottom: 20px;
            }
            
            .search-bar {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-bar input {
                width: 100%;
                padding: 10px 15px;
                font-size: 0.95rem;
            }
            
            .search-bar button {
                width: 100%;
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            
            .filter-section h3 {
                font-size: 0.85rem;
            }
            
            .tag-buttons {
                gap: 8px;
            }
            
            .tag-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            #sort-select {
                width: 100%;
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .sort-order-toggle {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            /* 人物卡片网格 */
            .people-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .person-card {
                padding: 12px;
                border-radius: 12px;
            }
            
            .avatar-container {
                width: 60px;
                height: 60px;
                margin-bottom: 10px;
            }
            
            .person-name {
                font-size: 1rem;
            }
            
            .person-profession {
                font-size: 0.75rem;
            }
            
            .person-info {
                font-size: 0.7rem;
            }
            
            .person-intimacy {
                font-size: 0.9rem;
            }
            
            .tag {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            /* 悬停按钮在移动端默认显示 */
            .person-card .delete-card-btn,
            .person-card .star-btn,
            .person-card .color-label {
                opacity: 1;
            }
            
            .delete-card-btn {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
            
            .star-btn {
                width: 24px;
                height: 24px;
                right: 36px;
            }
            
            .color-label {
                width: 24px;
                height: 24px;
                border-width: 2px;
            }
            
            /* 添加按钮 */
            .add-person-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
                font-size: 1.5rem;
            }
            
            /* 帮助按钮 */
            .help-icon {
                width: 45px;
                height: 45px;
                bottom: 80px;
                right: 20px;
                font-size: 1.3rem;
            }
            
            /* 详情页面 */
            .detail-container {
                padding: 20px 15px;
                border-radius: 15px;
            }
            
            .detail-header {
                flex-direction: column;
                gap: 20px;
                padding-bottom: 20px;
                margin-bottom: 25px;
            }
            
            .detail-avatar {
                margin: 0 auto;
            }
            
            .detail-avatar-img {
                width: 120px;
                height: 120px;
                border-width: 4px;
            }
            
            .detail-info {
                text-align: center;
            }
            
            .detail-name {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }
            
            .detail-profession {
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            .detail-tag {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .detail-actions {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .action-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                flex: 1 1 auto;
                min-width: 120px;
            }
            
            /* 弹窗 */
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 25px 20px;
                border-radius: 15px;
                max-height: 85vh;
            }
            
            .modal-content h2 {
                font-size: 1.4rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions button {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
            
            /* 使用指南 */
            .guide-content {
                padding: 30px 20px;
                border-radius: 20px;
                max-height: 85vh;
            }
            
            .guide-title {
                font-size: 2rem;
                letter-spacing: 2px;
            }
            
            .guide-subtitle {
                font-size: 1rem;
            }
            
            .guide-section h2 {
                font-size: 1.3rem;
                padding-left: 12px;
            }
            
            .guide-section p,
            .guide-section li {
                font-size: 0.95rem;
                line-height: 1.7;
            }
            
            .guide-note {
                padding: 15px 18px;
                font-size: 0.95rem;
            }
            
            .close-guide {
                top: 15px;
                right: 15px;
                width: 38px;
                height: 38px;
                font-size: 1.8rem;
            }
            
            /* 语言选择页面 */
            .language-card {
                padding: 40px 25px;
                border-radius: 25px;
            }
            
            .language-card h1 {
                font-size: 2rem;
            }
            
            .language-card p {
                font-size: 1rem;
            }
            
            .language-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .language-btn {
                width: 100%;
                padding: 15px 30px;
                font-size: 1.1rem;
            }
            
            /* 返回按钮 */
            .back-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            /* 优化触摸体验 */
            button,
            .tag-btn,
            .person-card,
            input,
            select {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                touch-action: manipulation;
            }
            
            /* 图片裁剪器 */
            .cropper-container {
                max-width: 100% !important;
            }
        }
        
        /* 小屏手机 (iPhone SE 等) */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.3rem;
                letter-spacing: 1px;
            }
            
            header p {
                font-size: 0.8rem;
            }
            
            #quote-text {
                font-size: 0.8rem;
            }
            
            .people-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 8px;
            }
            
            .person-card {
                padding: 10px;
            }
            
            .avatar-container {
                width: 50px;
                height: 50px;
            }
            
            .person-name {
                font-size: 0.9rem;
            }
            
            .controls {
                padding: 12px;
            }
            
            .tag-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            .add-person-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
                bottom: 15px;
                right: 15px;
            }
            
            .help-icon {
                width: 40px;
                height: 40px;
                bottom: 70px;
                right: 15px;
                font-size: 1.2rem;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .guide-title {
                font-size: 1.6rem;
            }
            
            .guide-section h2 {
                font-size: 1.2rem;
            }
            
            .language-card h1 {
                font-size: 1.6rem;
            }
        }
        
        /* 横屏模式优化 */
        @media (max-height: 600px) and (orientation: landscape) {
            header {
                padding: 15px 0;
            }
            
            header h1 {
                font-size: 1.3rem;
            }
            
            .add-person-btn,
            .help-icon {
                transform: scale(0.85);
            }
            
            .modal-content,
            .guide-content {
                max-height: 90vh;
                padding: 20px;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            /* 移除悬停效果，使用点击代替 */
            .person-card .delete-card-btn,
            .person-card .star-btn {
                opacity: 0.8;
            }
            
            /* 增加可点击区域 */
            .tag-btn,
            .action-btn,
            button {
                min-height: 44px; /* Apple推荐的最小触摸目标 */
            }
        }
        
        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            /* 优化细节渲染 */
            .person-card,
            .controls,
            .modal-content {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        /* 通用隐藏工具类 */
        .hidden { display: none !important; }
    </style>

</head>
<body>
    <!-- 语言选择页面 -->
    <div class="language-selection" id="language-selection">
        <div class="language-card">
            <h1>🌟 Lumina相遇集</h1>
            <p>
                汇聚每一份相遇的光<br>
                Gathering the Light of Every Encounter
            </p>
            <div class="language-buttons">
                <button class="language-btn language-btn-zh" onclick="selectLanguage('zh')">
                    <span>🇨🇳 中文</span>
                </button>
                <button class="language-btn language-btn-en" onclick="selectLanguage('en')">
                    <span>🇺🇸 English</span>
                </button>
            </div>
        </div>
    </div>

    <header>

        <div class="header-content">
            <div class="header-left">
                <h1><i class="fas fa-users"></i> <span class="lang-text" data-zh="汇聚每一份相遇的光" data-en="Gathering the Light of Every Encounter">汇聚每一份相遇的光</span></h1>
                <p class="lang-text" data-zh="路过我们生命中的每个人都参与了我们并最终构成了我们本身。" data-en="Everyone who passes through our lives participates in us and ultimately becomes part of who we are." style="font-size:1.1rem;color:#555;">路过我们生命中的每个人都参与了我们并最终构成了我们本身。</p>
                <div id="quote-carousel" style="margin-top:18px;max-width:700px;overflow:hidden;">
                    <div id="quote-text" style="font-size:1.05rem;color:#764ba2;font-weight:500;min-height:32px;transition:opacity 0.5s;"></div>
                </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <button class="language-switcher" onclick="toggleLanguage()" title="Switch Language / 切换语言">
                    <i class="fas fa-globe"></i>
                    <span id="current-lang-display">中文</span>
                </button>
                <button class="back-btn" id="back-btn" onclick="showMainPage()"><i class="fas fa-arrow-left"></i> <span class="lang-text" data-zh="返回主页" data-en="Back">返回主页</span></button>
                <button class="back-btn show" onclick="exportData()" style="background:linear-gradient(135deg, #a8e6cf 0%, #56c596 100%);color:#2d5f4d;border:none;box-shadow:0 4px 15px rgba(86, 197, 150, 0.4);" title="Export Data / 导出数据"><i class="fas fa-download"></i> <span class="lang-text" data-zh="导出备份" data-en="Export">导出备份</span></button>
                <button class="back-btn show" onclick="document.getElementById('import-file').click()" style="background:linear-gradient(135deg, #b8d4f1 0%, #6fa3ef 100%);color:#2c4a6f;border:none;box-shadow:0 4px 15px rgba(111, 163, 239, 0.4);" title="Import Data / 导入数据"><i class="fas fa-upload"></i> <span class="lang-text" data-zh="导入备份" data-en="Import">导入备份</span></button>
                <button class="back-btn show" onclick="openBackupSettings()" style="background:linear-gradient(135deg, #ffd9a0 0%, #ffb84d 100%);color:#8b5a00;border:none;box-shadow:0 4px 15px rgba(255, 184, 77, 0.4);" title="Backup Settings / 备份设置"><i class="fas fa-cog"></i> <span class="lang-text" data-zh="备份设置" data-en="Settings">备份设置</span></button>
                <button class="back-btn show" onclick="showStorageInfo()" style="background:linear-gradient(135deg, #e1bee7 0%, #ba68c8 100%);color:#4a148c;border:none;box-shadow:0 4px 15px rgba(186, 104, 200, 0.4);" title="Storage Info / 存储信息"><i class="fas fa-database"></i> <span class="lang-text" data-zh="存储信息" data-en="Storage">存储信息</span></button>
                <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
            </div>
        </div>

    </header>

    <!-- 使用指南按钮 -->
    <button class="help-icon" onclick="openGuide()" title="使用指南">
        <i class="fas fa-question"></i>
    </button>

    <!-- 使用指南模态框 -->
    <div class="guide-modal" id="guide-modal">
        <div class="guide-content">
            <button class="close-guide" onclick="closeGuide()">&times;</button>
            <div class="guide-header">
                <h1 class="guide-title">🌟 Lumina <span class="lang-text" data-zh="相遇集" data-en="Encounters">相遇集</span></h1>
                <p class="guide-subtitle lang-text" data-zh="—— 拉丁语 'Lumina'，意为'光'，象征温暖的连接" data-en="—— Latin 'Lumina' means 'light', symbolizing warm connections">—— 拉丁语 "Lumina"，意为"光"，象征温暖的连接</p>
                <div class="guide-divider"></div>
            </div>
            <p style="text-align:center;color:#666;font-size:1.1rem;line-height:1.9;margin-bottom:30px;" class="lang-text" data-zh="<b>Lumina相遇集</b> 是一款帮助你记录、整理与回顾人际联系的网页工具。<br>它像一本'关系日记'，让你温柔地收藏生活中每一次相遇与光亮。<br>所有数据均安全保存在你的浏览器中（IndexedDB + localStorage），不上传云端。" data-en="<b>Lumina Encounters</b> is a web tool to help you record, organize, and review your personal connections.<br>Like a 'relationship journal', it lets you gently collect every encounter and light in your life.<br>All data is safely stored in your browser (IndexedDB + localStorage), not uploaded to the cloud.">
                <b>Lumina相遇集</b> 是一款帮助你记录、整理与回顾人际联系的网页工具。<br>
                它像一本"关系日记"，让你温柔地收藏生活中每一次相遇与光亮。<br>
                所有数据均安全保存在你的浏览器中（IndexedDB + localStorage），不上传云端。
            </p>
            <div class="guide-note">
                💡 <span class="lang-text" data-zh="这是一片只属于你的私密空间，用来收集那些让你感到温暖、被理解、被连接的故事。" data-en="This is your private space to collect stories that make you feel warm, understood, and connected.">这是一片只属于你的私密空间，用来收集那些让你感到温暖、被理解、被连接的故事。</span>
            </div>
            <div class="guide-section">
                <h2 class="lang-text" data-zh="🚀 一分钟快速上手" data-en="🚀 Quick Start Guide">🚀 一分钟快速上手</h2>
                <ol id="quick-start-list">
                    <li class="lang-text" data-zh="打开网页 → 点击右下角 <b>「＋」</b> 添加新人物" data-en="Open the page → Click <b>'+'</b> in the bottom right to add a new person">打开网页 → 点击右下角 <b>「＋」</b> 添加新人物</li>
                    <li class="lang-text" data-zh="填写姓名、职业、地区、标签、亲密度等" data-en="Fill in name, profession, location, tags, intimacy level, etc.">填写姓名、职业、地区、标签、亲密度等</li>
                    <li class="lang-text" data-zh="保存后会出现人物卡片，点击进入详情页" data-en="After saving, a person card appears - click to view details">保存后会出现人物卡片，点击进入详情页</li>
                    <li class="lang-text" data-zh="可在详情页添加 <b>故事 / 朋友圈 / 聊天记录</b>" data-en="In details page, add <b>Stories / Moments / Chat History</b>">可在详情页添加 <b>故事 / 朋友圈 / 聊天记录</b></li>
                    <li class="lang-text" data-zh="顶部可导出备份 <code>.json</code> 文件，保存数据！" data-en="Export backup <code>.json</code> file from the top menu to save data!">顶部可导出备份 <code>.json</code> 文件，保存数据！</li>
                </ol>
            </div>
            <div class="guide-section">
                <h2 class="lang-text" data-zh="🧭 功能说明" data-en="🧭 Features">🧭 功能说明</h2>
                <ul id="features-list">
                    <li class="lang-text" data-zh="<b>搜索框：</b> 实时搜索姓名或关键词" data-en="<b>Search:</b> Real-time search by name or keywords"><b>搜索框：</b> 实时搜索姓名或关键词</li>
                    <li class="lang-text" data-zh="<b>筛选区：</b> 标签 / 职业 / 地区 / 颜色 / 星标 / MBTI" data-en="<b>Filters:</b> Tags / Profession / Location / Color / Starred / MBTI"><b>筛选区：</b> 标签 / 职业 / 地区 / 颜色 / 星标 / MBTI</li>
                    <li class="lang-text" data-zh="<b>排序：</b> 按姓名、相识时间、亲密度、最近添加" data-en="<b>Sorting:</b> By name, meeting time, intimacy, or recently added"><b>排序：</b> 按姓名、相识时间、亲密度、最近添加</li>
                    <li class="lang-text" data-zh="<b>人物卡片：</b> 显示简介，可点星标或编辑" data-en="<b>Person Cards:</b> Show profile, can star or edit"><b>人物卡片：</b> 显示简介，可点星标或编辑</li>
                    <li class="lang-text" data-zh="<b>颜色标签：</b> 用不同颜色区分关系类型或印象" data-en="<b>Color Labels:</b> Use different colors to distinguish relationship types or impressions"><b>颜色标签：</b> 用不同颜色区分关系类型或印象</li>
                    <li class="lang-text" data-zh="<b>头像裁剪：</b> 上传照片后可自由裁剪调整" data-en="<b>Avatar Cropping:</b> Freely crop and adjust uploaded photos"><b>头像裁剪：</b> 上传照片后可自由裁剪调整</li>
                    <li class="lang-text" data-zh="<b>顶部菜单：</b> 导出 / 导入 / 自动备份设置 / 语言切换" data-en="<b>Top Menu:</b> Export / Import / Auto-backup Settings / Language Switch"><b>顶部菜单：</b> 导出 / 导入 / 自动备份设置 / 语言切换</li>
                </ul>
            </div>

            <div class="guide-section">
                <h2 class="lang-text" data-zh="💾 数据备份与安全" data-en="💾 Data Backup & Security">💾 数据备份与安全</h2>
                <p class="lang-text" data-zh="<b>导出备份</b> → 生成 <code>.json</code> 文件保存到本地<br><b>导入备份</b> → 上传 <code>.json</code> 文件恢复数据<br><b>自动备份</b> 可设置间隔（1h-7天）<br><b>存储信息</b> → 查看存储空间使用情况<br>数据仅存在你的浏览器中，不上传、不共享" data-en="<b>Export Backup</b> → Generate <code>.json</code> file to save locally<br><b>Import Backup</b> → Upload <code>.json</code> file to restore data<br><b>Auto Backup</b> can be set at intervals (1h-7 days)<br><b>Storage Info</b> → View storage space usage<br>Data only exists in your browser, not uploaded or shared">
                    <b>导出备份</b> → 生成 <code>.json</code> 文件保存到本地<br>
                    <b>导入备份</b> → 上传 <code>.json</code> 文件恢复数据<br>
                    <b>自动备份</b>可设置间隔（1h-7天）<br>
                    <b>存储信息</b> → 查看存储空间使用情况<br>
                    数据仅存在你的浏览器中，不上传、不共享
                </p>
            </div>
            <div class="guide-section">
                <h2 class="lang-text" data-zh="🎨 个性化小技巧" data-en="🎨 Personalization Tips">🎨 个性化小技巧</h2>
                <ul id="tips-list">
                    <li class="lang-text" data-zh="用 <b>颜色标签</b> 区分关系类型（例如，红=家人，蓝=同学，绿=朋友）或者TA带给你的印象（例如，黄=开朗，绿=舒适，蓝=靠谱，紫=神秘，粉=少女）" data-en="Use <b>color labels</b> to distinguish relationship types (e.g., red=family, blue=classmate, green=friend) or impressions (e.g., yellow=cheerful, green=comfortable, blue=reliable, purple=mysterious, pink=youthful)">用 <b>颜色标签</b> 区分关系类型（例如，红=家人，蓝=同学，绿=朋友）或者TA带给你的印象（例如，黄=开朗，绿=舒适，蓝=靠谱，紫=神秘，粉=少女）</li>
                    <li class="lang-text" data-zh="用 <b>星标</b> 收藏重要人物" data-en="Use <b>stars</b> to bookmark important people">用 <b>星标</b> 收藏重要人物</li>
                    <li class="lang-text" data-zh="在「值得学习的地方」写下你的感悟与成长" data-en="Write your insights and growth in 'What to Learn from Them'">在「值得学习的地方」写下你的感悟与成长</li>
                    <li class="lang-text" data-zh="定期导出 PDF，形成你的人际成长档案" data-en="Export PDFs regularly to create your relationship growth archive">定期导出 PDF，形成你的人际成长档案</li>
                    <li class="lang-text" data-zh="使用 <b>MBTI</b> 标记帮助理解不同的性格类型" data-en="Use <b>MBTI</b> tags to help understand different personality types">使用 <b>MBTI</b> 标记帮助理解不同的性格类型</li>
                </ul>
            </div>
            <div class="guide-section">
                <h2 class="lang-text" data-zh="🔐 常见问题（FAQ）" data-en="🔐 FAQ">🔐 常见问题（FAQ）</h2>
                <ul id="faq-list">
                    <li class="lang-text" data-zh="<b>筛选功能无反应？</b> 刷新网页（Ctrl / ⌘ + R）！" data-en="<b>Filters not working?</b> Refresh the page (Ctrl / ⌘ + R)!"><b>筛选功能无反应？</b> 刷新网页（Ctrl / ⌘ + R）！</li>
                    <li class="lang-text" data-zh="<b>换电脑数据不见？</b> 先导出备份再导入" data-en="<b>Data lost after switching devices?</b> Export backup first, then import"><b>换电脑数据不见？</b> 先导出备份再导入</li>
                    <li class="lang-text" data-zh="<b>导出 PDF 内容超出？</b> 调整窗口或分批导出" data-en="<b>PDF content overflow?</b> Adjust window size or export in batches"><b>导出 PDF 内容超出？</b> 调整窗口或分批导出</li>
                    <li class="lang-text" data-zh="<b>页面卡顿？</b> 图片太大，系统已自动压缩优化" data-en="<b>Page lagging?</b> Images too large, system auto-compresses"><b>页面卡顿？</b> 图片太大，系统已自动压缩优化</li>
                    <li class="lang-text" data-zh="<b>存储空间不够？</b> 使用 IndexedDB 支持更大容量，点击存储信息查看" data-en="<b>Storage full?</b> IndexedDB supports larger capacity, check storage info"><b>存储空间不够？</b> 使用 IndexedDB 支持更大容量，点击存储信息查看</li>
                    <li class="lang-text" data-zh="<b>如何切换语言？</b> 点击顶部的语言按钮即可切换" data-en="<b>How to switch language?</b> Click the language button at the top"><b>如何切换语言？</b> 点击顶部的语言按钮即可切换</li>
                </ul>
            </div>
            <div class="guide-section">
                <h2 class="lang-text" data-zh="💬 开发者寄语" data-en="💬 Developer's Message">💬 开发者寄语</h2>
                <p style="text-align:center;font-style:italic;color:#666;font-size:1.15rem;" class="lang-text" data-zh="每一次相遇都是光的延伸，<br>愿 <b>Lumina相遇集</b> 让你在温柔的记录中，找到被照亮的自己。" data-en="Every encounter is an extension of light,<br>May <b>Lumina Encounters</b> help you find yourself illuminated through gentle records.">
                    每一次相遇都是光的延伸，<br>
                    愿 <b>Lumina相遇集</b> 让你在温柔的记录中，找到被照亮的自己。
                </p>
            </div>
            <div class="guide-footer">
                © 2025 Lumina<span class="lang-text" data-zh="相遇集" data-en=" Encounters">相遇集</span> | <span class="lang-text" data-zh="用温暖与光精心打造" data-en="Crafted with warmth & light">Crafted with warmth & light</span> 🌙
            </div>
            <div style="text-align:center;margin-top:30px;">
                <button class="guide-btn" onclick="closeGuide()"><span class="lang-text" data-zh="开始使用" data-en="Get Started">开始使用</span></button>
            </div>
        </div>
    </div>



    <div class="main-page" id="main-page">
        <div class="container">
            <div class="controls">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="搜索人名..." data-zh-placeholder="搜索人名..." data-en-placeholder="Search by name...">
                    <button id="search-btn"><i class="fas fa-search"></i> <span class="lang-text" data-zh="搜索" data-en="Search">搜索</span></button>
                </div>



                <div class="filter-section">
                    <h3><i class="fas fa-tags"></i> <span class="lang-text" data-zh="按标签筛选" data-en="Filter by Tags">按标签筛选</span></h3>
                    <div class="tag-buttons" id="tag-filters"><button class="tag-btn active"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button></div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-briefcase"></i> <span class="lang-text" data-zh="按专业/职业筛选" data-en="Filter by Profession">按专业/职业筛选</span></h3>
                    <div class="tag-buttons" id="profession-filters"><button class="tag-btn active"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button></div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-map-marker-alt"></i> <span class="lang-text" data-zh="按所在地区筛选" data-en="Filter by Location">按所在地区筛选</span></h3>
                    <div class="tag-buttons" id="location-filters"><button class="tag-btn active"><span class="lang-text" data-zh="全部地区" data-en="All Locations">全部地区</span></button></div>
                </div>


                <div class="filter-section">
                    <h3><i class="fas fa-brain"></i> <span class="lang-text" data-zh="按MBTI筛选" data-en="Filter by MBTI">按MBTI筛选</span></h3>
                    <div class="tag-buttons" id="mbti-filters"><button class="tag-btn active" data-mbti="" onclick="filterByMbti('', this)"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button></div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-palette"></i> <span class="lang-text" data-zh="按颜色标签筛选" data-en="Filter by Color Label">按颜色标签筛选</span></h3>

                    <div class="tag-buttons" id="color-filters">
                        <button class="tag-btn active" onclick="filterByColor('', this)"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button>
                        <button class="tag-btn" onclick="filterByColor('red', this)" style="background:#ffebee;border-color:#ef5350;"><span class="lang-text" data-zh="🔴 红色" data-en="🔴 Red">🔴 红色</span></button>
                        <button class="tag-btn" onclick="filterByColor('orange', this)" style="background:#fff3e0;border-color:#ff9800;"><span class="lang-text" data-zh="🟠 橙色" data-en="🟠 Orange">🟠 橙色</span></button>
                        <button class="tag-btn" onclick="filterByColor('yellow', this)" style="background:#fffde7;border-color:#ffeb3b;"><span class="lang-text" data-zh="🟡 黄色" data-en="🟡 Yellow">🟡 黄色</span></button>
                        <button class="tag-btn" onclick="filterByColor('green', this)" style="background:#e8f5e9;border-color:#4caf50;"><span class="lang-text" data-zh="🟢 绿色" data-en="🟢 Green">🟢 绿色</span></button>
                        <button class="tag-btn" onclick="filterByColor('blue', this)" style="background:#e3f2fd;border-color:#2196f3;"><span class="lang-text" data-zh="🔵 蓝色" data-en="🔵 Blue">🔵 蓝色</span></button>
                        <button class="tag-btn" onclick="filterByColor('purple', this)" style="background:#f3e5f5;border-color:#9c27b0;"><span class="lang-text" data-zh="🟣 紫色" data-en="🟣 Purple">🟣 紫色</span></button>
                        <button class="tag-btn" onclick="filterByColor('pink', this)" style="background:#fce4ec;border-color:#e91e63;"><span class="lang-text" data-zh="🩷 粉色" data-en="🩷 Pink">🩷 粉色</span></button>
                        <button class="tag-btn" onclick="filterByColor('none', this)" style="background:#f5f5f5;border-color:#bdbdbd;"><span class="lang-text" data-zh="⚪ 无标签" data-en="⚪ None">⚪ 无标签</span></button>
                    </div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-heartbeat"></i> <span class="lang-text" data-zh="按亲密度筛选" data-en="Filter by Intimacy">按亲密度筛选</span></h3>
                    <div class="tag-buttons" id="intimacy-filters">
                        <button class="tag-btn active" onclick="filterByIntimacy('', this)"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button>
                        <button class="tag-btn" onclick="filterByIntimacy('5', this)">♥♥♥♥♥ (5)</button>
                        <button class="tag-btn" onclick="filterByIntimacy('4', this)">♥♥♥♥ (4)</button>
                        <button class="tag-btn" onclick="filterByIntimacy('3', this)">♥♥♥ (3)</button>
                        <button class="tag-btn" onclick="filterByIntimacy('2', this)">♥♥ (2)</button>
                        <button class="tag-btn" onclick="filterByIntimacy('1', this)">♥ (1)</button>
                        <button class="tag-btn" onclick="filterByIntimacy('0', this)"><span class="lang-text" data-zh="未设置" data-en="Not Set">未设置</span></button>
                    </div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-star"></i> <span class="lang-text" data-zh="星标筛选" data-en="Filter by Starred">星标筛选</span></h3>
                    <div class="tag-buttons">
                        <button class="tag-btn active" onclick="filterByStarred('all', this)"><span class="lang-text" data-zh="全部" data-en="All">全部</span></button>
                        <button class="tag-btn" onclick="filterByStarred('starred', this)"><i class="fas fa-star" style="color:#FFD700;"></i> <span class="lang-text" data-zh="仅星标" data-en="Starred Only">仅星标</span></button>
                        <button class="tag-btn" onclick="filterByStarred('unstarred', this)"><span class="lang-text" data-zh="非星标" data-en="Unstarred">非星标</span></button>    
                    </div>
                </div>
                <div class="filter-section">
                    <h3><i class="fas fa-sort"></i> <span class="lang-text" data-zh="排序方式" data-en="Sort By">排序方式</span></h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="sort-select" onchange="renderPeople()">
                            <option value="name" data-zh="按姓名" data-en="By Name">按姓名</option>
                            <option value="time" data-zh="按相识时间" data-en="By Meeting Time">按相识时间</option>
                            <option value="intimacy" data-zh="按亲密度" data-en="By Intimacy">按亲密度</option>
                            <option value="recent" data-zh="按最近添加" data-en="By Recently Added">按最近添加</option>
                        </select>

                        <button class="tag-btn" id="sort-order-btn" onclick="toggleSortOrder()"><i class="fas fa-sort-amount-down"></i> <span class="lang-text" data-zh="正序" data-en="Ascending">正序</span></button>
                    </div>
                </div>


            </div>
            <div class="people-grid" id="people-container"></div>
        </div>
        <button class="add-person-btn" onclick="openAddModal()"><i class="fas fa-plus"></i></button>
    </div>



    
    <div class="modal" id="detail-modal">
        <div class="modal-content" style="max-width:900px;width:100%;">
            <div class="modal-header">
                <h2 style="visibility:hidden;">详情</h2>
                <button class="close-modal" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-container" id="detail-container"></div>
        </div>
    </div>




    <div class="modal" id="person-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title" class="lang-text" data-zh="添加新人物" data-en="Add New Person">添加新人物</h2><button class="close-modal" onclick="closePersonModal()">&times;</button></div>
            
            <div class="avatar-upload-section">
                <div class="avatar-preview-container" id="avatar-preview"><div class="avatar-preview-placeholder">?</div></div>
                <div id="crop-container-wrapper" style="display:none;">
                    <div class="crop-container">
                        <img id="crop-image" src="" alt="Image to crop">
                    </div>
                    <div class="crop-buttons">
                        <button class="crop-btn crop-btn-primary" onclick="confirmCrop()"><i class="fas fa-check"></i> <span class="lang-text" data-zh="确认裁剪" data-en="Confirm">确认裁剪</span></button>
                        <button class="crop-btn crop-btn-secondary" onclick="cancelCrop()"><i class="fas fa-times"></i> <span class="lang-text" data-zh="取消" data-en="Cancel">取消</span></button>
                    </div>
                </div>
                <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                <button class="upload-btn" id="upload-avatar-btn" onclick="document.getElementById('avatar-input').click()"><i class="fas fa-camera"></i> <span class="lang-text" data-zh="上传头像" data-en="Upload Avatar">上传头像</span></button>
            </div>


            <form id="person-form">
                <div class="form-group"><label><i class="fas fa-user"></i> <span class="lang-text" data-zh="姓名 *" data-en="Name *">姓名 *</span></label><input type="text" id="person-name" required placeholder="请输入姓名" data-zh-placeholder="请输入姓名" data-en-placeholder="Enter name"></div>
                <div class="form-group"><label><i class="fas fa-briefcase"></i> <span class="lang-text" data-zh="专业/职业（用逗号分隔多个）" data-en="Profession (comma-separated)">专业/职业（用逗号分隔多个）</span></label><input type="text" id="person-profession" placeholder="例如:软件工程师,产品经理" data-zh-placeholder="例如:软件工程师,产品经理" data-en-placeholder="e.g.: Software Engineer, Product Manager"></div>
                <div class="form-group"><label><i class="fas fa-map-marker-alt"></i> <span class="lang-text" data-zh="所在地区" data-en="Location">所在地区</span></label><input type="text" id="person-location" placeholder="例如:北京市海淀区" data-zh-placeholder="例如:北京市海淀区" data-en-placeholder="e.g.: Beijing, Haidian"></div>
                <div class="form-group"><label><i class="fas fa-home"></i> <span class="lang-text" data-zh="老家" data-en="Hometown">老家</span></label><input type="text" id="person-hometown" placeholder="例如:四川省成都市" data-zh-placeholder="例如:四川省成都市" data-en-placeholder="e.g.: Chengdu, Sichuan"></div>
                <div class="form-group"><label><i class="fas fa-birthday-cake"></i> <span class="lang-text" data-zh="生日" data-en="Birthday">生日</span></label><input type="date" id="person-birthday"></div>
                <div class="form-group"><label><i class="fas fa-heart"></i> <span class="lang-text" data-zh="性格特点" data-en="Personality">性格特点</span></label><textarea id="person-personality" placeholder="描述TA的性格..." data-zh-placeholder="描述TA的性格..." data-en-placeholder="Describe their personality..."></textarea></div>
                <div class="form-group">
                    <label><i class="fas fa-brain"></i> MBTI</label>
                    <input type="text" id="person-mbti" placeholder="例如:INTJ" data-zh-placeholder="例如:INTJ" data-en-placeholder="e.g.: INTJ" maxlength="4" style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-heartbeat"></i> <span class="lang-text" data-zh="亲密度（点击选择）" data-en="Intimacy (click to select)">亲密度（点击选择）</span></label>
                
                
                    <div class="heart-rating" id="heart-rating">
                        <span class="heart-wrapper" data-value="1"><i class="fas fa-heart heart-empty"></i></span>
                        <span class="heart-wrapper" data-value="2"><i class="fas fa-heart heart-empty"></i></span>
                        <span class="heart-wrapper" data-value="3"><i class="fas fa-heart heart-empty"></i></span>
                        <span class="heart-wrapper" data-value="4"><i class="fas fa-heart heart-empty"></i></span>
                        <span class="heart-wrapper" data-value="5"><i class="fas fa-heart heart-empty"></i></span>
                    </div>
                    <input type="hidden" id="person-intimacy" value="0">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-palette"></i> <span class="lang-text" data-zh="颜色标签" data-en="Color Label">颜色标签</span></label>
                    <div class="color-picker-group">
                        <div class="color-option none selected" data-color="" title="无标签"></div>
                        <div class="color-option" data-color="red" style="background:#ef5350;" title="红色"></div>
                        <div class="color-option" data-color="orange" style="background:#ff9800;" title="橙色"></div>
                        <div class="color-option" data-color="yellow" style="background:#ffeb3b;" title="黄色"></div>
                        <div class="color-option" data-color="green" style="background:#4caf50;" title="绿色"></div>
                        <div class="color-option" data-color="blue" style="background:#2196f3;" title="蓝色"></div>
                        <div class="color-option" data-color="purple" style="background:#9c27b0;" title="紫色"></div>
                        <div class="color-option" data-color="pink" style="background:#e91e63;" title="粉色"></div>
                    </div>
                    <input type="hidden" id="person-color" value="">
                </div>
                <div class="form-group"><label><i class="fas fa-gamepad"></i> <span class="lang-text" data-zh="兴趣爱好" data-en="Hobbies">兴趣爱好</span></label><textarea id="person-hobbies" placeholder="例如:摄影、篮球、阅读、旅行" data-zh-placeholder="例如:摄影、篮球、阅读、旅行" data-en-placeholder="e.g.: Photography, Basketball, Reading, Travel"></textarea></div>
                <div class="form-group"><label><i class="fas fa-calendar"></i> <span class="lang-text" data-zh="相识时间" data-en="Meeting Time">相识时间</span></label><input type="date" id="person-meettime"></div>
                <div class="form-group"><label><i class="fas fa-map-marker-alt"></i> <span class="lang-text" data-zh="相识地点" data-en="Meeting Place">相识地点</span></label><input type="text" id="person-meetplace" placeholder="例如:清华大学" data-zh-placeholder="例如:清华大学" data-en-placeholder="e.g.: Tsinghua University"></div>
                <div class="form-group"><label><i class="fas fa-question-circle"></i> <span class="lang-text" data-zh="相识缘由" data-en="How We Met">相识缘由</span></label><input type="text" id="person-meetreason" placeholder="例如:同班同学" data-zh-placeholder="例如:同班同学" data-en-placeholder="e.g.: Classmate"></div>
                <div class="form-group"><label><i class="fas fa-tags"></i> <span class="lang-text" data-zh="标签(用逗号分隔)" data-en="Tags (comma-separated)">标签(用逗号分隔)</span></label><input type="text" id="person-tags" placeholder="例如:同学,朋友,同事" data-zh-placeholder="例如:同学,朋友,同事" data-en-placeholder="e.g.: Classmate, Friend, Colleague"></div>
                <div class="form-group"><label><i class="fas fa-phone"></i> <span class="lang-text" data-zh="电话" data-en="Phone">电话</span></label><input type="tel" id="person-phone" placeholder="手机号码" data-zh-placeholder="手机号码" data-en-placeholder="Phone number"></div>
                <div class="form-group"><label><i class="fas fa-envelope"></i> <span class="lang-text" data-zh="邮箱" data-en="Email">邮箱</span></label><input type="email" id="person-email" placeholder="电子邮箱" data-zh-placeholder="电子邮箱" data-en-placeholder="Email address"></div>
                <div class="form-group"><label><i class="fab fa-weixin"></i> <span class="lang-text" data-zh="微信号" data-en="WeChat ID">微信号</span></label><input type="text" id="person-wechat-id" placeholder="微信号" data-zh-placeholder="微信号" data-en-placeholder="WeChat ID"></div>
                <button type="submit" class="submit-btn"><i class="fas fa-save"></i> <span class="lang-text" data-zh="保存" data-en="Save">保存</span></button>
            </form>
        </div>
    </div>


    <div class="modal" id="story-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="lang-text" data-zh="添加故事" data-en="Add Story">添加故事</h2><button class="close-modal" onclick="closeStoryModal()">&times;</button></div>
            <form id="story-form">
                <div class="form-group"><label class="lang-text" data-zh="时间" data-en="Date">时间</label><input type="date" id="story-date" required></div>
                <div class="form-group"><label class="lang-text" data-zh="故事标题" data-en="Story Title">故事标题</label><input type="text" id="story-title" required placeholder="例如:一起参加的编程比赛" data-zh-placeholder="例如:一起参加的编程比赛" data-en-placeholder="e.g.: Programming competition together"></div>
                <div class="form-group"><label class="lang-text" data-zh="故事内容" data-en="Story Content">故事内容</label><textarea id="story-content" required placeholder="记录你们之间发生的故事..." data-zh-placeholder="记录你们之间发生的故事..." data-en-placeholder="Record the story between you..."></textarea></div>
                <div class="form-group">
                    <label class="lang-text" data-zh="上传照片/视频/文件" data-en="Upload Photos/Videos/Files">上传照片/视频/文件</label>
                    <div class="upload-area" id="story-upload-area">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="lang-text" data-zh="拖拽文件到此处或点击选择文件" data-en="Drag files here or click to select">拖拽文件到此处或点击选择文件</p>
                            <input type="file" id="story-media" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
                        </div>
                        <div class="uploaded-files" id="story-uploaded-files"></div>
                    </div>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-save"></i> <span class="lang-text" data-zh="保存故事" data-en="Save Story">保存故事</span></button>
            </form>
        </div>
    </div>

    <div class="modal" id="moment-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="lang-text" data-zh="添加朋友圈" data-en="Add Moment">添加朋友圈</h2><button class="close-modal" onclick="closeMomentModal()">&times;</button></div>
            <form id="moment-form">
                <div class="form-group"><label class="lang-text" data-zh="日期" data-en="Date">日期</label><input type="date" id="moment-date" required></div>
                <div class="form-group"><label class="lang-text" data-zh="内容" data-en="Content">内容</label><textarea id="moment-content" required placeholder="记录TA的朋友圈内容..." data-zh-placeholder="记录TA的朋友圈内容..." data-en-placeholder="Record their moment content..."></textarea></div>
                <div class="form-group">
                    <label class="lang-text" data-zh="上传图片/视频" data-en="Upload Images/Videos">上传图片/视频</label>
                    <div class="upload-area" id="moment-upload-area">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="lang-text" data-zh="拖拽文件到此处或点击选择文件" data-en="Drag files here or click to select">拖拽文件到此处或点击选择文件</p>
                            <input type="file" id="moment-media" multiple accept="image/*,video/*" style="display: none;">
                        </div>
                        <div class="uploaded-files" id="moment-uploaded-files"></div>
                    </div>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-save"></i> <span class="lang-text" data-zh="保存朋友圈" data-en="Save Moment">保存朋友圈</span></button>
            </form>
        </div>
    </div>







    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="lang-text" data-zh="导入微信聊天记录" data-en="Import WeChat Chat History">导入微信聊天记录</h2><button class="close-modal" onclick="closeChatModal()">&times;</button></div>
            <form id="chat-form">
                <div class="form-group"><label class="lang-text" data-zh="日期" data-en="Date">日期</label><input type="date" id="chat-date" required></div>
                <div class="form-group"><label class="lang-text" data-zh="聊天内容(每行一条,格式:发送者:内容)" data-en="Chat Content (one per line, format: Sender: Content)">聊天内容(每行一条,格式:发送者:内容)</label><textarea id="chat-content" rows="10" required placeholder="我:你好啊&#10;张三:你好!怎么样?" data-zh-placeholder="我:你好啊&#10;张三:你好!怎么样?" data-en-placeholder="Me: Hello&#10;John: Hi! How are you?"></textarea></div>
                <div class="form-group"><label class="lang-text" data-zh="或上传文本文件" data-en="Or Upload Text File">或上传文本文件</label><input type="file" id="chat-file" accept=".txt" onchange="loadChatFile(event)"></div>
                <button type="submit" class="submit-btn"><i class="fas fa-save"></i> <span class="lang-text" data-zh="保存聊天记录" data-en="Save Chat History">保存聊天记录</span></button>
            </form>
        </div>
    </div>

    <div class="modal" id="backup-settings-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2 class="lang-text" data-zh="自动备份设置" data-en="Auto Backup Settings">自动备份设置</h2>
                <button class="close-modal" onclick="closeBackupSettings()">&times;</button>
            </div>
            <div style="padding:20px 0;">
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                        <input type="checkbox" id="auto-backup-enabled" onchange="toggleAutoBackup()" style="width:20px;height:20px;">
                        <span style="font-size:1.1rem;" class="lang-text" data-zh="启用自动备份" data-en="Enable Auto Backup">启用自动备份</span>
                    </label>
                </div>
                <div class="form-group" id="backup-interval-group" style="display:none;">
                    <label><i class="fas fa-clock"></i> <span class="lang-text" data-zh="备份间隔" data-en="Backup Interval">备份间隔</span></label>
                    <select id="backup-interval" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;" onchange="updateBackupInterval()">
                        <option value="1" data-zh="每1小时" data-en="Every 1 hour">每1小时</option>
                        <option value="6" data-zh="每6小时" data-en="Every 6 hours">每6小时</option>
                        <option value="12" data-zh="每12小时" data-en="Every 12 hours">每12小时</option>
                        <option value="24" selected data-zh="每24小时（推荐）" data-en="Every 24 hours (Recommended)">每24小时（推荐）</option>
                        <option value="48" data-zh="每48小时" data-en="Every 48 hours">每48小时</option>
                        <option value="168" data-zh="每7天" data-en="Every 7 days">每7天</option>
                    </select>
                </div>
                <div id="backup-status" style="margin-top:20px;padding:15px;background:#f0f0f0;border-radius:10px;font-size:0.9rem;color:#666;">
                    <div><i class="fas fa-info-circle"></i> <span class="lang-text" data-zh="自动备份状态：" data-en="Auto Backup Status: ">自动备份状态：</span><span id="backup-status-text">未启用</span></div>
                    <div style="margin-top:8px;"><span class="lang-text" data-zh="上次备份：" data-en="Last Backup: ">上次备份：</span><span id="last-backup-time">从未</span></div>
                </div>
            </div>
            <button onclick="closeBackupSettings()" style="width:100%;padding:15px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;"><span class="lang-text" data-zh="确定" data-en="Confirm">确定</span></button>
        </div>
    </div>

    <script>
                // ========== 多语言支持 ==========
        let currentLanguage = localStorage.getItem('language') || '';
        // 语言值校验：仅允许 zh/en，其它视为未选择
        if (currentLanguage !== 'zh' && currentLanguage !== 'en') {
            currentLanguage = '';
            try { localStorage.removeItem('language'); } catch (_) {}
        }
        
        const translations = {
            zh: {
                quotes: [
                    '"谢谢你,陪我走过一段很美好的时光。"',
                    '"你不会偶然遇见一个人。总有一个原因;一个祝福或一个教训。"',
                    '"时间会决定你在生命中遇见谁,你的心决定你想要谁,出现在你的生命里,而你的行为会决定谁能留下。"',
                    '"于千万人之中遇见你所遇见的人,没有早一步,也没有晚一步……"',
                    '"我们生命中的每位过客都是独一无二的,他们会留下自己的一些印记,也会带走我们的部分气息。有人会带走很多,也有人什么也不留下。这恰好证明,两个灵魂不会偶然相遇。"',
                    '"人与人的相遇是奇迹的最小单位。这有种宿命的意味在。"',
                    '"认识自己最好的方法,就是不抱任何希望地去爱任何一个人,包括你自己。"'
                ]
            },
            en: {
                quotes: [
                    '"Thank you for walking with me through such a beautiful time."',
                    '"You don\'t meet people by accident. There\'s always a reason; a blessing or a lesson."',
                    '"Time decides who you meet in life, your heart decides who you want in your life, and your behavior decides who stays in your life."',
                    '"Among thousands of people, you meet those you\'ve come to meet. Not a moment too soon, not a moment too late..."',
                    '"Every person who passes through our lives is unique. They leave their mark and take part of us. Some take a lot, some leave nothing. This proves that two souls never meet by accident."',
                    '"The meeting of two people is the smallest unit of a miracle. It carries the weight of destiny."',
                    '"The best way to know yourself is to love anyone without expectation, including yourself."'
                ]
            }
        };


        function selectLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.getElementById('language-selection').classList.add('hidden');
            document.getElementById('language-selection').classList.remove('active');
            document.getElementById('current-lang-display').textContent = lang === 'zh' ? '中文' : 'English';
            updateLanguage();
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLanguage);
            document.getElementById('current-lang-display').textContent = currentLanguage === 'zh' ? '中文' : 'English';
            updateLanguage();
        }
        
        function updateLanguage() {
            const lang = currentLanguage;
            
            // 更新所有带 lang-text 类的元素
            document.querySelectorAll('.lang-text').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (text) {
                    el.innerHTML = text;
                }
            });
            
            // 更新 select 选项
            document.querySelectorAll('select option').forEach(option => {
                const text = option.getAttribute(`data-${lang}`);
                if (text) {
                    option.textContent = text;
                }
            });
            
            // 更新 input placeholder
            document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(input => {
                const placeholder = input.getAttribute(`data-${lang}-placeholder`);
                if (placeholder) {
                    input.placeholder = placeholder;
                }
            });
            
            // 更新引语
            quotes = translations[lang].quotes;
            showNextQuote();
            
            // 重新渲染页面内容
            // 恢复排序
            const savedSortBy = localStorage.getItem('people_sortBy');
            if (savedSortBy) {
                const sortSelect = document.getElementById('sort-select');
                sortSelect.value = savedSortBy;
            }
            renderPeople();
            if (currentPerson) {
                renderDetailPage();
            }
        }

        let quotes = [
            '"谢谢你，陪我走过一段很美好的时光。"',
            '"你不会偶然遇见一个人。总有一个原因；一个祝福或一个教训。"',
            '"时间会决定你在生命中遇见谁，你的心决定你想要谁，出现在你的生命里，而你的行为会决定谁能留下。"',
            '"于千万人之中遇见你所遇见的人，没有早一步，也没有晚一步……"',
            '"我们生命中的每位过客都是独一无二的，他们会留下自己的一些印记，也会带走我们的部分气息。有人会带走很多，也有人什么也不留下。这恰好证明，两个灵魂不会偶然相遇。"',
            '"人与人的相遇是奇迹的最小单位。这有种宿命的意味在。"',
            '"认识自己最好的方法，就是不抱任何希望地去爱任何一个人，包括你自己。"'
        ];
        let quoteIndex = 0;
        function showNextQuote() {
            const quoteText = document.getElementById('quote-text');
            if (!quoteText) return;
            quoteText.style.opacity = 0;
            setTimeout(() => {
                quoteText.innerHTML = quotes[quoteIndex];
                quoteText.style.opacity = 1;
                quoteIndex = (quoteIndex + 1) % quotes.length;
            }, 400);
        }

        let people = [];
        let currentPerson = null;
        let currentEditId = null;
        let croppedImageData = null;
        let currentEditingStoryId = null;
        let currentEditingMomentId = null;
        let currentEditingChatIndex = null;
        
        let currentFilterTag = '';
        let currentFilterLocation = '';
        let currentFilterProfession = '';
        let currentFilterStarred = 'all';
        let currentFilterColor = '';
        let currentFilterMbti = '';
        let currentFilterIntimacy = '';
        let sortOrder = 'asc';

        const colorMap = {
            'red': '#ef5350',
            'orange': '#ff9800',
            'yellow': '#ffeb3b',
            'green': '#4caf50',
            'blue': '#2196f3',
            'purple': '#9c27b0',
            'pink': '#e91e63'
        };

        // ========== 数据持久化功能 ==========
        
        // IndexedDB 配置
        const DB_NAME = 'LuminaEncountersDB';
        const DB_VERSION = 1;
        const STORE_PEOPLE = 'people';
        const STORE_MEDIA = 'media';
        
        let db = null;
        let isIndexedDBAvailable = false;
        
        // 初始化 IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.warn('IndexedDB 不可用，将使用 localStorage');
                    resolve(false);
                    return;
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB 打开失败:', request.error);
                    resolve(false);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    isIndexedDBAvailable = true;
                    console.log('IndexedDB 初始化成功');
                    resolve(true);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // 创建人物数据存储
                    if (!database.objectStoreNames.contains(STORE_PEOPLE)) {
                        const peopleStore = database.createObjectStore(STORE_PEOPLE, { keyPath: 'id' });
                        peopleStore.createIndex('name', 'name', { unique: false });
                        peopleStore.createIndex('starred', 'starred', { unique: false });
                    }
                    
                    // 创建媒体文件存储
                    if (!database.objectStoreNames.contains(STORE_MEDIA)) {
                        const mediaStore = database.createObjectStore(STORE_MEDIA, { keyPath: 'id', autoIncrement: true });
                        mediaStore.createIndex('personId', 'personId', { unique: false });
                        mediaStore.createIndex('type', 'type', { unique: false });
                    }
                };
            });
        }
        
        // 保存图片到 IndexedDB
        async function saveImageToIndexedDB(imageData, personId, fileName) {
            if (!isIndexedDBAvailable) return imageData; // 回退到 base64
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_MEDIA], 'readwrite');
                const store = transaction.objectStore(STORE_MEDIA);
                
                // 将 base64 转换为 Blob
                const base64Data = imageData.split(',')[1];
                const binaryData = atob(base64Data);
                const arrayBuffer = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    arrayBuffer[i] = binaryData.charCodeAt(i);
                }
                const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                
                const mediaRecord = {
                    personId: personId,
                    fileName: fileName,
                    type: 'image',
                    data: blob,
                    uploadTime: Date.now()
                };
                
                const request = store.add(mediaRecord);
                request.onsuccess = () => {
                    const mediaId = request.result;
                    console.log('图片已保存到 IndexedDB，ID:', mediaId);
                    resolve(`indexeddb://${mediaId}`);
                };
                request.onerror = () => {
                    console.error('保存图片到 IndexedDB 失败:', request.error);
                    resolve(imageData); // 回退到 base64
                };
            });
        }
        
        // 从 IndexedDB 获取图片
        async function getImageFromIndexedDB(mediaId) {
            if (!mediaId.startsWith('indexeddb://') || !isIndexedDBAvailable) {
                return mediaId; // 直接返回 base64 数据
            }
            
            return new Promise((resolve, reject) => {
                const actualId = parseInt(mediaId.replace('indexeddb://', ''));
                const transaction = db.transaction([STORE_MEDIA], 'readonly');
                const store = transaction.objectStore(STORE_MEDIA);
                const request = store.get(actualId);
                
                request.onsuccess = () => {
                    if (request.result) {
                        const blob = request.result.data;
                        const reader = new FileReader();
                        reader.onload = () => {
                            resolve(reader.result);
                        };
                        reader.onerror = () => {
                            console.error('读取图片失败');
                            resolve(''); // 返回空字符串作为占位符
                        };
                        reader.readAsDataURL(blob);
                    } else {
                        console.error('未找到图片数据');
                        resolve('');
                    }
                };
                request.onerror = () => {
                    console.error('获取图片失败:', request.error);
                    resolve('');
                };
            });
        }
        
        // 优化的图片压缩函数
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 计算新尺寸
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 绘制并压缩
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 保存数据到 IndexedDB
        async function saveToIndexedDB() {
            if (!isIndexedDBAvailable) {
                saveToLocalStorage(); // 回退方案
                return;
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_PEOPLE], 'readwrite');
                const store = transaction.objectStore(STORE_PEOPLE);
                
                // 清空现有数据
                store.clear();
                
                // 批量保存人物数据
                let completed = 0;
                const total = people.length;
                
                if (total === 0) {
                    resolve();
                    return;
                }
                
                people.forEach(person => {
                    const request = store.add(person);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            console.log('所有人物数据已保存到 IndexedDB');
                            resolve();
                        }
                    };
                    request.onerror = () => {
                        console.error('保存人物数据失败:', request.error);
                        reject(request.error);
                    };
                });
            });
        }
        
        // 从 IndexedDB 加载数据
        async function loadFromIndexedDB() {
            if (!isIndexedDBAvailable) {
                loadFromLocalStorage(); // 回退方案
                return;
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_PEOPLE], 'readonly');
                const store = transaction.objectStore(STORE_PEOPLE);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    people = request.result || [];
                    console.log('已从 IndexedDB 加载数据:', people.length, '条记录');
                    resolve();
                };
                request.onerror = () => {
                    console.error('从 IndexedDB 加载数据失败:', request.error);
                    reject(request.error);
                };
            });
        }
        
        // 统一的保存函数
        async function saveToLocalStorage() {
            try {
                if (isIndexedDBAvailable) {
                    await saveToIndexedDB();
                } else {
                    localStorage.setItem('peopleData', JSON.stringify(people));
                    console.log('数据已保存到 localStorage');
                }
            } catch (e) {
                console.error('保存数据失败:', e);
                // 尝试回退到 localStorage
                try {
                    localStorage.setItem('peopleData', JSON.stringify(people));
                    console.log('已回退到 localStorage 保存');
                } catch (fallbackError) {
                    console.error('localStorage 保存也失败:', fallbackError);
                    alert('数据保存失败！可能是存储空间不足。请尝试清理浏览器数据或减少图片数量。');
                }
            }
        }

        async function loadFromLocalStorage() {
            try {
                if (isIndexedDBAvailable) {
                    await loadFromIndexedDB();
                } else {
                    const saved = localStorage.getItem('peopleData');
                    if (saved) {
                        people = JSON.parse(saved);
                        console.log('已从 localStorage 加载数据:', people.length, '条记录');
                    }
                }
            } catch (e) {
                console.error('加载数据失败:', e);
                people = [];
            }
            // 一次性迁移：为缺少 createdAt 的 stories/moments 补上合理的时间戳
            try {
                let migrated = false;
                people.forEach(person => {
                    if (Array.isArray(person.stories)) {
                        const base = Date.now() - person.stories.length * 1000;
                        person.stories.forEach((s, idx) => {
                            if (!s.createdAt) {
                                s.createdAt = base + idx * 1000; // 保持原有数组顺序
                                migrated = true;
                            }
                        });
                    }
                    if (Array.isArray(person.moments)) {
                        const base = Date.now() - person.moments.length * 1000;
                        person.moments.forEach((m, idx) => {
                            if (!m.createdAt) {
                                m.createdAt = base + idx * 1000;
                                migrated = true;
                            }
                        });
                    }
                });
                if (migrated) {
                    console.log('已对旧数据执行 createdAt 迁移，并保存更改');
                    await saveToLocalStorage();
                }
            } catch ( migrErr ) {
                console.error('数据迁移时发生错误:', migrErr);
            }
        }
        
        // 存储空间监控
        function getStorageInfo() {
            if (isIndexedDBAvailable && navigator.storage && navigator.storage.estimate) {
                return navigator.storage.estimate().then(estimate => {
                    const used = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const percentage = quota > 0 ? (used / quota * 100).toFixed(2) : 0;
                    
                    return {
                        used: (used / 1024 / 1024).toFixed(2) + ' MB',
                        quota: (quota / 1024 / 1024).toFixed(2) + ' MB',
                        percentage: percentage + '%',
                        available: ((quota - used) / 1024 / 1024).toFixed(2) + ' MB'
                    };
                });
            } else {
                return Promise.resolve({
                    used: '未知',
                    quota: '未知', 
                    percentage: '未知',
                    available: '未知'
                });
            }
        }
        
        // 显示存储信息
        async function showStorageInfo() {
            const info = await getStorageInfo();
            const storageType = isIndexedDBAvailable ? 'IndexedDB' : 'localStorage';
            
            let message = '';
            if (currentLanguage === 'zh') {
                message = `📊 存储信息\n\n` +
                         `存储类型: ${storageType}\n` +
                         `已使用: ${info.used}\n` +
                         `总容量: ${info.quota}\n` +
                         `使用率: ${info.percentage}\n` +
                         `可用空间: ${info.available}\n\n` +
                         `📈 数据统计:\n` +
                         `人物记录: ${people.length} 条\n` +
                         `总图片数: ${getTotalImageCount()} 张\n\n` +
                         `💡 提示:\n` +
                         `• IndexedDB 支持更大容量存储\n` +
                         `• 图片已自动压缩优化\n` +
                         `• 建议定期导出备份`;
            } else {
                message = `📊 Storage Information\n\n` +
                         `Storage Type: ${storageType}\n` +
                         `Used: ${info.used}\n` +
                         `Total Capacity: ${info.quota}\n` +
                         `Usage: ${info.percentage}\n` +
                         `Available: ${info.available}\n\n` +
                         `📈 Data Statistics:\n` +
                         `People Records: ${people.length}\n` +
                         `Total Images: ${getTotalImageCount()}\n\n` +
                         `💡 Tips:\n` +
                         `• IndexedDB supports larger capacity\n` +
                         `• Images are auto-compressed\n` +
                         `• Regular backup recommended`;
            }
            
            alert(message);
        }
        
        // 计算总图片数量
        function getTotalImageCount() {
            let count = 0;
            people.forEach(person => {
                if (person.photo) count++;
                if (person.stories) {
                    person.stories.forEach(story => {
                        if (story.media) {
                            count += story.media.filter(m => m.type === 'image').length;
                        }
                    });
                }
                if (person.moments) {
                    person.moments.forEach(moment => {
                        if (moment.media) {
                            count += moment.media.filter(m => m.type === 'image').length;
                        }
                    });
                }
            });
            return count;
        }
        
        // 预处理图片数据用于PDF导出
        async function preprocessImagesForPDF(person) {
            // 处理头像
            if (person.photo && person.photo.startsWith('indexeddb://')) {
                try {
                    person.photo = await getImageFromIndexedDB(person.photo);
                    console.log('头像数据已预处理');
                } catch (error) {
                    console.error('预处理头像失败:', error);
                    person.photo = null;
                }
            }
            
            // 处理故事中的图片
            if (person.stories) {
                for (let story of person.stories) {
                    if (story.media) {
                        for (let media of story.media) {
                            if (media.type === 'image' && media.data.startsWith('indexeddb://')) {
                                try {
                                    media.data = await getImageFromIndexedDB(media.data);
                                    console.log('故事图片数据已预处理');
                                } catch (error) {
                                    console.error('预处理故事图片失败:', error);
                                    media.data = '';
                                }
                            }
                        }
                    }
                }
            }
            
            // 处理朋友圈中的图片
            if (person.moments) {
                for (let moment of person.moments) {
                    if (moment.media) {
                        for (let media of moment.media) {
                            if (media.type === 'image' && media.data.startsWith('indexeddb://')) {
                                try {
                                    media.data = await getImageFromIndexedDB(media.data);
                                    console.log('朋友圈图片数据已预处理');
                                } catch (error) {
                                    console.error('预处理朋友圈图片失败:', error);
                                    media.data = '';
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // 等待图片加载完成
        async function waitForImagesToLoad(containers) {
            const allImages = [];
            containers.forEach(container => {
                const images = container.querySelectorAll('img');
                images.forEach(img => {
                    allImages.push(new Promise((resolve) => {
                        if (img.complete) {
                            resolve();
                        } else {
                            img.onload = () => resolve();
                            img.onerror = () => resolve(); // 即使加载失败也继续
                        }
                    }));
                });
            });
            
            if (allImages.length > 0) {
                console.log(`等待 ${allImages.length} 张图片加载完成...`);
                await Promise.all(allImages);
                console.log('所有图片加载完成');
            }
            
            // 额外等待一点时间确保渲染完成
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化 IndexedDB
            console.log('正在初始化存储系统...');
            await initIndexedDB();
            
            // 【新增】添加全局事件委托来处理排序按钮点击
            document.addEventListener('click', (e) => {
                if (e.target.id === 'story-sort-toggle' || e.target.closest('#story-sort-toggle')) {
                    console.log('故事排序按钮触发 - 使用事件委托');
                    toggleStorySort();
                } else if (e.target.id === 'moment-sort-toggle' || e.target.closest('#moment-sort-toggle')) {
                    console.log('朋友圈排序按钮触发 - 使用事件委托');
                    toggleMomentSort();
                }
            });
            console.log('✅ 全局事件委托已设置');
            
            // 检查是否已选择语言
            if (!currentLanguage) {
                document.getElementById('language-selection').classList.remove('hidden');
                document.getElementById('language-selection').classList.add('active');
                // 兜底：下一帧再次强制显示，避免某些浏览器首次渲染时机问题
                requestAnimationFrame(() => {
                    const node = document.getElementById('language-selection');
                    node.classList.add('active');
                    node.classList.remove('hidden');
                });
            } else {
                document.getElementById('language-selection').classList.add('hidden');
                document.getElementById('current-lang-display').textContent = currentLanguage === 'zh' ? '中文' : 'English';
                updateLanguage();
            }
            
            // 加载本地数据
            await loadFromLocalStorage();
            
            showNextQuote();
            setInterval(showNextQuote, 4000);
            renderPeople();

            // 搜索输入防抖
            const searchInput = document.getElementById('search-input');
            let searchTimer = null;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    localStorage.setItem('people_search', searchInput.value);
                    renderPeople();
                }, 200);
            });
            // 还原上次搜索
            const savedSearch = localStorage.getItem('people_search');
            if (savedSearch) searchInput.value = savedSearch;
            // MBTI输入验证
            document.getElementById('person-mbti').addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase();
                // 只允许MBTI的16种类型相关字母
                value = value.replace(/[^EINSFTJP]/g, '');
                e.target.value = value;
            });
            
            
            document.getElementById('sort-select').addEventListener('change', (e) => {
                localStorage.setItem('people_sortBy', e.target.value);
                renderPeople();
            });
            document.getElementById('avatar-input').addEventListener('change', handleAvatarUpload);
            document.getElementById('person-name').addEventListener('input', (e) => {
                if (!croppedImageData) {
                    updateAvatarPreview(null, e.target.value || '?');
                }
            });

            document.getElementById('person-form').addEventListener('submit', savePerson);
            document.getElementById('story-form').addEventListener('submit', saveStory);
            document.getElementById('moment-form').addEventListener('submit', saveMoment);
            document.getElementById('chat-form').addEventListener('submit', saveChat);
            
            // 初始化亲密度和颜色选择器的事件（会在打开模态框时重新绑定）
            initHeartRatingEvents();
            initColorPickerEvents();

            // 初始化自动备份
            initAutoBackup();
            
            // 🔧 全局拖拽功能 - 使用事件委托确保拖拽始终有效
            console.log('🎯 初始化全局拖拽事件委托...');
            
            document.addEventListener('dragenter', function(e) {
                const uploadArea = e.target.closest('.upload-area');
                if (uploadArea) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                    console.log('📥 文件拖拽进入上传区域');
                }
            }, true);
            
            document.addEventListener('dragover', function(e) {
                const uploadArea = e.target.closest('.upload-area');
                if (uploadArea) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                }
            }, true);
            
            document.addEventListener('dragleave', function(e) {
                const uploadArea = e.target.closest('.upload-area');
                if (uploadArea) {
                    e.preventDefault();
                    const rect = uploadArea.getBoundingClientRect();
                    if (e.clientX < rect.left || e.clientX >= rect.right ||
                        e.clientY < rect.top || e.clientY >= rect.bottom) {
                        uploadArea.classList.remove('dragover');
                        console.log('📤 文件离开上传区域');
                    }
                }
            }, true);
            
            document.addEventListener('drop', function(e) {
                const uploadArea = e.target.closest('.upload-area');
                if (uploadArea) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    console.log('===== 文件拖拽放下（全局处理）=====');
                    console.log('拖拽的文件数量:', e.dataTransfer.files.length);
                    
                    if (e.dataTransfer.files.length === 0) {
                        console.log('⚠️ 没有拖拽文件');
                        return;
                    }
                    
                    console.log('📋 文件列表:', Array.from(e.dataTransfer.files).map(f => f.name));
                    
                    // 确定是哪个上传区域
                    const uploadAreaId = uploadArea.id;
                    let fileInput, uploadedFilesContainer;
                    
                    if (uploadAreaId === 'story-upload-area') {
                        fileInput = document.getElementById('story-media');
                        uploadedFilesContainer = document.getElementById('story-uploaded-files');
                    } else if (uploadAreaId === 'moment-upload-area') {
                        fileInput = document.getElementById('moment-media');
                        uploadedFilesContainer = document.getElementById('moment-uploaded-files');
                    }
                    
                    if (fileInput && uploadedFilesContainer) {
                        handleFiles(e.dataTransfer.files, uploadedFilesContainer, fileInput);
                        console.log('✅ 文件已通过全局拖拽处理');
                    } else {
                        console.error('❌ 无法找到文件输入框或上传容器');
                    }
                }
            }, true);
            
            console.log('✅ 全局拖拽事件委托已激活');
        });








        function initHeartRatingEvents() {
            // 移除旧的事件监听器，避免重复绑定
            document.querySelectorAll('#heart-rating .heart-wrapper').forEach(wrapper => {
                const newWrapper = wrapper.cloneNode(true);
                wrapper.parentNode.replaceChild(newWrapper, wrapper);
            });
            
            // 重新绑定点击事件
            document.querySelectorAll('#heart-rating .heart-wrapper').forEach(wrapper => {
                wrapper.addEventListener('click', function() {
                    const clickedValue = parseInt(this.getAttribute('data-value'));
                    const newValue = Math.max(1, Math.min(5, clickedValue));
                    document.getElementById('person-intimacy').value = newValue;
                    updateHeartRating(newValue);
                });
            });
        }

        function initColorPickerEvents() {
            // 移除旧的事件监听器，避免重复绑定
            document.querySelectorAll('.color-option').forEach(option => {
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
            });
            
            // 重新绑定点击事件
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    document.getElementById('person-color').value = color;
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function updateHeartRating(value) {
            const hearts = document.querySelectorAll('#heart-rating .heart-wrapper');
            hearts.forEach((wrapper, index) => {
                const heartValue = index + 1;
                const icon = wrapper.querySelector('i');
                
                if (value >= heartValue) {
                    icon.className = 'fas fa-heart heart-full';
                } else {
                    icon.className = 'fas fa-heart heart-empty';
                }
            });
        }

        function calculateAge(birthday) {
            if (!birthday) return currentLanguage === 'zh' ? '未知' : 'Unknown';
            const today = new Date();
            const birthDate = new Date(birthday);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return currentLanguage === 'zh' ? age + '岁' : age + ' yrs';
        }

        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            const btn = document.getElementById('sort-order-btn');
            if (sortOrder === 'asc') {
                btn.innerHTML = '<i class="fas fa-sort-amount-down"></i> <span class="lang-text" data-zh="正序" data-en="Ascending">正序</span>';
            } else {
                btn.innerHTML = '<i class="fas fa-sort-amount-up"></i> <span class="lang-text" data-zh="倒序" data-en="Descending">倒序</span>';
            }
            updateLanguage();
            renderPeople();
        }


        function renderTagFilters() {
            const tagsSet = new Set();
            people.forEach(person => {
                if (person.tags && person.tags.length > 0) {
                    person.tags.forEach(tag => tagsSet.add(tag));
                }
            });

            const container = document.getElementById('tag-filters');
            const allText = currentLanguage === 'zh' ? '全部' : 'All';
            const activeClass = !currentFilterTag ? 'active' : '';
            container.innerHTML = `<button class="tag-btn ${activeClass}" onclick="filterByTag('', this)">${allText}</button>`;

            Array.from(tagsSet).sort().forEach(tag => {
                const isActive = currentFilterTag === tag ? 'active' : '';
                container.innerHTML += `<button class="tag-btn ${isActive}" onclick=\"filterByTag('${tag.replace(/'/g, "\\'")}', this)\">${tag}</button>`;
            });
        }

        function renderProfessionFilters() {
            const professionsSet = new Set();
            people.forEach(person => {
                if (person.profession && person.profession.trim()) {
                    const professions = person.profession.split(',').map(p => p.trim()).filter(p => p);
                    professions.forEach(prof => professionsSet.add(prof));
                }
            });

            const container = document.getElementById('profession-filters');
            const allText = currentLanguage === 'zh' ? '全部' : 'All';
            const activeClass = !currentFilterProfession ? 'active' : '';
            container.innerHTML = `<button class="tag-btn ${activeClass}" onclick="filterByProfession('', this)">${allText}</button>`;

            Array.from(professionsSet).sort().forEach(profession => {
                const isActive = currentFilterProfession === profession ? 'active' : '';
                container.innerHTML += `<button class="tag-btn ${isActive}" onclick=\"filterByProfession('${profession.replace(/'/g, "\\'")}', this)\">${profession}</button>`;
            });
        }

        function renderLocationFilters() {
            const locationsSet = new Set();
            people.forEach(person => {
                if (person.location && person.location.trim()) {
                    locationsSet.add(person.location.trim());
                }
            });

            const container = document.getElementById('location-filters');
            const allText = currentLanguage === 'zh' ? '全部地区' : 'All Locations';
            const activeClass = !currentFilterLocation ? 'active' : '';
            container.innerHTML = `<button class="tag-btn ${activeClass}" onclick="filterByLocation('', this)">${allText}</button>`;

            Array.from(locationsSet).sort().forEach(location => {
                const isActive = currentFilterLocation === location ? 'active' : '';
                container.innerHTML += `<button class="tag-btn ${isActive}" onclick=\"filterByLocation('${location.replace(/'/g, "\\'")}', this)\">${location}</button>`;
            });
        }

        function filterByProfession(profession, element) {
            currentFilterProfession = profession;
            document.querySelectorAll('#profession-filters .tag-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByTag(tag, element) {
            currentFilterTag = tag;
            document.querySelectorAll('#tag-filters .tag-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByLocation(location, element) {
            currentFilterLocation = location;
            document.querySelectorAll('#location-filters .tag-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByColor(color, element) {
            currentFilterColor = color;
            document.querySelectorAll('#color-filters .tag-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByStarred(filter, element) {
            currentFilterStarred = filter;
            const container = element ? element.parentElement : null;
            if (container) {
                container.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
            }
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByMbti(mbti, element) {
            currentFilterMbti = mbti;
            const container = element ? element.parentElement : null;
            if (container) {
                container.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
            }
            if (element) element.classList.add('active');
            renderPeople();
        }

        function filterByIntimacy(intimacy, element) {
            currentFilterIntimacy = intimacy;
            document.querySelectorAll('#intimacy-filters .tag-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderPeople();
        }

        function renderMbtiFilters() {
            const mbtiSet = new Set();
            people.forEach(person => {
                if (person.mbti && person.mbti.trim()) {
                    mbtiSet.add(person.mbti.trim().toUpperCase());
                }
            });

            const container = document.getElementById('mbti-filters');
            const allText = currentLanguage === 'zh' ? '全部' : 'All';
            const activeClass = !currentFilterMbti ? 'active' : '';
            container.innerHTML = `<button class="tag-btn ${activeClass}" data-mbti="" onclick="filterByMbti('', this)">${allText}</button>`;

            Array.from(mbtiSet).sort().forEach(mbti => {
                const isActive = currentFilterMbti === mbti ? 'active' : '';
                container.innerHTML += `<button class="tag-btn ${isActive}" data-mbti="${mbti}" onclick="filterByMbti('${mbti}', this)">${mbti}</button>`;
            });
        }
        
        function renderPeople() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortBy = document.getElementById('sort-select').value;

            let filtered = people.filter(person => {
                const matchSearch = person.name.toLowerCase().includes(searchTerm);
                const matchTag = !currentFilterTag || (person.tags && person.tags.includes(currentFilterTag));
                const matchLocation = !currentFilterLocation || (person.location && person.location.trim() === currentFilterLocation);
                
                // 专业筛选
                let matchProfession = !currentFilterProfession;
                if (currentFilterProfession && person.profession) {
                    const professions = person.profession.split(',').map(p => p.trim());
                    matchProfession = professions.includes(currentFilterProfession);
                }
                
                const matchStarred = currentFilterStarred === 'all' || 
                                    (currentFilterStarred === 'starred' && person.starred === true) ||
                                    (currentFilterStarred === 'unstarred' && person.starred !== true);
                const matchColor = !currentFilterColor || 
                                  (currentFilterColor === 'none' && !person.colorLabel) ||
                                  (person.colorLabel === currentFilterColor);
                const matchMbti = !currentFilterMbti || (person.mbti && person.mbti.trim().toUpperCase() === currentFilterMbti);
                const matchIntimacy = !currentFilterIntimacy || 
                                     (parseFloat(person.intimacy) || 0).toString() === currentFilterIntimacy;
                
                return matchSearch && matchTag && matchLocation && matchProfession && matchStarred && matchColor && matchMbti && matchIntimacy;
            });

            if (sortBy === 'name') {
                filtered.sort((a, b) => {
                    const result = a.name.localeCompare(b.name, 'zh-CN');
                    return sortOrder === 'asc' ? result : -result;
                });
            } else if (sortBy === 'time') {
                filtered.sort((a, b) => {
                    const timeA = a.meetTime ? new Date(a.meetTime).getTime() : 0;
                    const timeB = b.meetTime ? new Date(b.meetTime).getTime() : 0;
                    const result = timeA - timeB;
                    return sortOrder === 'asc' ? result : -result;
                });
            } else if (sortBy === 'intimacy') {
                filtered.sort((a, b) => {
                    const intimacyA = parseFloat(a.intimacy) || 0;
                    const intimacyB = parseFloat(b.intimacy) || 0;
                    const result = intimacyA - intimacyB;
                    return sortOrder === 'asc' ? result : -result;
                });
            } else {
                filtered.sort((a, b) => {
                    const result = (b.id || 0) - (a.id || 0);
                    return sortOrder === 'asc' ? -result : result;
                });
            }

            const container = document.getElementById('people-container');
            const noResultText = currentLanguage === 'zh' ? '没有找到匹配的人物' : 'No matching people found';
            if (filtered.length === 0) {
                container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:60px; color:white;"><i class="fas fa-user-slash" style="font-size:3rem; margin-bottom:20px; display:block;"></i><p style="font-size:1.2rem;">${noResultText}</p></div>`;
                return;
            }

            const unknownText = currentLanguage === 'zh' ? '未知' : 'Unknown';
            
            container.innerHTML = filtered.map(person => {
                const tags = person.tags && person.tags.length > 0 
                    ? person.tags.map(tag => `<span class="tag">${tag}</span>`).join('') 
                    : `<span class="tag" style="background:#f0f0f0;color:#999;">${unknownText}</span>`;
                
                let intimacyDisplay = '';
                const intimacyValue = parseFloat(person.intimacy) || 0;
                for (let i = 0; i < intimacyValue; i++) {
                    intimacyDisplay += '♥';
                }
                intimacyDisplay = intimacyDisplay || unknownText;
                
                const age = calculateAge(person.birthday);
                const birthday = person.birthday || unknownText;
                const starTitle = person.starred ? (currentLanguage === 'zh' ? '取消星标' : 'Unstar') : (currentLanguage === 'zh' ? '添加星标' : 'Star');
                const deleteTitle = currentLanguage === 'zh' ? '删除' : 'Delete';

                return `
                    <div class="person-card" onclick="showDetailPage(${person.id})">
                        ${person.colorLabel ? `<div class="color-label" style="background:${colorMap[person.colorLabel]};" title="${person.colorLabel}"></div>` : ''}
                        <button class="star-btn ${person.starred ? 'starred' : ''}" onclick="event.stopPropagation(); toggleStar(${person.id})" title="${starTitle}">
                            <i class="fas fa-star" style="color:${person.starred ? '#FFD700' : '#999'};"></i>
                        </button>
                        <button class="delete-card-btn" onclick="event.stopPropagation(); deletePersonFromCard(${person.id})" title="${deleteTitle}">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="avatar-container">
                            ${person.photo 
                                ? `<img src="${person.photo}" class="person-avatar" alt="${person.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" data-indexeddb="${person.photo.startsWith('indexeddb://')}"><div class="avatar-placeholder" style="display:none;">${person.name.charAt(0)}</div>` 
                                : `<div class="avatar-placeholder">${person.name.charAt(0)}</div>`
                            }
                        </div>
                        <div class="person-name">${person.name}</div>
                        <div class="person-profession">${person.profession || unknownText}</div>
                        <div class="person-intimacy">${intimacyDisplay}</div>
                        <div class="person-info">🎂 ${birthday} · ${age}</div>
                        <div class="person-tags">${tags}</div>
                    </div>
                `;
            }).join('');
            
            renderTagFilters();
            renderLocationFilters();
            renderProfessionFilters();
            renderMbtiFilters();
            
            // 异步加载 IndexedDB 存储的头像
            loadIndexedDBAvatars();
        }
        
        // 异步加载 IndexedDB 存储的头像
        async function loadIndexedDBAvatars() {
            const avatarImages = document.querySelectorAll('.person-avatar[data-indexeddb="true"]');
            for (const img of avatarImages) {
                try {
                    const imageData = await getImageFromIndexedDB(img.src);
                    if (imageData) {
                        img.src = imageData;
                        img.removeAttribute('data-indexeddb');
                    }
                } catch (error) {
                    console.error('加载头像失败:', error);
                    // 显示占位符
                    img.style.display = 'none';
                    const placeholder = img.nextElementSibling;
                    if (placeholder) {
                        placeholder.style.display = 'flex';
                    }
                }
            }
        }

        async function toggleStar(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            person.starred = !person.starred;
            await saveToLocalStorage();
            renderPeople();
        }

        async function deletePersonFromCard(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            const confirmMsg = currentLanguage === 'zh'
                ? `确定要删除「${person.name}」吗？\n\n此操作不可恢复！`
                : `Are you sure you want to delete "${person.name}"?\n\nThis action cannot be undone!`;
            if (confirm(confirmMsg)) {
                people = people.filter(p => p.id !== personId);
                await saveToLocalStorage();
                renderPeople();
            }
        }

        function openAddModal() {
            currentEditId = null;
            croppedImageData = null;
            document.getElementById('person-form').reset();
            const modalTitle = document.getElementById('modal-title');
            modalTitle.setAttribute('data-zh', '添加新人物');
            modalTitle.setAttribute('data-en', 'Add New Person');
            modalTitle.textContent = currentLanguage === 'zh' ? '添加新人物' : 'Add New Person';
            updateAvatarPreview(null, '?');
            updateHeartRating(0);
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.color-option.none').classList.add('selected');
            document.getElementById('person-color').value = '';
            document.getElementById('person-modal').classList.add('active');
            
            // 重新初始化事件监听器
            initHeartRatingEvents();
            initColorPickerEvents();
        }

        function closePersonModal() {
            document.getElementById('person-modal').classList.remove('active');
        }

        function updateAvatarPreview(avatarData, name) {
            const container = document.getElementById('avatar-preview');
            if (avatarData) {
                container.innerHTML = `<img src="${avatarData}" class="avatar-preview" alt="头像预览">`;
            } else {
                const initial = name ? name.charAt(0).toUpperCase() : '?';
                container.innerHTML = `<div class="avatar-preview-placeholder">${initial}</div>`;
            }
        }



        let cropperInstance = null;



        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('开始处理上传的文件:', file.name); // 调试用

            if (!file.type.startsWith('image/')) {
                const alertMsg = currentLanguage === 'zh' ? '请选择图片文件！' : 'Please select an image file!';
                alert(alertMsg);
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                console.log('图片读取成功'); // 调试用
                
                const cropImage = document.getElementById('crop-image');
                if (!cropImage) {
                    console.error('找不到 crop-image 元素！');
                    return;
                }
                
                cropImage.src = event.target.result;
                
                // 显示裁剪界面
                const cropWrapper = document.getElementById('crop-container-wrapper');
                const uploadBtn = document.getElementById('upload-avatar-btn');
                const previewContainer = document.querySelector('.avatar-preview-container');
                
                if (cropWrapper) cropWrapper.style.display = 'block';
                if (uploadBtn) uploadBtn.style.display = 'none';
                if (previewContainer) previewContainer.style.display = 'none';
                
                // 销毁旧的裁剪实例
                if (cropperInstance) {
                    cropperInstance.destroy();
                    cropperInstance = null;
                }
                
                // 等待图片加载完成后初始化 Cropper
                cropImage.onload = function() {
                    console.log('初始化 Cropper'); // 调试用
                    try {
                        cropperInstance = new Cropper(cropImage, {
                            aspectRatio: 1,
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 0.8,
                            restore: false,
                            guides: true,
                            center: true,
                            highlight: false,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                            toggleDragModeOnDblclick: false,
                        });
                        console.log('Cropper 初始化成功');
                    } catch (error) {
                        console.error('Cropper 初始化失败:', error);
                        alert('图片裁剪功能初始化失败：' + error.message);
                    }
                };
                
                cropImage.onerror = function() {
                    console.error('图片加载失败');
                    alert('图片加载失败');
                };
            };
            
            reader.onerror = function(error) {
                console.error('文件读取失败:', error);
                const alertMsg = currentLanguage === 'zh' ? '图片读取失败！' : 'Failed to read image!';
                alert(alertMsg);
                e.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }







        async function confirmCrop() {
            if (!cropperInstance) {
                console.error('裁剪实例不存在');
                return;
            }
            
            console.log('确认裁剪'); // 调试用
            
            try {
                const canvas = cropperInstance.getCroppedCanvas({
                    width: 300,
                    height: 300,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });
                // 压缩头像，控制体积
                croppedImageData = canvas.toDataURL('image/jpeg', 0.85);
                console.log('裁剪完成，数据大小:', croppedImageData.length);
                
                const name = document.getElementById('person-name').value || '?';
                updateAvatarPreview(croppedImageData, name);
                
                cancelCrop();
            } catch (error) {
                console.error('裁剪失败:', error);
                alert('裁剪失败：' + error.message);
            }
        }

        function cancelCrop() {
            if (cropperInstance) {
                cropperInstance.destroy();
                cropperInstance = null;
            }
            
            document.getElementById('crop-container-wrapper').style.display = 'none';
            document.getElementById('upload-avatar-btn').style.display = 'inline-block';
            document.querySelector('.avatar-preview-container').style.display = 'block';
            document.getElementById('avatar-input').value = '';
        }



        async function savePerson(e) {
            e.preventDefault();
            console.log('开始保存人物信息'); // 调试用

            const personData = {
                id: currentEditId || Date.now(),
                name: document.getElementById('person-name').value.trim(),
                profession: document.getElementById('person-profession').value.trim(),
                location: document.getElementById('person-location').value.trim(),
                hometown: document.getElementById('person-hometown').value.trim(),
                birthday: document.getElementById('person-birthday').value,
                personality: document.getElementById('person-personality').value.trim(),
                mbti: document.getElementById('person-mbti').value.trim().toUpperCase(),
                intimacy: parseFloat(document.getElementById('person-intimacy').value) || 0,    
                hobbies: document.getElementById('person-hobbies').value.trim(),
                meetTime: document.getElementById('person-meettime').value,
                meetPlace: document.getElementById('person-meetplace').value.trim(),
                meetReason: document.getElementById('person-meetreason').value.trim(),
                tags: document.getElementById('person-tags').value.split(',').map(t => t.trim()).filter(t => t),
                colorLabel: document.getElementById('person-color').value,
                starred: currentEditId ? (people.find(p => p.id === currentEditId)?.starred || false) : false,
                learnPoints: currentEditId ? (people.find(p => p.id === currentEditId)?.learnPoints || '') : '',
                photo: null, // 将在下面处理
                contact: {
                    phone: document.getElementById('person-phone').value.trim(),
                    email: document.getElementById('person-email').value.trim(),
                    wechatId: document.getElementById('person-wechat-id').value.trim()
                },
                stories: currentEditId ? (people.find(p => p.id === currentEditId)?.stories || []) : [],
                moments: currentEditId ? (people.find(p => p.id === currentEditId)?.moments || []) : [],
                chatHistory: currentEditId ? (people.find(p => p.id === currentEditId)?.chatHistory || []) : []
            };

            if (!personData.name) {
                const alertMsg = currentLanguage === 'zh' ? '请填写姓名！' : 'Please enter a name!';
                alert(alertMsg);
                return;
            }

            // 处理头像存储
            if (croppedImageData) {
                try {
                    personData.photo = await saveImageToIndexedDB(croppedImageData, personData.id, 'avatar.jpg');
                    console.log('头像已保存到 IndexedDB');
                } catch (error) {
                    console.error('头像保存失败:', error);
                    personData.photo = croppedImageData; // 回退到 base64
                }
            } else if (currentEditId) {
                personData.photo = people.find(p => p.id === currentEditId)?.photo || null;
            }

            console.log('准备保存的数据:', personData); // 调试用

            if (currentEditId) {
                const index = people.findIndex(p => p.id === currentEditId);
                if (index !== -1) {
                    people[index] = personData;
                    console.log('更新了现有人物');
                }
            } else {
                people.push(personData);
                console.log('添加了新人物，当前总数:', people.length);
            }

            // 关键：立即保存到存储系统
            await saveToLocalStorage();
            console.log('已保存到存储系统');
            
            closePersonModal();
            
            // 先更新主页显示
            renderPeople();
            
            // 然后打开详情页
            setTimeout(() => {
                showDetailPage(personData.id);
            }, 200);
        }



        function showMainPage() {
            document.getElementById('detail-modal').classList.remove('active');
            renderPeople();
        }

        function showDetailPage(personId) {
            currentPerson = people.find(p => p.id === personId);
            if (!currentPerson) {
                alert('找不到该人物！');
                return;
            }
            document.getElementById('detail-modal').classList.add('active');
            renderDetailPage();
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        async function renderDetailPage() {
            // 翻译文本
            const t = currentLanguage === 'zh' ? {
                editProfile: '编辑档案',
                exportPDF: '导出PDF',
                delete: '删除',
                birthday: '生日',
                location: '所在地区',
                hometown: '老家',
                personality: '性格特点',
                hobbies: '兴趣爱好',
                meetingTime: '相识时间',
                meetingPlace: '相识地点',
                meetingReason: '相识缘由',
                phone: '电话',
                email: '邮箱',
                wechatId: '微信号',
                notFilled: '未填写',
                noTags: '暂无标签',
                learnFrom: '值得学习的地方',
                noContent: '暂无内容（双击此处添加）',
                ourStories: '我和TA的故事',
                noStories: '暂无故事，点击下方按钮添加',
                addStory: '添加故事',
                searchStories: '搜索故事标题或内容...',
                sortByAdded: '按添加顺序',
                sortByDateLabel: '按事件发生顺序',
                sortByDateDesc: '按时间排序 (最新)',
                sortByDateAsc: '按时间排序 (最早)',
                sortByTitleAsc: '按标题排序 (A-Z)',
                sortByTitleDesc: '按标题排序 (Z-A)',
                noSearchResults: '没有找到匹配的故事',
                theirMoments: 'TA的朋友圈',
                noMoments: '暂无朋友圈，点击下方按钮添加',
                addMoment: '添加朋友圈',
                searchMoments: '搜索朋友圈内容...',
                noMomentSearchResults: '没有找到匹配的朋友圈',
                chatHistory: '微信聊天记录',
                noChatHistory: '暂无聊天记录，点击下方按钮导入',
                importChat: '导入聊天记录',
                totalMessages: '条消息'
            } : {
                editProfile: 'Edit Profile',
                exportPDF: 'Export PDF',
                delete: 'Delete',
                birthday: 'Birthday',
                location: 'Location',
                hometown: 'Hometown',
                personality: 'Personality',
                hobbies: 'Hobbies',
                meetingTime: 'Meeting Time',
                meetingPlace: 'Meeting Place',
                meetingReason: 'How We Met',
                phone: 'Phone',
                email: 'Email',
                wechatId: 'WeChat ID',
                notFilled: 'Not filled',
                noTags: 'No tags',
                learnFrom: 'What to Learn from Them',
                noContent: 'No content (double-click to add)',
                ourStories: 'Our Stories',
                noStories: 'No stories yet, click below to add',
                addStory: 'Add Story',
                searchStories: 'Search story title or content...',
                sortByAdded: 'Sort by Added Order',
                sortByDateLabel: 'Sort by Event Date',
                sortByDateDesc: 'Sort by Date (Newest)',
                sortByDateAsc: 'Sort by Date (Oldest)',
                sortByTitleAsc: 'Sort by Title (A-Z)',
                sortByTitleDesc: 'Sort by Title (Z-A)',
                noSearchResults: 'No matching stories found',
                theirMoments: 'Their Moments',
                noMoments: 'No moments yet, click below to add',
                addMoment: 'Add Moment',
                searchMoments: 'Search moment content...',
                noMomentSearchResults: 'No matching moments found',
                chatHistory: 'Chat History',
                noChatHistory: 'No chat history yet, click below to import',
                importChat: 'Import Chat History',
                totalMessages: 'messages'
            };
            
            const tags = currentPerson.tags && currentPerson.tags.length > 0 
                ? currentPerson.tags.map(tag => `<span class="detail-tag">${tag}</span>`).join('') 
                : `<span class="detail-tag" style="background:#f0f0f0;color:#999;">${t.noTags}</span>`;

            const stories = currentPerson.stories || [];
            const moments = currentPerson.moments || [];
            const chatHistory = currentPerson.chatHistory || [];
            
            // 获取头像数据
            let avatarHtml = '';
            if (currentPerson.photo) {
                try {
                    const avatarData = await getImageFromIndexedDB(currentPerson.photo);
                    avatarHtml = `<img src="${avatarData}" class="detail-avatar-img" alt="${currentPerson.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="detail-avatar-img avatar-placeholder" style="width:150px;height:150px;font-size:3.5rem;display:none;">${currentPerson.name.charAt(0)}</div>`;
                } catch (error) {
                    console.error('获取头像失败:', error);
                    avatarHtml = `<div class="detail-avatar-img avatar-placeholder" style="width:150px;height:150px;font-size:3.5rem;">${currentPerson.name.charAt(0)}</div>`;
                }
            } else {
                avatarHtml = `<div class="detail-avatar-img avatar-placeholder" style="width:150px;height:150px;font-size:3.5rem;">${currentPerson.name.charAt(0)}</div>`;
            }

            document.getElementById('detail-container').innerHTML = `
                <div class="detail-header">
                    <div class="detail-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="detail-info">
                        <div class="detail-name">${currentPerson.name}</div>
                        <div class="detail-profession">${currentPerson.profession || t.notFilled}</div>
                        <div class="detail-tags">${tags}</div>
                        <div class="detail-actions">
                            <button class="action-btn btn-edit" onclick="editCurrentPerson()"><i class="fas fa-edit"></i> ${t.editProfile}</button>
                            <button class="action-btn" style="background:#9C27B0;color:white;" onclick="exportPersonToPDF(${currentPerson.id})"><i class="fas fa-file-pdf"></i> ${t.exportPDF}</button>
                            <button class="action-btn btn-delete" onclick="deleteCurrentPerson()"><i class="fas fa-trash"></i> ${t.delete}</button>
                        </div>
                    </div>
                </div>
                
                
                <div class="info-grid">
                    <div class="info-item"><div class="info-label"><i class="fas fa-birthday-cake"></i> ${t.birthday}</div><div class="info-value">${currentPerson.birthday || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-map-marker-alt"></i> ${t.location}</div><div class="info-value">${currentPerson.location || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-home"></i> ${t.hometown}</div><div class="info-value">${currentPerson.hometown || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-heart"></i> ${t.personality}</div><div class="info-value">${currentPerson.personality || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-brain"></i> MBTI</div><div class="info-value">${currentPerson.mbti ? `<span style="display:inline-block;background:#E8EAF6;color:#5C6BC0;padding:6px 14px;border-radius:12px;font-weight:600;font-size:1rem;">${currentPerson.mbti}</span>` : t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-heartbeat"></i> ${currentLanguage === 'zh' ? '亲密度' : 'Intimacy'}</div><div class="info-value">${currentPerson.intimacy ? currentPerson.intimacy + ' / 5' : t.notFilled}</div></div>
                    
                    
                    
                    <div class="info-item"><div class="info-label"><i class="fas fa-gamepad"></i> ${t.hobbies}</div><div class="info-value">${currentPerson.hobbies || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-calendar"></i> ${t.meetingTime}</div><div class="info-value">${currentPerson.meetTime || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-map-marker-alt"></i> ${t.meetingPlace}</div><div class="info-value">${currentPerson.meetPlace || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-question-circle"></i> ${t.meetingReason}</div><div class="info-value">${currentPerson.meetReason || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-phone"></i> ${t.phone}</div><div class="info-value">${currentPerson.contact?.phone || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fas fa-envelope"></i> ${t.email}</div><div class="info-value">${currentPerson.contact?.email || t.notFilled}</div></div>
                    <div class="info-item"><div class="info-label"><i class="fab fa-weixin"></i> ${t.wechatId}</div><div class="info-value">${currentPerson.contact?.wechatId || t.notFilled}</div></div>
                </div>
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-star"></i> ${t.learnFrom}</h2>
                    <div class="section-content" id="learnpoints-section" ondblclick="enableLearnPointsEdit()" style="cursor:pointer;min-height:80px;">
                        <span id="learnpoints-display">${currentPerson.learnPoints ? currentPerson.learnPoints.replace(/\n/g, '<br>') : `<span style="color:#999;">${t.noContent}</span>`}</span>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><i class="fas fa-book"></i> ${t.ourStories}</h2>
                    
                    <!-- 搜索和排序控件 -->
                    <div class="search-sort-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="story-search" placeholder="${t.searchStories}" oninput="filterStories()">
                        </div>
                        <div class="sort-controls">
                            <button id="story-sort-toggle" class="sort-toggle-btn" title="切换时间顺序">
                                <i class="fas fa-sort-amount-down"></i>
                                <span class="sort-text">最新在前</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-content" id="stories-container">
                        ${stories.length > 0 ? await Promise.all(stories.map(async story => {
                            let mediaHtml = '';
                            if (story.media && story.media.length > 0) {
                                const mediaItems = await Promise.all(story.media.map(async m => {
                                    if (m.type === 'image') {
                                        const imageData = await getImageFromIndexedDB(m.data);
                                        return `<div class="media-item"><img src="${imageData}" alt="${m.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div style="display:none;padding:15px;background:#f0f0f0;border-radius:8px;text-align:center;"><i class="fas fa-image"></i><br>${m.name}</div></div>`;
                                    } else if (m.type === 'video') {
                                        return `<div class="media-item"><video src="${m.data}" controls></video></div>`;
                                    } else {
                                        return `<div class="media-item" style="padding:15px;background:#f0f0f0;border-radius:8px;"><i class="fas fa-file"></i> ${m.name}</div>`;
                                    }
                                }));
                                mediaHtml = `<div class="story-media">${mediaItems.join('')}</div>`;
                            }
                            return `<div class="story-item">
                                <button class="delete-story-btn" onclick="deleteStory(${story.id})"><i class="fas fa-trash"></i></button>
                                <div class="story-header" onclick="editStory(${story.id})" style="cursor:pointer;">
                                    <div class="story-title">${story.title}</div>
                                    <div class="story-date">${story.date}</div>
                                </div>
                                <div class="story-content" onclick="editStory(${story.id})" style="cursor:pointer;">${story.content}</div>
                                ${mediaHtml}
                            </div>`;
                        })) : `<div class="no-data">${t.noStories}</div>`}
                    </div>
                    <button class="add-btn" onclick="openStoryModal()"><i class="fas fa-plus"></i> ${t.addStory}</button>
                </div>


                <div class="section">
                    <h2 class="section-title"><i class="fas fa-images"></i> ${t.theirMoments}</h2>
                    
                    <!-- 搜索和排序控件 -->
                    <div class="search-sort-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="moment-search" placeholder="${t.searchMoments}" oninput="filterMoments()">
                        </div>
                        <div class="sort-controls">
                            <button id="moment-sort-toggle" class="sort-toggle-btn" title="切换时间顺序">
                                <i class="fas fa-sort-amount-down"></i>
                                <span class="sort-text">最新在前</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-content" id="moments-container">
                        ${moments.length > 0 ? await Promise.all(moments.map(async moment => {
                            let mediaHtml = '';
                            if (moment.media && moment.media.length > 0) {
                                const mediaItems = await Promise.all(moment.media.map(async m => {
                                    if (m.type === 'image') {
                                        const imageData = await getImageFromIndexedDB(m.data);
                                        return `<div class="media-item"><img src="${imageData}" alt="${m.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div style="display:none;padding:15px;background:#f0f0f0;border-radius:8px;text-align:center;"><i class="fas fa-image"></i><br>${m.name}</div></div>`;
                                    } else if (m.type === 'video') {
                                        return `<div class="media-item"><video src="${m.data}" controls></video></div>`;
                                    }
                                }));
                                mediaHtml = `<div class="story-media">${mediaItems.join('')}</div>`;
                            }
                            return `<div class="moment-item">
                                <button class="delete-story-btn" onclick="deleteMoment(${moment.id})"><i class="fas fa-trash"></i></button>
                                <div onclick="editMoment(${moment.id})" style="cursor:pointer;">
                                    <div class="story-date" style="margin-bottom:10px;">${moment.date}</div>
                                    <div class="story-content">${moment.content}</div>
                                </div>
                                ${mediaHtml}
                            </div>`;
                        })) : `<div class="no-data">${t.noMoments}</div>`}
                    </div>
                    <button class="add-btn" onclick="openMomentModal()"><i class="fas fa-plus"></i> ${t.addMoment}</button>
                </div>

 

                <div class="section">
                    <h2 class="section-title"><i class="fab fa-weixin"></i> ${t.chatHistory}</h2>
                    <div class="section-content">
                        ${chatHistory.length > 0
                            ? chatHistory.map((chat, index) => `
                                <div style="margin-bottom:20px;padding:15px;background:white;border-radius:10px;cursor:pointer;" onclick="editChat(${index})">
                                    <div style="font-weight:bold;color:#666;margin-bottom:10px;">${chat.date}</div>
                                    ${chat.messages.slice(0, 3).map(msg => `
                                        <div style="margin:8px 0;${msg.sender === '我' || msg.sender === 'Me' ? 'text-align:right;' : 'text-align:left;'}">
                                            <div style="display:inline-block;padding:10px 15px;border-radius:10px;max-width:70%;${msg.sender === '我' || msg.sender === 'Me' ? 'background:#95EC69;color:#000;' : 'background:#fff;color:#000;border:1px solid #e0e0e0;'}">
                                                <div style="font-size:0.85rem;opacity:0.7;margin-bottom:3px;">${msg.sender}</div>
                                                <div>${msg.content}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${chat.messages.length > 3 ? `<div style="text-align:center;color:#999;margin-top:10px;">${currentLanguage === 'zh' ? '共' : 'Total'} ${chat.messages.length} ${t.totalMessages}</div>` : ''}
                                </div>
                            `).join('')
                            : `<div class="no-data">${t.noChatHistory}</div>`}
                    </div>
                    <button class="add-btn" onclick="openChatModal()"><i class="fas fa-plus"></i> ${t.importChat}</button>
                </div>
            `;

            // 初始化排序按钮的状态（从currentPerson中读取保存的状态）
            try {
                const storySortBtn = document.getElementById('story-sort-toggle');
                if (storySortBtn) {
                    // 从currentPerson中读取保存的排序状态，默认为'desc'
                    const storySortOrder = currentPerson.storySortOrder || 'desc';
                    storySortBtn.dataset.order = storySortOrder;
                    updateSortButtonText(storySortBtn, storySortOrder);
                }

                const momentSortBtn = document.getElementById('moment-sort-toggle');
                if (momentSortBtn) {
                    // 从currentPerson中读取保存的排序状态，默认为'desc'
                    const momentSortOrder = currentPerson.momentSortOrder || 'desc';
                    momentSortBtn.dataset.order = momentSortOrder;
                    updateSortButtonText(momentSortBtn, momentSortOrder);
                }
            } catch (e) {
                console.error('初始化排序按钮失败:', e);
            }
            
            // 【已删除旧的事件绑定代码，现在使用全局事件委托】
        }
        
        // ========== 简化的排序系统 ==========
        
        // 更新排序按钮文本和图标
        function updateSortButtonText(button, order) {
            const textElement = button.querySelector('.sort-text');
            const iconElement = button.querySelector('i');
            
            if (order === 'desc') {
                textElement.textContent = '最新在前';
                iconElement.className = 'fas fa-sort-amount-down';
                button.classList.remove('ascending');
            } else {
                textElement.textContent = '最早在前';
                iconElement.className = 'fas fa-sort-amount-up';
                button.classList.add('ascending');
            }
        }
        
        // 故事排序切换函数
        function toggleStorySort() {
            console.log('=== 切换故事排序 ===');
            
            if (!currentPerson || !currentPerson.stories || currentPerson.stories.length === 0) {
                console.log('没有故事数据需要排序');
                return;
            }
            
            const sortBtn = document.getElementById('story-sort-toggle');
            if (!sortBtn) {
                console.log('找不到故事排序按钮');
                return;
            }
            
            // 切换排序顺序
            const currentOrder = sortBtn.dataset.order || 'desc';
            const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            sortBtn.dataset.order = newOrder;
            
            // 保存排序状态到currentPerson对象
            currentPerson.storySortOrder = newOrder;
            
            // 更新按钮显示
            updateSortButtonText(sortBtn, newOrder);
            
            // 应用排序
            applyStorySorting(newOrder);
        }
        
        // 朋友圈排序切换函数
        function toggleMomentSort() {
            console.log('=== 切换朋友圈排序 ===');
            
            if (!currentPerson || !currentPerson.moments || currentPerson.moments.length === 0) {
                console.log('没有朋友圈数据需要排序');
                return;
            }
            
            const sortBtn = document.getElementById('moment-sort-toggle');
            if (!sortBtn) {
                console.log('找不到朋友圈排序按钮');
                return;
            }
            
            // 切换排序顺序
            const currentOrder = sortBtn.dataset.order || 'desc';
            const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            sortBtn.dataset.order = newOrder;
            
            // 保存排序状态到currentPerson对象
            currentPerson.momentSortOrder = newOrder;
            
            // 更新按钮显示
            updateSortButtonText(sortBtn, newOrder);
            
            // 应用排序
            applyMomentSorting(newOrder);
        }
        
        // 故事排序应用函数
        function applyStorySorting(order) {
            console.log('应用故事排序，顺序:', order);
            
            let sortedStories = [...currentPerson.stories];
            
            // 按事件发生时间排序
            sortedStories.sort((a, b) => {
                const aDate = new Date(a.date);
                const bDate = new Date(b.date);
                
                if (order === 'desc') {
                    return bDate - aDate; // 降序，最新的在前
                } else {
                    return aDate - bDate; // 升序，最早的在前
                }
            });
            
            // 更新数据
            currentPerson.stories = sortedStories;
            // 保存排序状态
            currentPerson.storySortOrder = order;
            
            // 保存到存储
            const personIndex = people.findIndex(p => p.id === currentPerson.id);
            if (personIndex !== -1) {
                people[personIndex] = currentPerson;
                saveToLocalStorage();
            }
            
            // 重新渲染页面
            renderDetailPage();
            
            console.log('故事排序完成');
        }
        
        // 朋友圈排序应用函数
        function applyMomentSorting(order) {
            console.log('应用朋友圈排序，顺序:', order);
            
            let sortedMoments = [...currentPerson.moments];
            
            // 按事件发生时间排序
            sortedMoments.sort((a, b) => {
                const aDate = new Date(a.date);
                const bDate = new Date(b.date);
                
                if (order === 'desc') {
                    return bDate - aDate; // 降序，最新的在前
                } else {
                    return aDate - bDate; // 升序，最早的在前
                }
            });
            
            // 更新数据
            currentPerson.moments = sortedMoments;
            // 保存排序状态
            currentPerson.momentSortOrder = order;
            
            // 保存到存储
            const personIndex = people.findIndex(p => p.id === currentPerson.id);
            if (personIndex !== -1) {
                people[personIndex] = currentPerson;
                saveToLocalStorage();
            }
            
            // 重新渲染页面
            renderDetailPage();
            
            console.log('朋友圈排序完成');
        }

        // ========== 详情页操作：编辑/删除/打开各模态框 ==========
        function editCurrentPerson() {
            if (!currentPerson) return;
            currentEditId = currentPerson.id;
            croppedImageData = null;
            const modalTitle = document.getElementById('modal-title');
            modalTitle.setAttribute('data-zh', '编辑人物');
            modalTitle.setAttribute('data-en', 'Edit Person');
            modalTitle.textContent = currentLanguage === 'zh' ? '编辑人物' : 'Edit Person';
            // 填充表单
            document.getElementById('person-name').value = currentPerson.name || '';
            document.getElementById('person-profession').value = currentPerson.profession || '';
            document.getElementById('person-location').value = currentPerson.location || '';
            document.getElementById('person-hometown').value = currentPerson.hometown || '';
            document.getElementById('person-birthday').value = currentPerson.birthday || '';
            document.getElementById('person-personality').value = currentPerson.personality || '';
            document.getElementById('person-mbti').value = currentPerson.mbti || '';
            document.getElementById('person-intimacy').value = currentPerson.intimacy || 0;
            updateHeartRating(parseFloat(currentPerson.intimacy) || 0);
            document.getElementById('person-hobbies').value = currentPerson.hobbies || '';
            document.getElementById('person-meettime').value = currentPerson.meetTime || '';
            document.getElementById('person-meetplace').value = currentPerson.meetPlace || '';
            document.getElementById('person-meetreason').value = currentPerson.meetReason || '';
            document.getElementById('person-tags').value = (currentPerson.tags || []).join(',');
            document.getElementById('person-color').value = currentPerson.colorLabel || '';
            document.getElementById('person-phone').value = currentPerson.contact?.phone || '';
            document.getElementById('person-email').value = currentPerson.contact?.email || '';
            document.getElementById('person-wechat-id').value = currentPerson.contact?.wechatId || '';
            // 颜色选择激活
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            const colorValue = currentPerson.colorLabel || '';
            const colorNode = colorValue ? document.querySelector(`.color-option[data-color="${colorValue}"]`) : document.querySelector('.color-option.none');
            if (colorNode) colorNode.classList.add('selected');
            // 头像预览
            updateAvatarPreview(currentPerson.photo || null, currentPerson.name || '?');
            // 显示模态框
            document.getElementById('person-modal').classList.add('active');
            
            // 重新初始化事件监听器
            initHeartRatingEvents();
            initColorPickerEvents();
        }

        function deleteCurrentPerson() {
            if (!currentPerson) return;
            const ok = confirm(currentLanguage === 'zh' ? `确定删除「${currentPerson.name}」吗？` : `Delete "${currentPerson.name}"?`);
            if (!ok) return;
            people = people.filter(p => p.id !== currentPerson.id);
            saveToLocalStorage();
            closeDetailModal();
            renderPeople();
        }

        function openStoryModal() {
            if (!currentPerson) return;
            console.log('📖 打开故事模态框');
            currentEditingStoryId = null;
            (document.getElementById('story-form')).reset();
            
            // 清空已上传文件列表和文件输入框
            document.getElementById('story-uploaded-files').innerHTML = '';
            currentUploadedFiles['story-uploaded-files'] = [];
            console.log('🧹 已清理故事文件列表');
            const fileInput = document.getElementById('story-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
                console.log('🔄 已重置故事文件输入框');
            }
            
            document.getElementById('story-modal').classList.add('active');
            initStoryDragDrop();
        }
        function closeStoryModal() {
            console.log('❌ 关闭故事模态框');
            document.getElementById('story-modal').classList.remove('active');
            
            // 清理文件列表和输入框
            currentUploadedFiles['story-uploaded-files'] = [];
            console.log('🧹 已清理故事文件列表（关闭时）');
            const fileInput = document.getElementById('story-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
                console.log('🔄 已重置故事文件输入框（关闭时）');
            }
        }
        async function editStory(storyId) {
            if (!currentPerson) return;
            const story = (currentPerson.stories || []).find(s => s.id === storyId);
            if (!story) return;
            currentEditingStoryId = storyId;
            document.getElementById('story-date').value = story.date || '';
            document.getElementById('story-title').value = story.title || '';
            document.getElementById('story-content').value = story.content || '';
            
            // 清空并重新显示已上传的文件
            const uploadedFilesContainer = document.getElementById('story-uploaded-files');
            uploadedFilesContainer.innerHTML = '';
            currentUploadedFiles['story-uploaded-files'] = [];
            const fileInput = document.getElementById('story-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
            }
            
            // 显示已有的媒体文件
            if (story.media && story.media.length > 0) {
                for (let media of story.media) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item existing-media';
                    // 确保媒体ID存在，如果不存在则生成一个
                    const mediaId = media.id || `story_${story.id}_${Date.now()}_${Math.random()}`;
                    fileItem.dataset.mediaId = mediaId;
                    fileItem.dataset.originalMediaId = media.id || mediaId; // 保存原始ID用于查找
                    
                    let fileName = media.name || '未知文件';
                    
                    // 根据媒体类型显示缩略图或图标
                    if (media.type === 'image') {
                        const imageData = await getImageFromIndexedDB(media.data);
                    fileItem.innerHTML = `
                            <img src="${imageData}" class="file-thumbnail" alt="${fileName}">
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'story')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (media.type === 'video') {
                        fileItem.innerHTML = `
                            <video src="${media.data}" class="file-thumbnail" muted></video>
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'story')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else {
                        const icon = getFileIcon(media.type);
                        fileItem.innerHTML = `
                            <div class="file-placeholder">
                                <i class="fas ${icon}"></i>
                                <div class="file-name">${fileName}</div>
                        </div>
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'story')">
                                <i class="fas fa-times"></i>
                            </button>
                    `;
                    }
                    uploadedFilesContainer.appendChild(fileItem);
                }
            }
            
            document.getElementById('story-modal').classList.add('active');
            initStoryDragDrop();
        }
        function deleteStory(storyId) {
            if (!currentPerson) return;
            const ok = confirm(currentLanguage === 'zh' ? '确定要删除这条故事吗？此操作不可恢复。' : 'Delete this story? This cannot be undone.');
            if (!ok) return;
            currentPerson.stories = (currentPerson.stories || []).filter(s => s.id !== storyId);
            const idx = people.findIndex(p => p.id === currentPerson.id);
            if (idx !== -1) people[idx] = currentPerson;
            saveToLocalStorage();
            renderDetailPage();
        }

        function openMomentModal() {
            if (!currentPerson) return;
            console.log('💬 打开朋友圈模态框');
            currentEditingMomentId = null;
            (document.getElementById('moment-form')).reset();
            
            // 清空已上传文件列表和文件输入框
            document.getElementById('moment-uploaded-files').innerHTML = '';
            currentUploadedFiles['moment-uploaded-files'] = [];
            console.log('🧹 已清理朋友圈文件列表');
            const fileInput = document.getElementById('moment-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
                console.log('🔄 已重置朋友圈文件输入框');
            }
            
            document.getElementById('moment-modal').classList.add('active');
            initMomentDragDrop();
        }
        function closeMomentModal() {
            console.log('❌ 关闭朋友圈模态框');
            document.getElementById('moment-modal').classList.remove('active');
            
            // 清理文件列表和输入框
            currentUploadedFiles['moment-uploaded-files'] = [];
            console.log('🧹 已清理朋友圈文件列表（关闭时）');
            const fileInput = document.getElementById('moment-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
                console.log('🔄 已重置朋友圈文件输入框（关闭时）');
            }
        }
        async function editMoment(momentId) {
            if (!currentPerson) return;
            const m = (currentPerson.moments || []).find(x => x.id === momentId);
            if (!m) return;
            currentEditingMomentId = momentId;
            document.getElementById('moment-date').value = m.date || '';
            document.getElementById('moment-content').value = m.content || '';
            
            // 清空并重新显示已上传的文件
            const uploadedFilesContainer = document.getElementById('moment-uploaded-files');
            uploadedFilesContainer.innerHTML = '';
            currentUploadedFiles['moment-uploaded-files'] = [];
            const fileInput = document.getElementById('moment-media');
            if (fileInput) {
                fileInput.value = ''; // 重置文件输入框
            }
            
            // 显示已有的媒体文件
            if (m.media && m.media.length > 0) {
                for (let media of m.media) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item existing-media';
                    // 确保媒体ID存在，如果不存在则生成一个
                    const mediaId = media.id || `moment_${m.id}_${Date.now()}_${Math.random()}`;
                    fileItem.dataset.mediaId = mediaId;
                    fileItem.dataset.originalMediaId = media.id || mediaId; // 保存原始ID用于查找
                    
                    let fileName = media.name || '未知文件';
                    
                    // 根据媒体类型显示缩略图或图标
                    if (media.type === 'image') {
                        const imageData = await getImageFromIndexedDB(media.data);
                    fileItem.innerHTML = `
                            <img src="${imageData}" class="file-thumbnail" alt="${fileName}">
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'moment')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else if (media.type === 'video') {
                        fileItem.innerHTML = `
                            <video src="${media.data}" class="file-thumbnail" muted></video>
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'moment')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                    } else {
                        const icon = getFileIcon(media.type);
                        fileItem.innerHTML = `
                            <div class="file-placeholder">
                                <i class="fas ${icon}"></i>
                                <div class="file-name">${fileName}</div>
                        </div>
                            <button type="button" class="remove-file" onclick="removeExistingMedia(this, '${mediaId}', 'moment')">
                                <i class="fas fa-times"></i>
                            </button>
                    `;
                    }
                    uploadedFilesContainer.appendChild(fileItem);
                }
            }
            
            document.getElementById('moment-modal').classList.add('active');
            initMomentDragDrop();
        }
        function deleteMoment(momentId) {
            if (!currentPerson) return;
            const ok = confirm(currentLanguage === 'zh' ? '确定要删除这条朋友圈吗？此操作不可恢复。' : 'Delete this moment? This cannot be undone.');
            if (!ok) return;
            currentPerson.moments = (currentPerson.moments || []).filter(m => m.id !== momentId);
            const idx = people.findIndex(p => p.id === currentPerson.id);
            if (idx !== -1) people[idx] = currentPerson;
            saveToLocalStorage();
            renderDetailPage();
        }

        // ========== 故事搜索和排序功能 ==========
        function filterStories() {
            const searchTerm = document.getElementById('story-search').value.toLowerCase();
            const storyItems = document.querySelectorAll('#stories-container .story-item');
            
            storyItems.forEach(item => {
                const title = item.querySelector('.story-title')?.textContent.toLowerCase() || '';
                const content = item.querySelector('.story-content')?.textContent.toLowerCase() || '';
                const date = item.querySelector('.story-date')?.textContent.toLowerCase() || '';
                
                const matches = title.includes(searchTerm) || content.includes(searchTerm) || date.includes(searchTerm);
                item.style.display = matches ? 'block' : 'none';
            });
            
            // 如果没有搜索结果，显示提示
            const visibleItems = Array.from(storyItems).filter(item => item.style.display !== 'none');
            const container = document.getElementById('stories-container');
            let noResultsMsg = container.querySelector('.no-search-results');
            
            if (visibleItems.length === 0 && searchTerm) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-search-results';
                    noResultsMsg.style.cssText = 'text-align:center;color:#999;padding:20px;font-style:italic;';
                    noResultsMsg.textContent = currentLanguage === 'zh' ? '没有找到匹配的故事' : 'No matching stories found';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // ========== 简化的日期排序系统 ==========
        
        /**
         * 简单的日期解析函数 - 专门处理 HTML input[type="date"] 的格式
         * @param {string} dateStr - 日期字符串 (YYYY-MM-DD 格式)
         * @returns {Date|null} 解析成功的 Date 对象，失败返回 null
         */
        function parseDate(dateStr) {
            if (!dateStr || dateStr === '' || dateStr === null || dateStr === undefined) {
                return null;
            }
            
            // 清理字符串
            const cleanStr = dateStr.toString().trim();
            
            // 直接使用 Date 构造函数解析
            const date = new Date(cleanStr);
            
            // 检查日期是否有效
            if (isNaN(date.getTime())) {
                return null;
            }
            
            return date;
        }
        
        /**
         * 获取日期的时间戳，无效日期返回 0（用于排序时放在最前面）
         * @param {string} dateStr - 日期字符串
         * @returns {number} 时间戳或 0
         */
        function getDateTimestamp(dateStr) {
            const date = parseDate(dateStr);
            return date ? date.getTime() : 0;
        }
        
        /**
         * 调试函数 - 显示排序信息
         * @param {Array} items - 要排序的数组
         * @param {string} sortType - 排序类型
         */
        function debugSort(items, sortType) {
            // 简化调试输出，只在需要时显示
            if (window.debugMode) {
                console.log(`=== 开始排序 (${sortType}) ===`);
                console.log('排序前:', items.map(item => ({ title: item.title, date: item.date })));
                
                items.forEach((item, index) => {
                    const timestamp = getDateTimestamp(item.date);
                    const parsed = parseDate(item.date);
                    console.log(`${index + 1}. ${item.title}: "${item.date}" -> ${parsed ? parsed.toISOString() : 'null'} (${timestamp})`);
                });
            }
        }

        /**
         * 通用的日期排序函数
         * @param {Array} items - 要排序的数组
         * @param {string} dateField - 日期字段名
         * @param {string} sortType - 排序类型：'latest' 或 'earliest'
         * @returns {Array} 排序后的数组
         */
        function sortByDate(items, dateField = 'date', sortType = 'latest') {
            if (!items || items.length === 0) {
                return items;
            }
            
            // 添加调试信息
            debugSort(items, sortType);
            
            // 创建副本进行排序，避免修改原数组
            const sortedItems = [...items].sort((a, b) => {
                const timestampA = getDateTimestamp(a[dateField]);
                const timestampB = getDateTimestamp(b[dateField]);
                
                if (sortType === 'latest') {
                    // 最新在前：大时间戳在前，无效日期（0）在最后
                    return timestampB - timestampA;
                } else {
                    // 最早在前：小时间戳在前，无效日期（0）在最后
                    return timestampA - timestampB;
                }
            });
            
            if (window.debugMode) {
                console.log('排序后:', sortedItems.map(item => ({ title: item.title, date: item.date })));
            }
            return sortedItems;
        }
        
        // 旧的sortStories函数已移除，使用新的applyStorySorting函数

        // ========== 朋友圈搜索和排序功能 ==========
        function filterMoments() {
            const searchTerm = document.getElementById('moment-search').value.toLowerCase();
            const momentItems = document.querySelectorAll('#moments-container .moment-item');
            
            momentItems.forEach(item => {
                const content = item.querySelector('.story-content')?.textContent.toLowerCase() || '';
                const date = item.querySelector('.story-date')?.textContent.toLowerCase() || '';
                
                const matches = content.includes(searchTerm) || date.includes(searchTerm);
                item.style.display = matches ? 'block' : 'none';
            });
            
            // 如果没有搜索结果，显示提示
            const visibleItems = Array.from(momentItems).filter(item => item.style.display !== 'none');
            const container = document.getElementById('moments-container');
            let noResultsMsg = container.querySelector('.no-search-results');
            
            if (visibleItems.length === 0 && searchTerm) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-search-results';
                    noResultsMsg.style.cssText = 'text-align:center;color:#999;padding:20px;font-style:italic;';
                    noResultsMsg.textContent = currentLanguage === 'zh' ? '没有找到匹配的朋友圈' : 'No matching moments found';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // 旧的sortMoments函数已移除，使用新的applyMomentSorting函数
        
        // ========== 日期排序测试和验证功能 ==========
        
        /**
         * 测试日期解析和排序功能
         * 可以在浏览器控制台中调用此函数进行测试
         */
        function testDateSorting() {
            const testData = [
                { title: "Story A", date: "2025-10-06" },
                { title: "Story B", date: "2025-10-07" },
                { title: "Story C", date: "2002-02-22" },
                { title: "Story D", date: "2023-01-01" },
                { title: "Story E", date: "2024-12-31" },
                { title: "Story F", date: "1999-11-11" },
                { title: "Story G", date: "2025/10/05" },
                { title: "Story H", date: "2025年10月04日" },
                { title: "Story I", date: "October 3, 2025" },
                { title: "Story J", date: "2025-09-30T00:00:00Z" },
                { title: "Story K", date: "1900-03-15" },
                { title: "Story L", date: "" },
                { title: "Story M", date: null }
            ];
            
            console.log('=== 日期排序测试 ===');
            console.log('原始数据:', testData);
            
            // 测试最新排序
            const latestSorted = sortByDate([...testData], 'date', 'latest');
            console.log('按时间排序（最新）:', latestSorted.map(item => `${item.title}: ${item.date}`));
            
            // 测试最早排序
            const earliestSorted = sortByDate([...testData], 'date', 'earliest');
            console.log('按时间排序（最早）:', earliestSorted.map(item => `${item.title}: ${item.date}`));
            
            // 测试日期解析
            console.log('=== 日期解析测试 ===');
            testData.forEach(item => {
                const parsed = parseDate(item.date);
                const timestamp = getDateTimestamp(item.date);
                console.log(`${item.title}: "${item.date}" -> ${parsed ? parsed.toISOString() : 'null'} (timestamp: ${timestamp})`);
            });
            
            return {
                original: testData,
                latest: latestSorted,
                earliest: earliestSorted
            };
        }
        
        // 将测试函数暴露到全局作用域，方便在控制台调用
        window.testDateSorting = testDateSorting;
        
        // ========== 排序功能测试和调试 ==========
        
        /**
         * 快速测试排序功能
         */
        function quickTestSort() {
            console.log('=== 快速排序测试 ===');
            
            if (!currentPerson) {
                console.log('错误：请先选择一个人物');
                return;
            }
            
            if (currentPerson.stories && currentPerson.stories.length > 0) {
                console.log('测试故事排序...');
                const testData = currentPerson.stories.slice(0, 3); // 取前3个故事测试
                console.log('测试数据:', testData);
                
                const sorted = sortByDate(testData, 'date', 'latest');
                console.log('排序结果:', sorted);
            } else {
                console.log('没有故事数据可以测试');
            }
            
            if (currentPerson.moments && currentPerson.moments.length > 0) {
                console.log('测试朋友圈排序...');
                const testData = currentPerson.moments.slice(0, 3); // 取前3个朋友圈测试
                console.log('测试数据:', testData);
                
                const sorted = sortByDate(testData, 'date', 'latest');
                console.log('排序结果:', sorted);
            } else {
                console.log('没有朋友圈数据可以测试');
            }
        }
        
        // 暴露到全局作用域
        window.quickTestSort = quickTestSort;
        
        /**
         * 检查排序选择框是否正确绑定
         */
        function checkSortSelectors() {
            console.log('=== 检查排序选择框 ===');
            
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            console.log('故事排序选择框:', storySort);
            console.log('朋友圈排序选择框:', momentSort);
            
            if (storySort) {
                console.log('故事排序选项:', Array.from(storySort.options).map(opt => ({ value: opt.value, text: opt.text })));
                const storyToggle = document.getElementById('story-order-toggle');
                console.log('当前选中值:', storySort.value, '，顺序:', storyToggle ? storyToggle.dataset.order : 'n/a');
            }
            
            if (momentSort) {
                console.log('朋友圈排序选项:', Array.from(momentSort.options).map(opt => ({ value: opt.value, text: opt.text })));
                const momentToggle = document.getElementById('moment-order-toggle');
                console.log('当前选中值:', momentSort.value, '，顺序:', momentToggle ? momentToggle.dataset.order : 'n/a');
            }
        }
        
        // 暴露到全局作用域
        window.checkSortSelectors = checkSortSelectors;
        
        /**
         * 强制刷新排序显示
         */
        function forceRefreshSort() {
            console.log('=== 强制刷新排序显示 ===');
            
            if (!currentPerson) {
                console.log('错误：请先选择一个人物');
                return;
            }
            
            // 获取当前排序选项
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            if (storySort && currentPerson.stories && currentPerson.stories.length > 0) {
                console.log('强制刷新故事排序...');
                // 根据新的选择和切换按钮计算排序
                const storyToggle = document.getElementById('story-order-toggle');
                const storyAsc = storyToggle && storyToggle.dataset && storyToggle.dataset.order === 'asc';
                if (storySort.value === 'added') {
                    currentPerson.stories = [...currentPerson.stories].sort((a,b) => {
                        const aTs = a.createdAt ? Number(a.createdAt) : 0;
                        const bTs = b.createdAt ? Number(b.createdAt) : 0;
                        return storyAsc ? aTs - bTs : bTs - aTs;
                    });
                } else {
                    const sortType = storyAsc ? 'earliest' : 'latest';
                    currentPerson.stories = sortByDate(currentPerson.stories, 'date', sortType);
                }
                
                // 保存数据
                const idx = people.findIndex(p => p.id === currentPerson.id);
                if (idx !== -1) people[idx] = currentPerson;
                saveToLocalStorage();
            }
            
            if (momentSort && currentPerson.moments && currentPerson.moments.length > 0) {
                console.log('强制刷新朋友圈排序...');
                const momentToggle = document.getElementById('moment-order-toggle');
                const momentAsc = momentToggle && momentToggle.dataset && momentToggle.dataset.order === 'asc';
                if (momentSort.value === 'added') {
                    currentPerson.moments = [...currentPerson.moments].sort((a,b) => {
                        const aTs = a.createdAt ? Number(a.createdAt) : 0;
                        const bTs = b.createdAt ? Number(b.createdAt) : 0;
                        return momentAsc ? aTs - bTs : bTs - aTs;
                    });
                } else {
                    const sortType = momentAsc ? 'earliest' : 'latest';
                    currentPerson.moments = sortByDate(currentPerson.moments, 'date', sortType);
                }
                
                // 保存数据
                const idx = people.findIndex(p => p.id === currentPerson.id);
                if (idx !== -1) people[idx] = currentPerson;
                saveToLocalStorage();
            }
            
            // 强制重新渲染
            console.log('强制重新渲染详情页...');
            renderDetailPage();
            console.log('刷新完成！');
        }
        
        // 暴露到全局作用域
        window.forceRefreshSort = forceRefreshSort;
        
        /**
         * 显示当前排序状态
         */
        function showCurrentSortStatus() {
            console.log('=== 当前排序状态 ===');
            
            if (!currentPerson) {
                console.log('错误：请先选择一个人物');
                return;
            }
            
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            const storyToggle = document.getElementById('story-order-toggle');
            console.log('故事排序设置:', storySort ? storySort.value : '未找到选择框', '，顺序:', storyToggle ? storyToggle.dataset.order : 'n/a');
            if (currentPerson.stories && currentPerson.stories.length > 0) {
                console.log('故事列表 (按当前顺序):');
                currentPerson.stories.forEach((story, index) => {
                    console.log(`${index + 1}. ${story.title}: ${story.date}`);
                });
            }
            
            const momentToggle = document.getElementById('moment-order-toggle');
            console.log('朋友圈排序设置:', momentSort ? momentSort.value : '未找到选择框', '，顺序:', momentToggle ? momentToggle.dataset.order : 'n/a');
            if (currentPerson.moments && currentPerson.moments.length > 0) {
                console.log('朋友圈列表 (按当前顺序):');
                currentPerson.moments.forEach((moment, index) => {
                    console.log(`${index + 1}. ${moment.content || '无标题'}: ${moment.date}`);
                });
            }
        }
        
        // 暴露到全局作用域
        window.showCurrentSortStatus = showCurrentSortStatus;
        
        /**
         * 强制重新排序并刷新界面
         */
        function forceReSortAndRefresh() {
            console.log('=== 强制重新排序并刷新 ===');
            
            if (!currentPerson) {
                console.log('错误：请先选择一个人物');
                return;
            }
            
            // 强制重新排序故事
            if (currentPerson.stories && currentPerson.stories.length > 0) {
                const storySort = document.getElementById('story-sort');
                if (storySort) {
                    const storyToggle = document.getElementById('story-order-toggle');
                    const storyAsc = storyToggle && storyToggle.dataset && storyToggle.dataset.order === 'asc';
                    console.log('强制重新排序故事，模式:', storySort.value, '顺序:', storyAsc ? 'asc' : 'desc');

                    if (storySort.value === 'added') {
                        currentPerson.stories = [...currentPerson.stories].sort((a,b) => {
                            const aTs = a.createdAt ? Number(a.createdAt) : 0;
                            const bTs = b.createdAt ? Number(b.createdAt) : 0;
                            return storyAsc ? aTs - bTs : bTs - aTs;
                        });
                    } else {
                        const sortType = storyAsc ? 'earliest' : 'latest';
                        currentPerson.stories = sortByDate(currentPerson.stories, 'date', sortType);
                    }

                    // 保存数据
                    const idx = people.findIndex(p => p.id === currentPerson.id);
                    if (idx !== -1) people[idx] = currentPerson;
                    saveToLocalStorage();

                    console.log('故事排序完成，新顺序:', currentPerson.stories.map(s => `${s.title}: ${s.date}`));
                }
            }
            
            // 强制重新排序朋友圈
            if (currentPerson.moments && currentPerson.moments.length > 0) {
                const momentSort = document.getElementById('moment-sort');
                if (momentSort) {
                    const momentToggle = document.getElementById('moment-order-toggle');
                    const momentAsc = momentToggle && momentToggle.dataset && momentToggle.dataset.order === 'asc';
                    console.log('强制重新排序朋友圈，模式:', momentSort.value, '顺序:', momentAsc ? 'asc' : 'desc');

                    if (momentSort.value === 'added') {
                        currentPerson.moments = [...currentPerson.moments].sort((a,b) => {
                            const aTs = a.createdAt ? Number(a.createdAt) : 0;
                            const bTs = b.createdAt ? Number(b.createdAt) : 0;
                            return momentAsc ? aTs - bTs : bTs - aTs;
                        });
                    } else {
                        const sortType = momentAsc ? 'earliest' : 'latest';
                        currentPerson.moments = sortByDate(currentPerson.moments, 'date', sortType);
                    }

                    // 保存数据
                    const idx = people.findIndex(p => p.id === currentPerson.id);
                    if (idx !== -1) people[idx] = currentPerson;
                    saveToLocalStorage();

                    console.log('朋友圈排序完成，新顺序:', currentPerson.moments.map(m => `${m.content || '无标题'}: ${m.date}`));
                }
            }
            
            // 强制重新渲染整个详情页
            console.log('开始强制重新渲染详情页...');
            
            // 清空当前内容
            const detailContainer = document.getElementById('detail-container');
            if (detailContainer) {
                detailContainer.innerHTML = '<div style="text-align:center;padding:50px;color:#666;">正在重新加载...</div>';
            }
            
            // 延迟一下再渲染，确保DOM更新
            setTimeout(() => {
                console.log('开始渲染详情页...');
                renderDetailPage();
                console.log('详情页渲染完成！');
                
                // 添加成功提示
                const detailContainer = document.getElementById('detail-container');
                if (detailContainer) {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:9999;';
                    successMsg.textContent = '排序已更新！';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 2000);
                }
            }, 100);
        }
        
        // 暴露到全局作用域
        window.forceReSortAndRefresh = forceReSortAndRefresh;
        
        /**
         * 测试选择框事件绑定
         */
        function testSelectEvents() {
            console.log('=== 测试选择框事件绑定 ===');
            
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            console.log('故事排序选择框:', storySort);
            console.log('朋友圈排序选择框:', momentSort);
            
            if (storySort) {
                console.log('故事排序选择框存在，测试点击...');
                storySort.addEventListener('change', function() {
                    console.log('故事排序选择框 change 事件被触发！值:', this.value);
                });
                
                // 模拟点击测试
                console.log('模拟改变故事排序选择框...');
                // 切换为另一种选择：如果当前是 'event' 切换默认选择值并触发 change
                storySort.value = storySort.value === 'event' ? 'added' : 'event';
                storySort.dispatchEvent(new Event('change'));
            } else {
                console.log('错误：找不到故事排序选择框！');
            }
            
            if (momentSort) {
                console.log('朋友圈排序选择框存在，测试点击...');
                momentSort.addEventListener('change', function() {
                    console.log('朋友圈排序选择框 change 事件被触发！值:', this.value);
                });
                
                // 模拟点击测试
                console.log('模拟改变朋友圈排序选择框...');
                momentSort.value = momentSort.value === 'event' ? 'added' : 'event';
                momentSort.dispatchEvent(new Event('change'));
            } else {
                console.log('错误：找不到朋友圈排序选择框！');
            }
        }
        
        // 暴露到全局作用域
        window.testSelectEvents = testSelectEvents;
        
        /**
         * 手动触发排序函数
         */
        function manualTriggerSort() {
            console.log('=== 手动触发排序函数 ===');
            
            console.log('手动调用 sortStories()...');
            sortStories();
            
            console.log('手动调用 sortMoments()...');
            sortMoments();
        }
        
        // 暴露到全局作用域
        window.manualTriggerSort = manualTriggerSort;
        
        /**
         * 检查DOM状态
         */
        function checkDOMState() {
            console.log('=== 检查DOM状态 ===');
            
            console.log('currentPerson:', currentPerson);
            if (currentPerson) {
                console.log('currentPerson.stories:', currentPerson.stories);
                console.log('currentPerson.moments:', currentPerson.moments);
            }
            
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            console.log('story-sort 元素:', storySort);
            console.log('moment-sort 元素:', momentSort);
            
            if (storySort) {
                console.log('story-sort 当前值:', storySort.value);
                console.log('story-sort 选项:', Array.from(storySort.options).map(opt => ({ value: opt.value, text: opt.text })));
            }
            
            if (momentSort) {
                console.log('moment-sort 当前值:', momentSort.value);
                console.log('moment-sort 选项:', Array.from(momentSort.options).map(opt => ({ value: opt.value, text: opt.text })));
            }
            
            const detailContainer = document.getElementById('detail-container');
            console.log('detail-container 元素:', detailContainer);
            
            if (detailContainer) {
                console.log('detail-container 内容长度:', detailContainer.innerHTML.length);
            }
        }
        
        // 暴露到全局作用域
        window.checkDOMState = checkDOMState;
        
        /**
         * 测试排序功能
         */
        function testSortingFunction() {
            console.log('=== 测试排序功能 ===');
            
            if (!currentPerson) {
                console.log('错误：请先选择一个人物');
                return;
            }
            
            const storySort = document.getElementById('story-sort');
            const momentSort = document.getElementById('moment-sort');
            
            if (storySort) {
                console.log('测试故事排序...');
                console.log('当前故事排序选项:', storySort.value);
                console.log('故事数量:', currentPerson.stories ? currentPerson.stories.length : 0);
                
                // 测试切换到按添加顺序
                storySort.value = 'added';
                storySort.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    console.log('按添加顺序排序后:', currentPerson.stories.map(s => `${s.title}: ${s.date} (createdAt:${s.createdAt || 'n/a'})`));
                    
                    // 测试切换到按事件发生顺序
                    storySort.value = 'event';
                    storySort.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        console.log('按事件发生顺序排序后:', currentPerson.stories.map(s => `${s.title}: ${s.date}`));
                    }, 100);
                }, 100);
            }
            
            if (momentSort) {
                console.log('测试朋友圈排序...');
                console.log('当前朋友圈排序选项:', momentSort.value);
                console.log('朋友圈数量:', currentPerson.moments ? currentPerson.moments.length : 0);
                
                // 测试切换到按添加顺序
                momentSort.value = 'added';
                momentSort.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    console.log('按添加顺序排序后:', currentPerson.moments.map(m => `${m.content || '无标题'}: ${m.date} (createdAt:${m.createdAt || 'n/a'})`));
                    
                    // 测试切换到按事件发生顺序
                    momentSort.value = 'event';
                    momentSort.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        console.log('按事件发生顺序排序后:', currentPerson.moments.map(m => `${m.content || '无标题'}: ${m.date}`));
                    }, 100);
                }, 100);
            }
        }
        
        // 暴露到全局作用域
        window.testSortingFunction = testSortingFunction;
        
        /**
         * 测试新的排序功能
         */
        function testNewSorting() {
            console.log('=== 测试新的排序功能 ===');
            
            if (!currentPerson) {
                console.log('请先选择一个人物');
                return;
            }
            
            console.log('当前人物:', currentPerson.name);
            console.log('故事数量:', currentPerson.stories ? currentPerson.stories.length : 0);
            console.log('朋友圈数量:', currentPerson.moments ? currentPerson.moments.length : 0);
            
            // 测试故事排序
            if (currentPerson.stories && currentPerson.stories.length > 0) {
                console.log('测试故事排序...');
                const storySort = document.getElementById('story-sort');
                if (storySort) {
                    console.log('切换到按添加顺序');
                    storySort.value = 'added';
                    storySort.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        console.log('切换到按事件发生顺序');
                        storySort.value = 'event';
                        storySort.dispatchEvent(new Event('change'));
                    }, 1000);
                }
            }
            
            // 测试朋友圈排序
            if (currentPerson.moments && currentPerson.moments.length > 0) {
                console.log('测试朋友圈排序...');
                const momentSort = document.getElementById('moment-sort');
                if (momentSort) {
                    console.log('切换到按添加顺序');
                    momentSort.value = 'added';
                    momentSort.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        console.log('切换到按事件发生顺序');
                        momentSort.value = 'event';
                        momentSort.dispatchEvent(new Event('change'));
                    }, 1000);
                }
            }
        }
        
        // 暴露到全局作用域
        window.testNewSorting = testNewSorting;
        
        /**
         * 测试新的简化排序功能
         */
        function testSimpleSorting() {
            console.log('=== 测试简化排序功能 ===');
            
            if (!currentPerson) {
                console.log('请先选择一个人物');
                return;
            }
            
            console.log('当前人物:', currentPerson.name);
            console.log('故事数量:', currentPerson.stories ? currentPerson.stories.length : 0);
            console.log('朋友圈数量:', currentPerson.moments ? currentPerson.moments.length : 0);
            console.log('当前故事排序状态:', currentPerson.storySortOrder || 'desc');
            console.log('当前朋友圈排序状态:', currentPerson.momentSortOrder || 'desc');
            
            // 测试故事排序连续切换
            if (currentPerson.stories && currentPerson.stories.length > 0) {
                console.log('测试故事排序连续切换...');
                const storyBtn = document.getElementById('story-sort-toggle');
                if (storyBtn) {
                    console.log('当前按钮状态:', storyBtn.dataset.order);
                    
                    // 连续点击5次测试切换功能
                    let clickCount = 0;
                    const clickInterval = setInterval(() => {
                        if (clickCount >= 5) {
                            clearInterval(clickInterval);
                            console.log('故事排序连续切换测试完成');
                            return;
                        }
                        
                        clickCount++;
                        console.log(`第${clickCount}次点击故事排序按钮...`);
                        storyBtn.click();
                    }, 800);
                }
            }
            
            // 测试朋友圈排序连续切换
            if (currentPerson.moments && currentPerson.moments.length > 0) {
                console.log('测试朋友圈排序连续切换...');
                const momentBtn = document.getElementById('moment-sort-toggle');
                if (momentBtn) {
                    console.log('当前按钮状态:', momentBtn.dataset.order);
                    
                    // 连续点击5次测试切换功能
                    let clickCount = 0;
                    const clickInterval = setInterval(() => {
                        if (clickCount >= 5) {
                            clearInterval(clickInterval);
                            console.log('朋友圈排序连续切换测试完成');
                            return;
                        }
                        
                        clickCount++;
                        console.log(`第${clickCount}次点击朋友圈排序按钮...`);
                        momentBtn.click();
                    }, 800);
                }
            }
        }
        
        // 暴露到全局作用域
        window.testSimpleSorting = testSimpleSorting;

        // ========== 删除已上传的媒体文件 ==========
        function removeExistingMedia(buttonElement, mediaId, type) {
            // 阻止事件冒泡，防止触发上传区域的点击事件
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log('删除媒体文件:', mediaId, type);
            
            // 找到文件项并移除
            const fileItem = buttonElement.closest('.file-item');
            if (fileItem) {
                fileItem.remove();
                console.log('已从界面移除文件项');
            }
        }
        
        // ========== 更新文件状态为已保存 ==========
        function updateFileStatesToSaved(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // 找到所有"已上传"的文件项，将其状态改为"已保存"
            const uploadedFiles = container.querySelectorAll('.uploaded-media');
            uploadedFiles.forEach(fileItem => {
                fileItem.classList.remove('uploaded-media');
                fileItem.classList.add('existing-media');
                console.log('文件状态已更新为已保存:', fileItem);
            });
        }
        
        // ========== 拖拽上传功能 ==========
        // 防抖机制变量
        let fileInputTimeout = null;
        let dragDropTimeout = null;
        
        // 全局文件存储，用于保存时获取原始文件对象
        const globalFileStorage = new Map();
        
        // 当前上传的文件列表（按容器ID分组）
        const currentUploadedFiles = {
            'story-uploaded-files': [],
            'moment-uploaded-files': []
        };
        
        // 防止文件选择对话框重复弹出的锁
        let isFileDialogOpen = false;
        let fileDialogLockTimeout = null;
        
        // 🔧 全局阻止浏览器默认的拖拽文件打开行为
        // 在页面其他区域阻止文件拖拽，但不影响上传区域
        document.addEventListener('dragover', (e) => {
            const isInUploadArea = e.target.closest('.upload-area');
            if (!isInUploadArea) {
                e.preventDefault();
            }
        }, false);
        
        document.addEventListener('drop', (e) => {
            // 检查是否在上传区域内
            const isInUploadArea = e.target.closest('.upload-area');
            if (!isInUploadArea) {
                e.preventDefault(); // 只在非上传区域阻止文件打开
                console.log('🚫 阻止在非上传区域打开文件');
            } else {
                console.log('✅ 在上传区域内，允许拖拽');
            }
        }, false);
        
        function initStoryDragDrop() {
            const uploadArea = document.getElementById('story-upload-area');
            const fileInput = document.getElementById('story-media');
            const uploadedFiles = document.getElementById('story-uploaded-files');
            
            if (!uploadArea) {
                console.error('❌ Story上传区域未找到！');
                return;
            }
            
            console.log('🎯 开始初始化Story拖拽功能...', uploadArea);
            
            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', handleUploadAreaClick);
            
            // 文件选择事件
            fileInput.addEventListener('change', handleFileInputChange);
            
            // 🔒 关键修复：监听blur事件来可靠地解锁对话框
            fileInput.addEventListener('blur', () => {
                console.log('📂 文件输入框失去焦点 - 对话框已关闭');
                // 延迟解锁，确保change事件已完全处理完毕
                setTimeout(() => {
                    if (fileDialogLockTimeout) {
                        clearTimeout(fileDialogLockTimeout);
                    }
                    isFileDialogOpen = false;
                    console.log('🔓 延迟解锁（blur后500ms）');
                }, 500);
            });
            
            // 🔧 拖拽事件 - 添加完整的拖拽支持
            uploadArea.addEventListener('dragenter', handleDragEnter);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            function handleUploadAreaClick(e) {
                // 关键修复：如果点击的是删除按钮或其子元素，不触发文件选择
                if (e.target.closest('.remove-file')) {
                    return;
                }
                
                // 🔒 检查对话框锁定状态
                if (isFileDialogOpen) {
                    console.log('⚠️ 文件对话框已打开，忽略重复点击');
                    return;
                }
                
                // 只有点击上传内容区域才触发文件选择
                if (e.target.closest('.upload-content') || e.target === uploadArea) {
                    console.log('🖱️ 点击上传区域，准备打开文件选择');
                    
                    // 🔒 设置锁定
                    isFileDialogOpen = true;
                    console.log('🔒 已锁定文件对话框');
                    
                    // 清除之前的超时
                    if (fileDialogLockTimeout) {
                        clearTimeout(fileDialogLockTimeout);
                    }
                    
                    // 设置自动解锁（5秒后，防止异常情况）
                    fileDialogLockTimeout = setTimeout(() => {
                        isFileDialogOpen = false;
                        console.log('⏰ 自动解锁文件对话框（超时）');
                    }, 5000);
                    
                    fileInput.click();
                }
            }
            
            function handleFileInputChange(e) {
                console.log('===== 文件选择事件触发 =====');
                console.log('文件数量:', e.target.files.length);
                console.log('文件输入框ID:', fileInput.id);
                console.log('容器ID:', uploadedFiles.id);
                
                // ⚠️ 不在这里解锁，等待blur事件来解锁，避免过早解锁导致重复弹窗
                
                if (e.target.files.length === 0) {
                    console.log('⚠️ 警告：没有选择文件（用户取消）');
                    // 用户取消，blur事件会自动解锁
                    return;
                }
                
                handleFiles(e.target.files, uploadedFiles, fileInput);
                console.log('===== 文件选择处理完成 =====');
            }
            
            // 🔧 拖拽进入事件
            function handleDragEnter(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
                console.log('📥 文件拖拽进入Story区域', e.target);
            }
            
            // 🔧 拖拽悬停事件
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            }
            
            // 🔧 拖拽离开事件 - 优化：只在真正离开上传区域时移除样式
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                // 检查是否真的离开了上传区域（而不是移动到子元素）
                const rect = uploadArea.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX >= rect.right ||
                    e.clientY < rect.top || e.clientY >= rect.bottom) {
                    uploadArea.classList.remove('dragover');
                    console.log('📤 文件离开Story拖拽区域');
                }
            }
            
            // 🔧 文件放下事件
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                console.log('===== Story文件拖拽放下事件触发 =====');
                console.log('DataTransfer对象:', e.dataTransfer);
                console.log('拖拽的文件数量:', e.dataTransfer.files.length);
                
                if (e.dataTransfer.files.length === 0) {
                    console.log('⚠️ 警告：没有拖拽文件');
                    return;
                }
                
                console.log('📋 文件列表:', Array.from(e.dataTransfer.files).map(f => f.name));
                
                if (dragDropTimeout) {
                    clearTimeout(dragDropTimeout);
                }
                dragDropTimeout = setTimeout(() => {
                    handleFiles(e.dataTransfer.files, uploadedFiles, fileInput);
                    dragDropTimeout = null;
                    console.log('===== Story拖拽文件处理完成 =====');
                }, 100);
            }
            
            console.log('✅ Story拖拽功能初始化完成！');
        }
        
        function initMomentDragDrop() {
            const uploadArea = document.getElementById('moment-upload-area');
            const fileInput = document.getElementById('moment-media');
            const uploadedFiles = document.getElementById('moment-uploaded-files');
            
            if (!uploadArea) {
                console.error('❌ Moment上传区域未找到！');
                return;
            }
            
            console.log('🎯 开始初始化Moment拖拽功能...', uploadArea);
            
            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', handleUploadAreaClick);
            
            // 文件选择事件
            fileInput.addEventListener('change', handleFileInputChange);
            
            // 🔒 关键修复：监听blur事件来可靠地解锁对话框
            fileInput.addEventListener('blur', () => {
                console.log('📂 文件输入框失去焦点 - 对话框已关闭');
                // 延迟解锁，确保change事件已完全处理完毕
                setTimeout(() => {
                    if (fileDialogLockTimeout) {
                        clearTimeout(fileDialogLockTimeout);
                    }
                    isFileDialogOpen = false;
                    console.log('🔓 延迟解锁（blur后500ms）');
                }, 500);
            });
            
            // 🔧 拖拽事件 - 添加完整的拖拽支持
            uploadArea.addEventListener('dragenter', handleDragEnter);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            function handleUploadAreaClick(e) {
                // 关键修复：如果点击的是删除按钮或其子元素，不触发文件选择
                if (e.target.closest('.remove-file')) {
                    return;
                }
                
                // 🔒 检查对话框锁定状态
                if (isFileDialogOpen) {
                    console.log('⚠️ 文件对话框已打开，忽略重复点击');
                    return;
                }
                
                // 只有点击上传内容区域才触发文件选择
                if (e.target.closest('.upload-content') || e.target === uploadArea) {
                    console.log('🖱️ 点击上传区域，准备打开文件选择');
                    
                    // 🔒 设置锁定
                    isFileDialogOpen = true;
                    console.log('🔒 已锁定文件对话框');
                    
                    // 清除之前的超时
                    if (fileDialogLockTimeout) {
                        clearTimeout(fileDialogLockTimeout);
                    }
                    
                    // 设置自动解锁（5秒后，防止异常情况）
                    fileDialogLockTimeout = setTimeout(() => {
                        isFileDialogOpen = false;
                        console.log('⏰ 自动解锁文件对话框（超时）');
                    }, 5000);
                    
                    fileInput.click();
                }
            }
            
            function handleFileInputChange(e) {
                console.log('===== 文件选择事件触发 =====');
                console.log('文件数量:', e.target.files.length);
                console.log('文件输入框ID:', fileInput.id);
                console.log('容器ID:', uploadedFiles.id);
                
                // ⚠️ 不在这里解锁，等待blur事件来解锁，避免过早解锁导致重复弹窗
                
                if (e.target.files.length === 0) {
                    console.log('⚠️ 警告：没有选择文件（用户取消）');
                    // 用户取消，blur事件会自动解锁
                    return;
                }
                
                handleFiles(e.target.files, uploadedFiles, fileInput);
                console.log('===== 文件选择处理完成 =====');
            }
            
            // 🔧 拖拽进入事件
            function handleDragEnter(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
                console.log('📥 文件拖拽进入Moment区域', e.target);
            }
            
            // 🔧 拖拽悬停事件
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            }
            
            // 🔧 拖拽离开事件 - 优化：只在真正离开上传区域时移除样式
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                // 检查是否真的离开了上传区域（而不是移动到子元素）
                const rect = uploadArea.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX >= rect.right ||
                    e.clientY < rect.top || e.clientY >= rect.bottom) {
                    uploadArea.classList.remove('dragover');
                    console.log('📤 文件离开Moment拖拽区域');
                }
            }
            
            // 🔧 文件放下事件
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                console.log('===== Moment文件拖拽放下事件触发 =====');
                console.log('DataTransfer对象:', e.dataTransfer);
                console.log('拖拽的文件数量:', e.dataTransfer.files.length);
                
                if (e.dataTransfer.files.length === 0) {
                    console.log('⚠️ 警告：没有拖拽文件');
                    return;
                }
                
                console.log('📋 文件列表:', Array.from(e.dataTransfer.files).map(f => f.name));
                
                if (dragDropTimeout) {
                    clearTimeout(dragDropTimeout);
                }
                dragDropTimeout = setTimeout(() => {
                    handleFiles(e.dataTransfer.files, uploadedFiles, fileInput);
                    dragDropTimeout = null;
                    console.log('===== Moment拖拽文件处理完成 =====');
                }, 100);
            }
            
            console.log('✅ Moment拖拽功能初始化完成！');
        }
        
        function handleFiles(files, uploadedFilesContainer, fileInput) {
            console.log('===== handleFiles 被调用 =====');
            console.log('文件数量:', files.length);
            console.log('容器ID:', uploadedFilesContainer.id);
            console.log('文件输入框ID:', fileInput.id);
            
            const containerId = uploadedFilesContainer.id;
            const existingMediaCount = uploadedFilesContainer.querySelectorAll('.existing-media').length;
            const currentUploadedCount = currentUploadedFiles[containerId] ? currentUploadedFiles[containerId].length : 0;
            const totalCount = existingMediaCount + currentUploadedCount + files.length;
            
            console.log('文件统计 - 已存在:', existingMediaCount, '当前已上传:', currentUploadedCount, '新文件:', files.length, '总计:', totalCount);
            
            // 检查总数是否超过9个
            if (totalCount > 9) {
                const remainingSlots = 9 - existingMediaCount - currentUploadedCount;
                if (remainingSlots <= 0) {
                    alert(currentLanguage === 'zh' ? '已达到最大文件数量限制(9个)' : 'Maximum file limit reached (9 files)');
                } else {
                    alert(currentLanguage === 'zh' ? `最多还能添加${remainingSlots}个文件` : `Maximum ${remainingSlots} more files allowed`);
                }
                return;
            }
            
            // 初始化当前容器的文件数组
            if (!currentUploadedFiles[containerId]) {
                currentUploadedFiles[containerId] = [];
            }
            
            Array.from(files).forEach(file => {
                console.log('处理文件:', file.name, '类型:', file.type, '大小:', file.size);
                
                // 检查文件类型
                const isValidType = file.type.startsWith('image/') || 
                                  file.type.startsWith('video/') || 
                                  file.type === 'application/pdf' ||
                                  file.type.includes('document');
                
                if (!isValidType) {
                    console.log('文件类型不支持:', file.type);
                    alert(currentLanguage === 'zh' ? '不支持的文件类型' : 'Unsupported file type');
                    return;
                }
                
                // 检查文件大小 (限制为10MB)
                if (file.size > 10 * 1024 * 1024) {
                    console.log('文件大小超限:', file.size);
                    alert(currentLanguage === 'zh' ? '文件大小不能超过10MB' : 'File size cannot exceed 10MB');
                    return;
                }
                
                // 检查是否已存在同名文件
                const existingFileNames = currentUploadedFiles[containerId].map(f => f.name);
                if (existingFileNames.includes(file.name)) {
                    console.log('跳过重复文件:', file.name);
                    return;
                }
                
                console.log('✅ 文件通过重复检测，开始处理:', file.name);
                
                // 将文件添加到当前容器的文件列表
                currentUploadedFiles[containerId].push(file);
                console.log('📁 文件已添加到数组，当前容器文件数:', currentUploadedFiles[containerId].length);
                
                // 创建文件项显示
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item uploaded-media';
                fileItem.dataset.fileName = file.name;
                
                // 为图片和视频生成缩略图
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        fileItem.innerHTML = `
                            <img src="${e.target.result}" class="file-thumbnail" alt="${file.name}">
                            <button type="button" class="remove-file" onclick="removeUploadedFile(this, '${file.name}', '${containerId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        uploadedFilesContainer.appendChild(fileItem);
                        console.log('🖼️ 图片文件已添加到界面:', file.name);
                        console.log('当前界面显示的文件数:', uploadedFilesContainer.querySelectorAll('.file-item').length);
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('video/')) {
                    const videoURL = URL.createObjectURL(file);
                    fileItem.innerHTML = `
                        <video src="${videoURL}" class="file-thumbnail" muted></video>
                        <button type="button" class="remove-file" onclick="removeUploadedFile(this, '${file.name}', '${containerId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    uploadedFilesContainer.appendChild(fileItem);
                    console.log('🎬 视频文件已添加到界面:', file.name);
                    console.log('当前界面显示的文件数:', uploadedFilesContainer.querySelectorAll('.file-item').length);
                } else {
                    const icon = getFileIcon(file.type);
                    fileItem.innerHTML = `
                        <div class="file-placeholder">
                            <i class="fas ${icon}"></i>
                            <div class="file-name">${file.name}</div>
                        </div>
                        <button type="button" class="remove-file" onclick="removeUploadedFile(this, '${file.name}', '${containerId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    uploadedFilesContainer.appendChild(fileItem);
                    console.log('📄 其他文件已添加到界面:', file.name);
                    console.log('当前界面显示的文件数:', uploadedFilesContainer.querySelectorAll('.file-item').length);
                }
            });
            
            console.log('文件处理完成，当前容器文件数量:', currentUploadedFiles[containerId].length);
        }
        
        // 防抖机制，避免重复弹窗
        let removeMediaTimeout = null;
        
        function removeExistingMedia(button, mediaId, type) {
            if (removeMediaTimeout) {
                clearTimeout(removeMediaTimeout);
            }
            
            removeMediaTimeout = setTimeout(() => {
            const fileItem = button.closest('.file-item');
                if (fileItem && confirm(currentLanguage === 'zh' ? '确定要删除这个文件吗？' : 'Are you sure you want to remove this file?')) {
            fileItem.remove();
                }
                removeMediaTimeout = null;
            }, 100);
        }
        
        function removeUploadedFile(button, fileName, containerId) {
            const fileItem = button.parentElement;
            
            // 从当前容器的文件列表中删除
            if (currentUploadedFiles[containerId]) {
                const index = currentUploadedFiles[containerId].findIndex(f => f.name === fileName);
                if (index !== -1) {
                    currentUploadedFiles[containerId].splice(index, 1);
                    console.log('已从文件列表中删除:', fileName);
                }
            }
            
            // 移除DOM元素
            fileItem.remove();
        }
        
        function removeFile(button, fileName, inputId) {
            const fileItem = button.parentElement;
            const fileId = fileItem.dataset.fileId;
            
            // 从全局存储中删除文件
            if (fileId && globalFileStorage.has(fileId)) {
                globalFileStorage.delete(fileId);
                console.log('已从全局存储中删除文件:', fileName);
            }
            
            // 移除DOM元素
            fileItem.remove();
        }
        
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'fa-image';
            if (fileType.startsWith('video/')) return 'fa-video';
            if (fileType === 'application/pdf') return 'fa-file-pdf';
            if (fileType.includes('document')) return 'fa-file-word';
            return 'fa-file';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openChatModal() {
            if (!currentPerson) return;
            currentEditingChatIndex = null;
            (document.getElementById('chat-form')).reset();
            document.getElementById('chat-modal').classList.add('active');
        }
        function closeChatModal() {
            document.getElementById('chat-modal').classList.remove('active');
        }
        function editChat(index) {
            if (!currentPerson) return;
            const chat = (currentPerson.chatHistory || [])[index];
            if (!chat) return;
            currentEditingChatIndex = index;
            document.getElementById('chat-date').value = chat.date || '';
            document.getElementById('chat-content').value = chat.messages.map(m => `${m.sender}: ${m.content}`).join('\n');
            document.getElementById('chat-modal').classList.add('active');
        }

        // ========== 学习点双击编辑 ==========
        function enableLearnPointsEdit() {
            if (!currentPerson) return;
            const container = document.getElementById('learnpoints-section');
            const existing = currentPerson.learnPoints || '';
            container.innerHTML = `<textarea id="learnpoints-editor" style="width:100%;min-height:140px;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;line-height:1.8;">${existing.replace(/</g,'&lt;')}</textarea>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                    <div style="color:#999;font-size:0.9rem;">${currentLanguage==='zh'?'Ctrl/⌘+Enter 保存，Esc 取消':'Ctrl/⌘+Enter to save, Esc to cancel'}</div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="saveLearnPoints()" style="padding:8px 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;">${currentLanguage==='zh'?'保存':'Save'}</button>
                        <button onclick="cancelLearnPointsEdit()" style="padding:8px 20px;background:#f0f0f0;color:#666;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;">${currentLanguage==='zh'?'取消':'Cancel'}</button>
                    </div>
                </div>`;
            const editor = document.getElementById('learnpoints-editor');
            editor.focus();
            const save = () => {
                currentPerson.learnPoints = editor.value.trim();
                const idx = people.findIndex(p => p.id === currentPerson.id);
                if (idx !== -1) people[idx] = currentPerson;
                saveToLocalStorage();
                renderDetailPage();
            };
            editor.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelLearnPointsEdit();
                }
            });
            // 移除失焦自动保存，改为手动保存
        }

        async function saveLearnPoints() {
            const editor = document.getElementById('learnpoints-editor');
            if (!editor) return;
            if (!currentPerson) return;
            currentPerson.learnPoints = editor.value.trim();
            const idx = people.findIndex(p => p.id === currentPerson.id);
            if (idx !== -1) people[idx] = currentPerson;
            await saveToLocalStorage();
            renderDetailPage();
        }

        function cancelLearnPointsEdit() {
            renderDetailPage();
        }


        
        

        
        async function saveMoment(e) {
            e.preventDefault();
            const uploadedFilesContainer = document.getElementById('moment-uploaded-files');
            const mediaArray = [];
            
            // 处理已存在的媒体文件（未删除的）
            const existingMediaItems = uploadedFilesContainer.querySelectorAll('.existing-media');
            for (let item of existingMediaItems) {
                const originalMediaId = item.dataset.originalMediaId || item.dataset.mediaId;
                // 从当前朋友圈中查找对应的媒体文件
                if (currentEditingMomentId) {
                    const moment = (currentPerson.moments || []).find(m => m.id === currentEditingMomentId);
                    if (moment && moment.media) {
                        // 尝试多种匹配方式
                        let existingMedia = moment.media.find(m => m.id == originalMediaId);
                        if (!existingMedia) {
                            existingMedia = moment.media.find(m => m.id === originalMediaId);
                        }
                        if (!existingMedia) {
                            // 如果ID不匹配，尝试按顺序匹配
                            const itemIndex = Array.from(existingMediaItems).indexOf(item);
                            if (itemIndex < moment.media.length) {
                                existingMedia = moment.media[itemIndex];
                            }
                        }
                        if (existingMedia) {
                            mediaArray.push(existingMedia);
                        }
                    }
                }
            }
            
            // 处理新上传的文件（从currentUploadedFiles获取）
            const containerId = uploadedFilesContainer.id;
            const uploadedFiles = currentUploadedFiles[containerId] || [];
            
            console.log('===== 保存朋友圈：检查新上传的文件 =====');
            console.log('容器ID:', containerId);
            console.log('新上传文件数量:', uploadedFiles.length);
            console.log('文件列表:', uploadedFiles.map(f => f.name));
            
            if (uploadedFiles.length > 0) {
                console.log('开始处理新上传的朋友圈文件...');
                
                // 使用原始文件对象进行处理
                const processFile = async (file) => {
                    if (file.type.startsWith('image/')) {
                        try {
                            // 使用新的压缩函数
                            const compressedDataUrl = await compressImage(file, 1200, 0.8);
                            const storedImageUrl = await saveImageToIndexedDB(compressedDataUrl, currentPerson.id, file.name);
                            return { type: 'image', name: file.name, data: storedImageUrl, id: Date.now() + Math.random() };
                        } catch (error) {
                            console.error('图片处理失败:', error);
                            return { type: 'image', name: file.name, data: '', id: Date.now() + Math.random() };
                        }
                    } else if (file.type.startsWith('video/')) {
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = (event) => {
                                resolve({ type: 'video', name: file.name, data: event.target.result, id: Date.now() + Math.random() });
                            };
                            reader.readAsDataURL(file);
                        });
                    } else {
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = (event) => {
                                resolve({ type: 'file', name: file.name, data: event.target.result, id: Date.now() + Math.random() });
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                };
                
                try {
                    const promises = uploadedFiles.map(processFile);
                    const results = await Promise.all(promises);
                    mediaArray.push(...results);
                    console.log('新上传朋友圈文件已添加到媒体数组:', results.length);
                } catch (error) {
                    console.error('文件处理失败:', error);
                }
            }
            
            saveMomentData(mediaArray);
        }

        async function saveMomentData(mediaArray) {
            const now = Date.now();
            const moment = {
                id: currentEditingMomentId || Date.now(),
                date: document.getElementById('moment-date').value,
                content: document.getElementById('moment-content').value.trim(),
                media: mediaArray,
                createdAt: currentEditingMomentId ? (currentPerson.moments?.find(m => m.id === currentEditingMomentId)?.createdAt || now) : now,
                updatedAt: now
            };
            if (!currentPerson.moments) currentPerson.moments = [];
            if (currentEditingMomentId) {
                const index = currentPerson.moments.findIndex(m => m.id === currentEditingMomentId);
                if (index !== -1) currentPerson.moments[index] = moment;
            } else {
                currentPerson.moments.push(moment);
            }
            const personIndex = people.findIndex(p => p.id === currentPerson.id);
            if (personIndex !== -1) {
                people[personIndex] = currentPerson;
            }
            await saveToLocalStorage();
            
            // 更新文件状态：将"已上传"改为"已保存"
            updateFileStatesToSaved('moment-uploaded-files');
            
            // 清理当前上传的文件列表
            currentUploadedFiles['moment-uploaded-files'] = [];
            
            closeMomentModal();
            
            // 重新渲染详情页以显示新内容
            setTimeout(() => {
                renderDetailPage();
            }, 100);
        }

        async function saveStory(e) {
            e.preventDefault();
            const fileInput = document.getElementById('story-media');
            const uploadedFilesContainer = document.getElementById('story-uploaded-files');
            const mediaArray = [];
            
            // 处理已存在的媒体文件（未删除的）
            const existingMediaItems = uploadedFilesContainer.querySelectorAll('.existing-media');
            for (let item of existingMediaItems) {
                const originalMediaId = item.dataset.originalMediaId || item.dataset.mediaId;
                // 从当前故事中查找对应的媒体文件
                if (currentEditingStoryId) {
                    const story = (currentPerson.stories || []).find(s => s.id === currentEditingStoryId);
                    if (story && story.media) {
                        // 尝试多种匹配方式
                        let existingMedia = story.media.find(m => m.id == originalMediaId);
                        if (!existingMedia) {
                            existingMedia = story.media.find(m => m.id === originalMediaId);
                        }
                        if (!existingMedia) {
                            // 如果ID不匹配，尝试按顺序匹配
                            const itemIndex = Array.from(existingMediaItems).indexOf(item);
                            if (itemIndex < story.media.length) {
                                existingMedia = story.media[itemIndex];
                            }
                        }
                        if (existingMedia) {
                            mediaArray.push(existingMedia);
                        }
                    }
                }
            }
            
            // 处理新上传的文件（从currentUploadedFiles获取）
            const containerId = uploadedFilesContainer.id;
            const uploadedFiles = currentUploadedFiles[containerId] || [];
            
            console.log('===== 保存：检查新上传的文件 =====');
            console.log('容器ID:', containerId);
            console.log('新上传文件数量:', uploadedFiles.length);
            console.log('文件列表:', uploadedFiles.map(f => f.name));
            
            if (uploadedFiles.length > 0) {
                console.log('开始处理新上传的文件...');
                
                // 使用原始文件对象进行处理
                const processFile = async (file) => {
                    if (file.type.startsWith('image/')) {
                        try {
                            // 使用新的压缩函数
                            const compressedDataUrl = await compressImage(file, 1200, 0.8);
                            const storedImageUrl = await saveImageToIndexedDB(compressedDataUrl, currentPerson.id, file.name);
                            return { type: 'image', name: file.name, data: storedImageUrl, id: Date.now() + Math.random() };
                        } catch (error) {
                            console.error('图片处理失败:', error);
                            return { type: 'image', name: file.name, data: '', id: Date.now() + Math.random() };
                        }
                    } else if (file.type.startsWith('video/')) {
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = (event) => {
                                resolve({ type: 'video', name: file.name, data: event.target.result, id: Date.now() + Math.random() });
                            };
                            reader.readAsDataURL(file);
                        });
                    } else {
                        const reader = new FileReader();
                        return new Promise((resolve) => {
                            reader.onload = (event) => {
                                resolve({ type: 'file', name: file.name, data: event.target.result, id: Date.now() + Math.random() });
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                };
                
                try {
                    const promises = uploadedFiles.map(processFile);
                    const results = await Promise.all(promises);
                    mediaArray.push(...results);
                    console.log('新上传文件已添加到媒体数组:', results.length);
                } catch (error) {
                    console.error('文件处理失败:', error);
                }
            }
            
            saveStoryData(mediaArray);
        }

        async function saveStoryData(mediaArray) {
            const now = Date.now();
            const story = {
                id: currentEditingStoryId || Date.now(),
                date: document.getElementById('story-date').value,
                title: document.getElementById('story-title').value.trim(),
                content: document.getElementById('story-content').value.trim(),
                media: mediaArray,
                createdAt: currentEditingStoryId ? (currentPerson.stories?.find(s => s.id === currentEditingStoryId)?.createdAt || now) : now,
                updatedAt: now
            };
            if (!currentPerson.stories) currentPerson.stories = [];
            if (currentEditingStoryId) {
                const index = currentPerson.stories.findIndex(s => s.id === currentEditingStoryId);
                if (index !== -1) currentPerson.stories[index] = story;
            } else {
                currentPerson.stories.push(story);
            }
            const personIndex = people.findIndex(p => p.id === currentPerson.id);
            if (personIndex !== -1) {
                people[personIndex] = currentPerson;
            }
            await saveToLocalStorage();
            
            // 更新文件状态：将"已上传"改为"已保存"
            updateFileStatesToSaved('story-uploaded-files');
            
            // 清理当前上传的文件列表
            currentUploadedFiles['story-uploaded-files'] = [];
            
            closeStoryModal();
            
            // 重新渲染详情页以显示新内容
            setTimeout(() => {
                renderDetailPage();
            }, 100);
        }

        function saveChat(e) {
            e.preventDefault();
            const messages = document.getElementById('chat-content').value.trim().split('\n').map(line => {
                const [sender, ...contentParts] = line.split(':');
                const content = contentParts.join(':').trim();
                return { sender: sender.trim(), content: content };
            }).filter(msg => msg.sender && msg.content);

            const chat = {
                id: currentEditingChatIndex !== null ? currentPerson.chatHistory[currentEditingChatIndex].id : Date.now(),
                date: document.getElementById('chat-date').value,
                messages: messages
            };

            if (!currentPerson.chatHistory) currentPerson.chatHistory = [];
            if (currentEditingChatIndex !== null) {
                const index = currentPerson.chatHistory.findIndex(c => c.id === chat.id);
                if (index !== -1) currentPerson.chatHistory[index] = chat;
            } else {
                currentPerson.chatHistory.push(chat);
            }

            const personIndex = people.findIndex(p => p.id === currentPerson.id);
            if (personIndex !== -1) {
                people[personIndex] = currentPerson;
            }
            saveToLocalStorage();
            closeChatModal();
            setTimeout(() => {
                renderDetailPage();
            }, 100);
        }

        function loadChatFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                const messages = lines.map(line => {
                    const [sender, ...contentParts] = line.split(':');
                    const content = contentParts.join(':').trim();
                    return { sender: sender.trim(), content: content };
                });
                document.getElementById('chat-content').value = messages.map(msg => `${msg.sender}: ${msg.content}`).join('\n');
            };
            reader.readAsText(file);
        }

        // ========== 导出/导入JSON功能 ==========
        function exportData() {
            if (people.length === 0) {
                const msg = currentLanguage === 'zh' ? '当前没有数据可以导出！' : 'No data to export!';
                alert(msg);
                return;
            }
            const dataStr = JSON.stringify(people, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const now = new Date();
            const fileName = currentLanguage === 'zh'
                ? `人际关系数据_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`
                : `Lumina_Encounters_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            localStorage.setItem('lastBackupTime', new Date().getTime().toString());
            const successMsg = currentLanguage === 'zh' 
                ? `数据导出成功！\n共导出 ${people.length} 条记录\n\n文件名：${fileName}`
                : `Data exported successfully!\nTotal ${people.length} records\n\nFilename: ${fileName}`;
            alert(successMsg);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                const msg = currentLanguage === 'zh' ? '请选择JSON格式的文件！' : 'Please select a JSON file!';
                alert(msg);
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        const msg = currentLanguage === 'zh' 
                            ? '文件格式错误！请确保是通过"导出备份"功能导出的文件。'
                            : 'File format error! Please ensure it is a file exported through the "Export Backup" function.';
                        alert(msg);
                        event.target.value = '';
                        return;
                    }
                    
                    const confirmMsg = currentLanguage === 'zh'
                        ? `检测到 ${importedData.length} 条记录\n当前有 ${people.length} 条记录\n\n【确定】= 覆盖当前所有数据\n【取消】= 取消导入`
                        : `Detected ${importedData.length} records\nCurrently ${people.length} records\n\n[OK] = Overwrite all current data\n[Cancel] = Cancel import`;
                    
                    if (confirm(confirmMsg)) {
                        // 重要：直接赋值并立即保存
                        people = importedData;
                        
                        // 立即保存到localStorage
                        try {
                            localStorage.setItem('peopleData', JSON.stringify(people));
                            console.log('✓ 数据已保存到localStorage:', people.length, '条记录');
                            
                            // 验证保存是否成功
                            const verified = localStorage.getItem('peopleData');
                            if (verified) {
                                const verifiedData = JSON.parse(verified);
                                console.log('✓ 验证成功，localStorage中有', verifiedData.length, '条记录');
                            }
                        } catch (saveError) {
                            console.error('保存失败:', saveError);
                            const errorMsg = currentLanguage === 'zh'
                                ? `保存失败！可能是浏览器存储空间不足。\n\n错误信息：${saveError.message}`
                                : `Save failed! Browser storage may be full.\n\nError: ${saveError.message}`;
                            alert(errorMsg);
                            event.target.value = '';
                            return;
                        }
                        
                        // 刷新显示
                        renderPeople();
                        
                        const successMsg = currentLanguage === 'zh'
                            ? `✓ 导入成功！\n共导入 ${people.length} 条记录\n\n数据已保存到浏览器，下次访问时会自动加载。`
                            : `✓ Import successful!\nTotal ${people.length} records imported\n\nData saved to browser and will load automatically next time.`;
                        alert(successMsg);
                    }
                } catch (error) {
                    console.error('导入错误:', error);
                    const errorMsg = currentLanguage === 'zh'
                        ? `文件解析失败！\n\n错误信息：${error.message}`
                        : `File parsing failed!\n\nError: ${error.message}`;
                    alert(errorMsg);
                }
                
                // 清空文件选择，允许重复导入同一文件
                event.target.value = '';
            };
            
            reader.onerror = (error) => {
                console.error('文件读取错误:', error);
                const errorMsg = currentLanguage === 'zh'
                    ? '文件读取失败！请重试。'
                    : 'Failed to read file! Please try again.';
                alert(errorMsg);
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }  


        // ========== 自动备份功能 ==========
        let autoBackupTimer = null;

        function openBackupSettings() {
            const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
            const interval = localStorage.getItem('autoBackupInterval') || '24';
            document.getElementById('auto-backup-enabled').checked = enabled;
            document.getElementById('backup-interval').value = interval;
            document.getElementById('backup-interval-group').style.display = enabled ? 'block' : 'none';
            updateBackupStatus();
            document.getElementById('backup-settings-modal').classList.add('active');
        }

        function closeBackupSettings() {
            document.getElementById('backup-settings-modal').classList.remove('active');
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('auto-backup-enabled').checked;
            localStorage.setItem('autoBackupEnabled', enabled.toString());
            document.getElementById('backup-interval-group').style.display = enabled ? 'block' : 'none';
            if (enabled) {
                startAutoBackup();
            } else {
                stopAutoBackup();
            }
            updateBackupStatus();
        }

        function updateBackupInterval() {
            const interval = document.getElementById('backup-interval').value;
            localStorage.setItem('autoBackupInterval', interval);
            const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
            if (enabled) {
                stopAutoBackup();
                startAutoBackup();
            }
            updateBackupStatus();
        }

        function updateBackupStatus() {
            const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
            const interval = localStorage.getItem('autoBackupInterval') || '24';
            const lastBackup = localStorage.getItem('lastBackupTime');
            const statusText = document.getElementById('backup-status-text');
            const lastBackupText = document.getElementById('last-backup-time');
            
            if (enabled) {
                if (currentLanguage === 'zh') {
                    statusText.textContent = `已启用（每${interval}小时备份一次）`;
                } else {
                    statusText.textContent = `Enabled (Backup every ${interval} hours)`;
                }
                statusText.style.color = '#4CAF50';
            } else {
                statusText.textContent = currentLanguage === 'zh' ? '未启用' : 'Disabled';
                statusText.style.color = '#999';
            }
            
            if (lastBackup) {
                const lastDate = new Date(parseInt(lastBackup));
                const year = lastDate.getFullYear();
                const month = String(lastDate.getMonth() + 1).padStart(2, '0');
                const day = String(lastDate.getDate()).padStart(2, '0');
                const hours = String(lastDate.getHours()).padStart(2, '0');
                const minutes = String(lastDate.getMinutes()).padStart(2, '0');
                lastBackupText.textContent = `${year}-${month}-${day} ${hours}:${minutes}`;
            } else {
                lastBackupText.textContent = currentLanguage === 'zh' ? '从未备份' : 'Never';
            }
        }

        function startAutoBackup() {
            autoBackupTimer = setInterval(() => {
                const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
                if (!enabled || people.length === 0) return;
                const interval = parseInt(localStorage.getItem('autoBackupInterval') || '24');
                const lastBackup = localStorage.getItem('lastBackupTime');
                const now = new Date().getTime();
                const intervalMs = interval * 60 * 60 * 1000;
                if (!lastBackup || now - parseInt(lastBackup) >= intervalMs) {
                    exportData();
                }
            }, 60000);
        }

        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
        }

        function initAutoBackup() {
            const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
            if (enabled) {
                startAutoBackup();
            }
        }

        // ========== 使用指南功能 ==========
        function openGuide() {
            document.getElementById('guide-modal').classList.add('active');
        }

        function closeGuide() {
            document.getElementById('guide-modal').classList.remove('active');
            localStorage.setItem('guideShown', 'true');
        }

        // 首次访问自动显示使用指南
        window.addEventListener('load', () => {
            // 仅在已选择语言后才弹出使用指南
            if (localStorage.getItem('language') === 'zh' || localStorage.getItem('language') === 'en') {
                const hasShownGuide = localStorage.getItem('guideShown');
                if (!hasShownGuide) {
                    setTimeout(() => {
                        openGuide();
                    }, 800);
                }
            }
        });




        // ========== PDF导出功能 ==========
        // 智能分页容器创建函数
        function createSmartPaginationContainers(items, title, itemRenderer) {
            const containers = [];
            const maxPageHeight = 900; // A4页面可用高度（减去padding）
            const titleHeight = 60; // 标题高度
            const itemSpacing = 25; // 卡片间距
            
            // 智能分组：计算每页能放多少个卡片
            let currentPageItems = [];
            let currentPageHeight = titleHeight; // 第一页包含标题
            let isFirstPage = true;
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const itemHTML = itemRenderer(item);
                
                // 估算卡片高度（根据内容复杂度）
                let estimatedHeight = 150; // 基础高度
                
                // 如果有图片，增加高度
                if (item.media && item.media.length > 0) {
                    const imageCount = Math.min(item.media.filter(m => m.type === 'image').length, 9);
                    const imageRows = Math.ceil(imageCount / 3);
                    estimatedHeight += imageRows * 120 + 20; // 每行图片约120px
                }
                
                // 如果有长文本，增加高度
                if (item.content && item.content.length > 100) {
                    estimatedHeight += Math.ceil(item.content.length / 50) * 20; // 每50字符约20px
                }
                
                // 检查是否超过页面高度
                if (currentPageHeight + estimatedHeight + itemSpacing > maxPageHeight && currentPageItems.length > 0) {
                    // 创建当前页的容器
                    const pageContainer = document.createElement('div');
                    pageContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;min-height:1123px;';
                    pageContainer.className = 'pdf-container';
                    
                    // 如果是第一页，添加标题
                    if (isFirstPage) {
                        pageContainer.innerHTML = `<h2 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">${title}</h2>` + currentPageItems.join('');
                        isFirstPage = false;
                    } else {
                        pageContainer.innerHTML = currentPageItems.join('');
                    }
                    containers.push(pageContainer);
                    
                    // 开始新页
                    currentPageItems = [itemHTML];
                    currentPageHeight = estimatedHeight + itemSpacing;
                } else {
                    // 添加到当前页
                    currentPageItems.push(itemHTML);
                    currentPageHeight += estimatedHeight + itemSpacing;
                }
            }
            
            // 添加最后一页
            if (currentPageItems.length > 0) {
                const pageContainer = document.createElement('div');
                pageContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;min-height:1123px;';
                pageContainer.className = 'pdf-container';
                
                // 如果是第一页，添加标题
                if (isFirstPage) {
                    pageContainer.innerHTML = `<h2 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">${title}</h2>` + currentPageItems.join('');
                } else {
                    pageContainer.innerHTML = currentPageItems.join('');
                }
                containers.push(pageContainer);
            }
            
            return containers;
        }

        async function exportPersonToPDF(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) {
                alert('找不到该人物信息！');
                return;
            }
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:30px 50px;border-radius:15px;z-index:9999;font-size:1.2rem;';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成PDF，请稍候...';
            document.body.appendChild(loadingDiv);
            try {
                // 预处理所有图片数据
                console.log('开始预处理图片数据...');
                await preprocessImagesForPDF(person);
                // 准备数据变量
                const age = person.birthday ? calculateAge(person.birthday) : '未知';
                const tags = person.tags && person.tags.length > 0 ? person.tags.map(tag => `<span style="display:inline-block;background:#E3F2FD;color:#1976D2;padding:6px 14px;border-radius:15px;margin:4px;font-size:13px;">${tag}</span>`).join('') : '<span style="color:#999;">暂无标签</span>';
                const professionDisplay = person.profession || '未填写';
                let intimacyHearts = '';
                const intimacyValue = parseFloat(person.intimacy) || 0;
                for (let i = 0; i < 5; i++) {
                    intimacyHearts += i < intimacyValue ? '<span style="color:#FF6B6B;font-size:20px;">♥</span>' : '<span style="color:#DDD;font-size:20px;">♡</span>';
                }
                let avatarHTML = '';
                if (person.photo && person.photo.startsWith('data:')) {
                    avatarHTML = `<img src="${person.photo}" style="width:120px;height:120px;border-radius:50%;border:4px solid #667EEA;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:block;" crossorigin="anonymous" />`;
                } else {
                    avatarHTML = `<div style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:48px;color:white;font-weight:bold;border:4px solid #667EEA;box-shadow:0 4px 12px rgba(0,0,0,0.15);">${person.name.charAt(0)}</div>`;
                }
                
                // 生成故事HTML
                const stories = person.stories || [];
                let storiesHTML = '';
                if (stories.length > 0) {
                    storiesHTML = stories.slice(0, 10).map(story => {
                        let mediaHTML = '';
                        if (story.media && story.media.length > 0) {
                            const images = story.media.filter(m => m.type === 'image').slice(0, 9);
                            if (images.length > 0) {
                                mediaHTML = `<div class="image-grid" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:15px;">
                                    ${images.map(img => {
                                        if (img.data && img.data.startsWith('data:')) {
                                            return `<div style="width:100%;padding-bottom:75%;position:relative;border-radius:8px;background-color:#f5f5f5;overflow:hidden;"><img src="${img.data}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;" crossorigin="anonymous" /></div>`;
                                        } else {
                                            return `<div style="width:100%;padding-bottom:75%;position:relative;border-radius:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;text-align:center;">图片不可用</div>`;
                                        }
                                    }).join('')}
                                    </div>`;
                            }
                        }
                        return `<div class="story-card" style="background:#F9F9F9;padding:20px;border-radius:12px;margin-bottom:25px;border-left:4px solid #667EEA;page-break-inside:avoid;break-inside:avoid;orphans:3;widows:3;min-height:400px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <div style="font-weight:bold;color:#333;font-size:16px;">${story.title}</div>
                                <div style="color:#999;font-size:13px;">${story.date}</div>
                            </div>
                            <div style="color:#555;line-height:1.8;font-size:14px;">${story.content}</div>
                            ${mediaHTML}
                        </div>`;
                    }).join('');
                    if (stories.length > 10) {
                        storiesHTML += `<div style="text-align:center;color:#999;padding:15px;page-break-inside:avoid;">还有 ${stories.length - 10} 个故事未显示...</div>`;
                    }
                } else {
                    storiesHTML = '<div style="text-align:center;color:#999;padding:40px;">暂无故事记录</div>';
                }
                
                // 生成朋友圈HTML
                const moments = person.moments || [];
                let momentsHTML = '';
                if (moments.length > 0) {
                    momentsHTML = `<div style="margin-top:30px;page-break-before:auto;page-break-inside:avoid;break-inside:avoid;"><h3 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;page-break-before:avoid;page-break-after:avoid;orphans:3;widows:3;white-space:nowrap;">TA的朋友圈</h3>`;
                    momentsHTML += moments.slice(0, 5).map(moment => {
                        let mediaHTML = '';
                        if (moment.media && moment.media.length > 0) {
                            const images = moment.media.filter(m => m.type === 'image').slice(0, 9);
                            if (images.length > 0) {
                                mediaHTML = `<div class="image-grid" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:12px;">
                                    ${images.map(img => {
                                        if (img.data && img.data.startsWith('data:')) {
                                            return `<div style="width:100%;padding-bottom:75%;position:relative;border-radius:6px;background-color:#f5f5f5;overflow:hidden;"><img src="${img.data}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;" crossorigin="anonymous" /></div>`;
                                        } else {
                                            return `<div style="width:100%;padding-bottom:75%;position:relative;border-radius:6px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;text-align:center;">图片不可用</div>`;
                                        }
                                    }).join('')}
                                </div>`;
                            }
                        }
                        return `<div class="moment-card" style="background:#F9F9F9;padding:18px;border-radius:10px;margin-bottom:20px;page-break-inside:avoid;break-inside:avoid;orphans:3;widows:3;min-height:350px;">
                            <div style="color:#999;font-size:12px;margin-bottom:8px;">${moment.date}</div>
                            <div style="color:#555;line-height:1.7;font-size:14px;page-break-inside:avoid;">${moment.content}</div>
                            ${mediaHTML}
                        </div>`;
                    }).join('');
                    momentsHTML += '</div>';
                }
                
                const learnPoints = person.learnPoints ? `<div style="color:#555;line-height:1.8;white-space:pre-wrap;">${person.learnPoints}</div>` : '<div style="color:#999;text-align:center;padding:20px;">暂无内容</div>';
                
                // 创建两个独立的容器来确保分页
                const firstContainer = document.createElement('div');
                firstContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;';
                firstContainer.className = 'pdf-container';
                
                const secondContainer = document.createElement('div');
                secondContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;';
                secondContainer.className = 'pdf-container';
                
                // 添加样式到两个容器
                const style = document.createElement('style');
                style.textContent = `
                    .pdf-container {
                        background: white !important;
                        color: #000 !important;
                        font-family: Arial, "Microsoft YaHei", sans-serif !important;
                    }
                    .pdf-container * {
                        color: inherit !important;
                        box-sizing: border-box !important;
                    }
                    .pdf-container img {
                        object-fit: cover !important;
                        object-position: center !important;
                        image-rendering: high-quality !important;
                        -webkit-image-rendering: high-quality !important;
                        -moz-image-rendering: high-quality !important;
                        -ms-image-rendering: high-quality !important;
                        max-width: 100% !important;
                        height: auto !important;
                        display: block !important;
                    }
                    .pdf-container h1, .pdf-container h2, .pdf-container h3 {
                        color: #333 !important;
                        page-break-after: avoid !important;
                        orphans: 3 !important;
                        widows: 3 !important;
                    }
                    .pdf-container .story-card, .pdf-container .moment-card {
                        page-break-inside: avoid !important;
                        break-inside: avoid !important;
                        page-break-before: auto !important;
                        page-break-after: avoid !important;
                        margin-bottom: 25px !important;
                        min-height: 200px !important;
                        display: block !important;
                        position: relative !important;
                    }
                    .pdf-container .image-grid {
                        page-break-inside: avoid !important;
                        break-inside: avoid !important;
                    }
                    .pdf-container .image-container {
                        page-break-inside: avoid !important;
                        break-inside: avoid !important;
                        width: 100% !important;
                        padding-bottom: 75% !important;
                        position: relative !important;
                        background-color: #f5f5f5 !important;
                        border-radius: 8px !important;
                        overflow: hidden !important;
                    }
                    .pdf-container .image-container img {
                        position: absolute !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        object-fit: cover !important;
                        object-position: center !important;
                    }
                `;
                firstContainer.appendChild(style.cloneNode(true));
                secondContainer.appendChild(style.cloneNode(true));
                
                // 创建多个独立的容器，每个故事和朋友圈都有独立的分页
                const containers = [];
                
                // 第一部分：基本信息
                const firstPart = `<div style="height:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:-60px -60px 40px -60px;"></div><div style="text-align:center;margin-bottom:40px;"><h1 style="font-size:32px;color:#333;margin:0 0 10px 0;font-weight:bold;">人物档案</h1><div style="width:60px;height:3px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto;"></div></div><div style="display:flex;gap:40px;margin-bottom:40px;"><div style="flex-shrink:0;">${avatarHTML}</div><div style="flex:1;"><h2 style="font-size:28px;color:#333;margin:0 0 15px 0;">${person.name}</h2><div style="color:#666;font-size:16px;margin-bottom:10px;">${professionDisplay}</div><div style="margin:15px 0;">${tags}</div><div style="margin-top:15px;"><span style="color:#666;margin-right:10px;">亲密度:</span>${intimacyHearts}</div></div></div><div style="background:#F5F7FA;padding:30px;border-radius:15px;margin-bottom:30px;page-break-inside:avoid;"><h3 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">基本信息</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;"><div><div style="color:#999;font-size:13px;margin-bottom:5px;">生日</div><div style="color:#333;font-size:15px;font-weight:500;">${person.birthday || '未填写'} (${age})</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">所在地区</div><div style="color:#333;font-size:15px;font-weight:500;">${person.location || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">老家</div><div style="color:#333;font-size:15px;font-weight:500;">${person.hometown || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">MBTI</div><div style="color:#333;font-size:15px;font-weight:500;">${person.mbti || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">兴趣爱好</div><div style="color:#333;font-size:15px;font-weight:500;">${person.hobbies || '未填写'}</div></div></div></div><div style="background:#FFF9F0;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #FF9800;page-break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">性格特点</h3><div style="color:#555;line-height:1.8;">${person.personality || '未填写'}</div></div><div style="background:#F0F9FF;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #2196F3;page-break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">相识经历</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;"><div><span style="color:#999;font-size:13px;">相识时间:</span><span style="color:#333;font-size:14px;">${person.meetTime || '未填写'}</span></div><div><span style="color:#999;font-size:13px;">相识地点:</span><span style="color:#333;font-size:14px;">${person.meetPlace || '未填写'}</span></div><div style="grid-column:1/-1;"><span style="color:#999;font-size:13px;">相识缘由:</span><span style="color:#333;font-size:14px;">${person.meetReason || '未填写'}</span></div></div></div>`;
                
                // 创建基本信息容器
                const basicInfoContainer = document.createElement('div');
                basicInfoContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;min-height:1123px;';
                basicInfoContainer.className = 'pdf-container';
                basicInfoContainer.innerHTML = firstPart;
                containers.push(basicInfoContainer);
                
                // 值得学习的地方（独立分页）
                const learnPointsContainer = document.createElement('div');
                learnPointsContainer.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;min-height:1123px;';
                learnPointsContainer.className = 'pdf-container';
                learnPointsContainer.innerHTML = `<div style="background:#F3E5F5;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #9C27B0;page-break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">值得学习的地方</h3>${learnPoints}</div>`;
                containers.push(learnPointsContainer);
                
                // 我和TA的故事部分 - 智能分页
                if (stories.length > 0) {
                    // 创建故事章节的智能分页容器
                    const storiesContainers = createSmartPaginationContainers(
                        stories, 
                        '我和TA的故事', 
                        (story) => {
                            let mediaHTML = '';
                            if (story.media && story.media.length > 0) {
                                const images = story.media.filter(m => m.type === 'image').slice(0, 9);
                                if (images.length > 0) {
                                    mediaHTML = `<div class="image-grid" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:15px;">
                                        ${images.map(img => {
                                            if (img.data && img.data.startsWith('data:')) {
                                                return `<div style="width:100%;aspect-ratio:4/3;position:relative;border-radius:8px;background-color:#f5f5f5;overflow:hidden;"><img src="${img.data}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;" crossorigin="anonymous" /></div>`;
                                            } else {
                                                return `<div style="width:100%;aspect-ratio:4/3;position:relative;border-radius:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;text-align:center;">图片不可用</div>`;
                                            }
                                        }).join('')}
                                        </div>`;
                                }
                            }
                            
                            return `<div class="story-card" style="background:#F9F9F9;padding:20px;border-radius:12px;margin-bottom:25px;border-left:4px solid #667EEA;page-break-inside:avoid;break-inside:avoid;orphans:3;widows:3;min-height:200px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <div style="font-weight:bold;color:#333;font-size:16px;">${story.title}</div>
                                    <div style="color:#999;font-size:13px;">${story.date}</div>
                                </div>
                                <div style="color:#555;line-height:1.8;font-size:14px;">${story.content}</div>
                                ${mediaHTML}
                            </div>`;
                        }
                    );
                    containers.push(...storiesContainers);
                }
                
                // TA的朋友圈部分 - 智能分页
                if (moments.length > 0) {
                    // 创建朋友圈章节的智能分页容器
                    const momentsContainers = createSmartPaginationContainers(
                        moments, 
                        'TA的朋友圈', 
                        (moment) => {
                            let mediaHTML = '';
                            if (moment.media && moment.media.length > 0) {
                                const images = moment.media.filter(m => m.type === 'image').slice(0, 9);
                                if (images.length > 0) {
                                    mediaHTML = `<div class="image-grid" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:12px;">
                                        ${images.map(img => {
                                            if (img.data && img.data.startsWith('data:')) {
                                                return `<div style="width:100%;aspect-ratio:4/3;position:relative;border-radius:6px;background-color:#f5f5f5;overflow:hidden;"><img src="${img.data}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;" crossorigin="anonymous" /></div>`;
                                            } else {
                                                return `<div style="width:100%;aspect-ratio:4/3;position:relative;border-radius:6px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;text-align:center;">图片不可用</div>`;
                                            }
                                        }).join('')}
                                    </div>`;
                                }
                            }
                            
                            return `<div class="moment-card" style="background:#F9F9F9;padding:18px;border-radius:10px;margin-bottom:20px;page-break-inside:avoid;break-inside:avoid;orphans:3;widows:3;min-height:200px;">
                                <div style="color:#999;font-size:12px;margin-bottom:8px;">${moment.date}</div>
                                <div style="color:#555;line-height:1.7;font-size:14px;page-break-inside:avoid;">${moment.content}</div>
                                ${mediaHTML}
                            </div>`;
                        }
                    );
                    containers.push(...momentsContainers);
                }
                
                // 将所有容器添加到页面
                containers.forEach(container => {
                    container.appendChild(style.cloneNode(true));
                document.body.appendChild(container);
                });
                
                // 等待图片加载完成
                await waitForImagesToLoad(containers);
                
                // 简化分页逻辑：直接使用原始容器
                let smartContainers = [...containers];
                
                // 渲染所有容器
                const canvases = [];
                for (let i = 0; i < smartContainers.length; i++) {
                    const container = smartContainers[i];
                    console.log(`正在渲染第 ${i + 1} 个容器，高度: ${container.scrollHeight}px`);
                    
                    try {
                        const canvas = await html2canvas(container, {
                        scale: 1.5,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        logging: false,
                        imageTimeout: 10000,
                        removeContainer: false,
                        foreignObjectRendering: false,
                        width: 794,
                        height: Math.max(container.scrollHeight, 1123), // 确保最小高度
                        windowWidth: 794,
                        windowHeight: Math.max(container.scrollHeight, 1123),
                        onclone: (clonedDoc) => {
                            // 设置文档背景
                            clonedDoc.body.style.background = 'white';
                            clonedDoc.body.style.margin = '0';
                            clonedDoc.body.style.padding = '0';
                            
                            // 处理所有PDF容器
                            const containers = clonedDoc.querySelectorAll('.pdf-container');
                            containers.forEach(container => {
                                container.style.background = 'white !important';
                                container.style.color = '#000 !important';
                                container.style.position = 'static !important';
                                container.style.left = 'auto !important';
                                container.style.top = 'auto !important';
                                container.style.width = '794px !important';
                                container.style.minHeight = '1123px !important';
                                container.style.display = 'block !important';
                                container.style.visibility = 'visible !important';
                                container.style.opacity = '1 !important';
                            });
                            
                            // 处理所有元素
                            const allElements = clonedDoc.querySelectorAll('*');
                            allElements.forEach(el => {
                                // 确保元素可见
                                el.style.visibility = 'visible';
                                el.style.display = el.style.display === 'none' ? 'block' : el.style.display;
                                
                                // 设置文字颜色
                                if (!el.style.color || el.style.color === 'transparent' || el.style.color === '') {
                                    el.style.color = '#000';
                                }
                                
                                // 设置背景
                                if (!el.style.backgroundColor || el.style.backgroundColor === 'transparent') {
                                    el.style.backgroundColor = 'transparent';
                                }
                                
                                // 移除可能影响渲染的样式
                                el.style.transform = '';
                                el.style.filter = '';
                                el.style.boxShadow = '';
                            });
                            
                            // 特殊处理图片
                            const images = clonedDoc.querySelectorAll('img');
                            images.forEach(img => {
                                img.style.display = 'block';
                                img.style.visibility = 'visible';
                                img.style.opacity = '1';
                                
                                // 如果图片没有src或src无效，隐藏图片容器
                                if (!img.src || img.src === '' || !img.src.startsWith('data:')) {
                                    const container = img.parentElement;
                                    if (container) {
                                        container.style.display = 'none';
                                    }
                                }
                            });
                            
                            // 处理图片网格
                            const imageGrids = clonedDoc.querySelectorAll('.image-grid');
                            imageGrids.forEach(grid => {
                                grid.style.display = 'grid';
                                grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                                grid.style.gap = '8px';
                                grid.style.marginTop = '12px';
                            });
                        }
                        });
                        console.log(`第 ${i + 1} 个容器渲染成功，Canvas尺寸: ${canvas.width}x${canvas.height}`);
                        canvases.push(canvas);
                    } catch (error) {
                        console.error(`第 ${i + 1} 个容器渲染失败:`, error);
                        // 创建一个空白canvas作为占位符
                        const blankCanvas = document.createElement('canvas');
                        blankCanvas.width = 794;
                        blankCanvas.height = 1123;
                        const ctx = blankCanvas.getContext('2d');
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, 794, 1123);
                        ctx.fillStyle = '#666666';
                        ctx.font = '24px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('渲染失败', 397, 561);
                        canvases.push(blankCanvas);
                    }
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true,
                    putOnlyUsedFonts: true,
                    floatPrecision: 16
                });
                
                const pageWidth = 210;
                const pageHeight = 297;
                const imgWidth = pageWidth;
                
                // 为每个容器添加页面
                for (let i = 0; i < canvases.length; i++) {
                    const canvas = canvases[i];
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight, undefined, 'FAST');
                    
                    // 处理分页
                    let heightLeft = imgHeight - pageHeight;
                    while (heightLeft > 0) {
                        pdf.addPage();
                        const position = heightLeft - imgHeight;
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                        heightLeft -= pageHeight;
                    }
                }
                
                const fileName = `${person.name}_人物档案_${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}.pdf`;
                pdf.save(fileName);
                
                // 清理容器
                const allContainers = [...containers];
                if (smartContainers && smartContainers.length > 0) {
                    allContainers.push(...smartContainers);
                }
                allContainers.forEach(container => {
                    if (document.body.contains(container)) {
                        document.body.removeChild(container);
                    }
                });
                if (document.body.contains(loadingDiv)) {
                document.body.removeChild(loadingDiv);
                }
                alert('PDF导出成功！\n\n文件名：' + fileName);
            } catch (error) {
                // 清理所有可能的容器
                try {
                    if (document.body.contains(loadingDiv)) {
                        document.body.removeChild(loadingDiv);
                    }
                    const allContainers = [...containers];
                    if (typeof smartContainers !== 'undefined' && smartContainers && smartContainers.length > 0) {
                        allContainers.push(...smartContainers);
                    }
                    allContainers.forEach(container => {
                        if (document.body.contains(container)) {
                            document.body.removeChild(container);
                        }
                    });
                } catch (cleanupError) {
                    console.warn('清理容器时出错:', cleanupError);
                }
                const errorMessage = error.message || error.toString() || '未知错误';
                alert('PDF生成失败：' + errorMessage);
                console.error('PDF生成详细错误:', error);
            }
        }
        
        // 简化版PDF导出函数
        async function generateSimplifiedPDF(person) {
            try {
                console.log('开始生成简化版PDF...');
                
                // 创建单个容器
                const container = document.createElement('div');
                container.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;min-height:1123px;';
                container.className = 'pdf-container';
                
                // 预处理图片数据
                await preprocessImagesForPDF(person);
                
                // 生成简单的HTML内容
                const age = person.birthday ? calculateAge(person.birthday) : '未知';
                const tags = person.tags && person.tags.length > 0 ? person.tags.map(tag => `<span style="display:inline-block;background:#E3F2FD;color:#1976D2;padding:6px 14px;border-radius:15px;margin:4px;font-size:13px;">${tag}</span>`).join('') : '<span style="color:#999;">暂无标签</span>';
                const professionDisplay = person.profession || '未填写';
                
                let intimacyHearts = '';
                const intimacyValue = parseFloat(person.intimacy) || 0;
                for (let i = 0; i < 5; i++) {
                    intimacyHearts += i < intimacyValue ? '<span style="color:#FF6B6B;font-size:20px;">♥</span>' : '<span style="color:#DDD;font-size:20px;">♡</span>';
                }
                
                let avatarHTML = '';
                if (person.photo && person.photo.startsWith('data:')) {
                    avatarHTML = `<img src="${person.photo}" style="width:120px;height:120px;border-radius:50%;border:4px solid #667EEA;display:block;" />`;
                } else {
                    avatarHTML = `<div style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:48px;color:white;font-weight:bold;">${person.name.charAt(0)}</div>`;
                }
                
                // 生成简化内容
                const content = `
                    <div style="text-align:center;margin-bottom:40px;">
                        <h1 style="font-size:32px;color:#333;margin:0 0 10px 0;">人物档案</h1>
                    </div>
                    <div style="display:flex;gap:40px;margin-bottom:40px;">
                        <div style="flex-shrink:0;">${avatarHTML}</div>
                        <div style="flex:1;">
                            <h2 style="font-size:28px;color:#333;margin:0 0 15px 0;">${person.name}</h2>
                            <div style="color:#666;font-size:16px;margin-bottom:10px;">${professionDisplay}</div>
                            <div style="margin:15px 0;">${tags}</div>
                            <div style="margin-top:15px;">亲密度: ${intimacyHearts}</div>
                        </div>
                    </div>
                    <div style="background:#F5F7FA;padding:30px;border-radius:15px;margin-bottom:30px;">
                        <h3 style="font-size:20px;color:#333;margin:0 0 20px 0;">基本信息</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                            <div><strong>生日:</strong> ${person.birthday || '未填写'} (${age})</div>
                            <div><strong>地区:</strong> ${person.location || '未填写'}</div>
                            <div><strong>老家:</strong> ${person.hometown || '未填写'}</div>
                            <div><strong>MBTI:</strong> ${person.mbti || '未填写'}</div>
                        </div>
                    </div>
                    <div style="background:#FFF9F0;padding:25px;border-radius:15px;margin-bottom:30px;">
                        <h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">性格特点</h3>
                        <div style="color:#555;line-height:1.8;">${person.personality || '未填写'}</div>
                    </div>
                    <div style="background:#F0F9FF;padding:25px;border-radius:15px;margin-bottom:30px;">
                        <h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">相识经历</h3>
                        <div><strong>相识时间:</strong> ${person.meetTime || '未填写'}</div>
                        <div><strong>相识地点:</strong> ${person.meetPlace || '未填写'}</div>
                        <div><strong>相识缘由:</strong> ${person.meetReason || '未填写'}</div>
                    </div>
                `;
                
                container.innerHTML = content;
                document.body.appendChild(container);
                
                // 等待一下确保渲染完成
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 使用更简单的html2canvas配置
                const canvas = await html2canvas(container, {
                    scale: 1,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: false,
                    width: 794,
                    height: 1123
                });
                
                // 生成PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = 210;
                const pageHeight = 297;
                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                
                const fileName = `${person.name}_人物档案_${new Date().toISOString().slice(0, 10)}.pdf`;
                pdf.save(fileName);
                
                // 清理
                document.body.removeChild(container);
                
                console.log('简化版PDF生成成功');
                alert('简化版PDF导出成功！\n\n文件名：' + fileName);
                
            } catch (error) {
                console.error('简化版PDF生成失败:', error);
                alert('PDF导出失败：' + error.message);
            }
        }

        function createPDFContainer(person) {
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;width:794px;background:white;padding:60px;font-family:Arial,"Microsoft YaHei",sans-serif;color:#000;';
            container.className = 'pdf-container';
            
            // 添加全局样式确保图片不变形和PDF导出正确
            const style = document.createElement('style');
            style.textContent = `
                .pdf-container {
                    background: white !important;
                    color: #000 !important;
                }
                .pdf-container * {
                    color: inherit !important;
                }
                .pdf-container img {
                    object-fit: cover !important;
                    object-position: center !important;
                    image-rendering: high-quality !important;
                    -webkit-image-rendering: high-quality !important;
                    -moz-image-rendering: high-quality !important;
                    -ms-image-rendering: high-quality !important;
                    max-width: 100% !important;
                    height: auto !important;
                }
                .pdf-container h1, .pdf-container h2, .pdf-container h3 {
                    color: #333 !important;
                }
                .pdf-container .page-break {
                    page-break-before: always !important;
                }
            `;
            container.appendChild(style);
            const age = person.birthday ? calculateAge(person.birthday) : '未知';
            const tags = person.tags && person.tags.length > 0 ? person.tags.map(tag => `<span style="display:inline-block;background:#E3F2FD;color:#1976D2;padding:6px 14px;border-radius:15px;margin:4px;font-size:13px;">${tag}</span>`).join('') : '<span style="color:#999;">暂无标签</span>';
            const professionDisplay = person.profession || '未填写';
            let intimacyHearts = '';
            const intimacyValue = parseFloat(person.intimacy) || 0;
            for (let i = 0; i < 5; i++) {
                intimacyHearts += i < intimacyValue ? '<span style="color:#FF6B6B;font-size:20px;">♥</span>' : '<span style="color:#DDD;font-size:20px;">♡</span>';
            }
            let avatarHTML = '';
            if (person.photo) {
                avatarHTML = `<img src="${person.photo}" style="width:120px;height:120px;border-radius:50%;border:4px solid #667EEA;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:block;" crossorigin="anonymous" />`;
            } else {
                avatarHTML = `<div style="width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:48px;color:white;font-weight:bold;border:4px solid #667EEA;box-shadow:0 4px 12px rgba(0,0,0,0.15);">${person.name.charAt(0)}</div>`;
            }
            
            const stories = person.stories || [];
            let storiesHTML = '';
            if (stories.length > 0) {
                storiesHTML = stories.slice(0, 10).map(story => {
                    let mediaHTML = '';
                    if (story.media && story.media.length > 0) {
                        const images = story.media.filter(m => m.type === 'image').slice(0, 4);
                        if (images.length > 0) {
                            mediaHTML = `<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:15px;">
                                ${images.slice(0, 6).map(img => `<img src="${img.data}" style="width:100%;height:100px;border-radius:8px;display:block;object-fit:cover;object-position:center;" crossorigin="anonymous" />`).join('')}
                                </div>`;
                        }
                    }
                    return `<div style="background:#F9F9F9;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #667EEA;page-break-inside:avoid;break-inside:avoid;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <div style="font-weight:bold;color:#333;font-size:16px;">${story.title}</div>
                            <div style="color:#999;font-size:13px;">${story.date}</div>
                        </div>
                        <div style="color:#555;line-height:1.8;font-size:14px;">${story.content}</div>
                        ${mediaHTML}
                    </div>`;
                }).join('');
                if (stories.length > 10) {
                    storiesHTML += `<div style="text-align:center;color:#999;padding:15px;">还有 ${stories.length - 10} 个故事未显示...</div>`;
                }
            } else {
                storiesHTML = '<div style="text-align:center;color:#999;padding:40px;">暂无故事记录</div>';
            }
            
            const moments = person.moments || [];
            let momentsHTML = '';
            if (moments.length > 0) {
                momentsHTML = `<div style="margin-top:30px;"><h3 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">TA的朋友圈</h3>`;
                momentsHTML += moments.slice(0, 5).map(moment => {
                    let mediaHTML = '';
                    if (moment.media && moment.media.length > 0) {
                        const images = moment.media.filter(m => m.type === 'image').slice(0, 3);
                        if (images.length > 0) {
                            mediaHTML = `<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:12px;">
                                ${images.slice(0, 6).map(img => `<img src="${img.data}" style="width:100%;height:80px;border-radius:6px;display:block;object-fit:cover;object-position:center;" crossorigin="anonymous" />`).join('')}
                            </div>`;
                        }
                    }
                    return `<div style="background:#F9F9F9;padding:18px;border-radius:10px;margin-bottom:12px;page-break-inside:avoid;break-inside:avoid;">
                        <div style="color:#999;font-size:12px;margin-bottom:8px;">${moment.date}</div>
                        <div style="color:#555;line-height:1.7;font-size:14px;">${moment.content}</div>
                        ${mediaHTML}
                    </div>`;
                }).join('');
                momentsHTML += '</div>';
            }
            
            const learnPoints = person.learnPoints ? `<div style="color:#555;line-height:1.8;white-space:pre-wrap;">${person.learnPoints}</div>` : '<div style="color:#999;text-align:center;padding:20px;">暂无内容</div>';
            
            // 将内容分为两部分：第一部分到相识经历，第二部分从值得学习的地方开始
            const firstPart = `<div style="height:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:-60px -60px 40px -60px;"></div><div style="text-align:center;margin-bottom:40px;"><h1 style="font-size:32px;color:#333;margin:0 0 10px 0;font-weight:bold;">人物档案</h1><div style="width:60px;height:3px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto;"></div></div><div style="display:flex;gap:40px;margin-bottom:40px;"><div style="flex-shrink:0;">${avatarHTML}</div><div style="flex:1;"><h2 style="font-size:28px;color:#333;margin:0 0 15px 0;">${person.name}</h2><div style="color:#666;font-size:16px;margin-bottom:10px;">${professionDisplay}</div><div style="margin:15px 0;">${tags}</div><div style="margin-top:15px;"><span style="color:#666;margin-right:10px;">亲密度:</span>${intimacyHearts}</div></div></div><div style="background:#F5F7FA;padding:30px;border-radius:15px;margin-bottom:30px;page-break-inside:avoid;"><h3 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">基本信息</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;"><div><div style="color:#999;font-size:13px;margin-bottom:5px;">生日</div><div style="color:#333;font-size:15px;font-weight:500;">${person.birthday || '未填写'} (${age})</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">所在地区</div><div style="color:#333;font-size:15px;font-weight:500;">${person.location || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">老家</div><div style="color:#333;font-size:15px;font-weight:500;">${person.hometown || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">MBTI</div><div style="color:#333;font-size:15px;font-weight:500;">${person.mbti || '未填写'}</div></div><div><div style="color:#999;font-size:13px;margin-bottom:5px;">兴趣爱好</div><div style="color:#333;font-size:15px;font-weight:500;">${person.hobbies || '未填写'}</div></div></div></div><div style="background:#FFF9F0;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #FF9800;page-break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">性格特点</h3><div style="color:#555;line-height:1.8;">${person.personality || '未填写'}</div></div><div style="background:#F0F9FF;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #2196F3;page-break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">相识经历</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;"><div><span style="color:#999;font-size:13px;">相识时间:</span><span style="color:#333;font-size:14px;">${person.meetTime || '未填写'}</span></div><div><span style="color:#999;font-size:13px;">相识地点:</span><span style="color:#333;font-size:14px;">${person.meetPlace || '未填写'}</span></div><div style="grid-column:1/-1;"><span style="color:#999;font-size:13px;">相识缘由:</span><span style="color:#333;font-size:14px;">${person.meetReason || '未填写'}</span></div></div></div>`;
            
            const secondPart = `<div style="background:#F3E5F5;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #9C27B0;page-break-before:always;page-break-inside:avoid;break-before:page;break-inside:avoid;"><h3 style="font-size:18px;color:#333;margin:0 0 15px 0;">值得学习的地方</h3>${learnPoints}</div><div style="margin-top:30px;"><h3 style="font-size:20px;color:#333;margin:0 0 20px 0;border-bottom:2px solid #667EEA;padding-bottom:10px;">我们的故事</h3>${storiesHTML}</div>${momentsHTML}<div style="margin-top:40px;text-align:center;color:#999;font-size:12px;padding-top:20px;border-top:1px solid #E0E0E0;">导出时间:${new Date().toLocaleString('zh-CN')}</div>`;
            
            container.innerHTML = firstPart + secondPart;
            return container;
        }
    </script>
</body>
</html>

